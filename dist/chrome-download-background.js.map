{"version":3,"sources":["chrome-download-background.ts"],"names":[],"mappings":";AAwBA,aAAA,IAAA,EAAA,MAAA,KAAA,WAAA,SAAA,EAAA,EAAA,EAAA,GAAA,OAAA,IAAA,IAAA,EAAA,UAAA,SAAA,EAAA,GAAA,SAAA,EAAA,GAAA,IAAA,EAAA,EAAA,KAAA,IAAA,MAAA,GAAA,EAAA,IAAA,SAAA,EAAA,GAAA,IAAA,EAAA,EAAA,MAAA,IAAA,MAAA,GAAA,EAAA,IAAA,SAAA,EAAA,GAAA,IAAA,EAAA,EAAA,KAAA,EAAA,EAAA,QAAA,EAAA,EAAA,MAAA,aAAA,EAAA,EAAA,IAAA,EAAA,SAAA,GAAA,EAAA,MAAA,KAAA,EAAA,GAAA,GAAA,EAAA,EAAA,MAAA,EAAA,GAAA,KAAA,WAAA,EAAA,MAAA,KAAA,aAAA,SAAA,EAAA,GAAA,IAAA,EAAA,EAAA,EAAA,EAAA,EAAA,CAAA,MAAA,EAAA,KAAA,WAAA,GAAA,EAAA,EAAA,GAAA,MAAA,EAAA,GAAA,OAAA,EAAA,IAAA,KAAA,GAAA,IAAA,IAAA,OAAA,EAAA,CAAA,KAAA,EAAA,GAAA,MAAA,EAAA,GAAA,OAAA,EAAA,IAAA,mBAAA,SAAA,EAAA,OAAA,UAAA,WAAA,OAAA,OAAA,EAAA,SAAA,EAAA,GAAA,OAAA,SAAA,GAAA,OAAA,SAAA,GAAA,GAAA,EAAA,MAAA,IAAA,UAAA,mCAAA,KAAA,GAAA,IAAA,GAAA,EAAA,EAAA,IAAA,EAAA,EAAA,EAAA,GAAA,EAAA,OAAA,EAAA,GAAA,EAAA,SAAA,EAAA,EAAA,SAAA,EAAA,KAAA,GAAA,GAAA,EAAA,SAAA,EAAA,EAAA,KAAA,EAAA,EAAA,KAAA,KAAA,OAAA,EAAA,OAAA,EAAA,EAAA,IAAA,EAAA,CAAA,EAAA,EAAA,GAAA,EAAA,QAAA,EAAA,IAAA,KAAA,EAAA,KAAA,EAAA,EAAA,EAAA,MAAA,KAAA,EAAA,OAAA,EAAA,QAAA,CAAA,MAAA,EAAA,GAAA,MAAA,GAAA,KAAA,EAAA,EAAA,QAAA,EAAA,EAAA,GAAA,EAAA,CAAA,GAAA,SAAA,KAAA,EAAA,EAAA,EAAA,IAAA,MAAA,EAAA,KAAA,MAAA,SAAA,QAAA,KAAA,GAAA,EAAA,EAAA,MAAA,OAAA,GAAA,EAAA,EAAA,OAAA,MAAA,IAAA,EAAA,IAAA,IAAA,EAAA,IAAA,CAAA,EAAA,EAAA,SAAA,GAAA,IAAA,EAAA,MAAA,GAAA,EAAA,GAAA,EAAA,IAAA,EAAA,GAAA,EAAA,IAAA,CAAA,EAAA,MAAA,EAAA,GAAA,MAAA,GAAA,IAAA,EAAA,IAAA,EAAA,MAAA,EAAA,GAAA,CAAA,EAAA,MAAA,EAAA,GAAA,EAAA,EAAA,MAAA,GAAA,GAAA,EAAA,MAAA,EAAA,GAAA,CAAA,EAAA,MAAA,EAAA,GAAA,EAAA,IAAA,KAAA,GAAA,MAAA,EAAA,IAAA,EAAA,IAAA,MAAA,EAAA,KAAA,MAAA,SAAA,EAAA,EAAA,KAAA,EAAA,GAAA,MAAA,GAAA,EAAA,CAAA,EAAA,GAAA,EAAA,EAAA,QAAA,EAAA,EAAA,EAAA,GAAA,EAAA,EAAA,GAAA,MAAA,EAAA,GAAA,MAAA,CAAA,MAAA,EAAA,GAAA,EAAA,QAAA,EAAA,MAAA,GAAA,CAAA,CAAA,EAAA,OAAA,OAAA,eAAA,QAAA,aAAA,CAAA,OAAA,IAjBA,IAAM,EAAwB,SAAC,GACvB,OAAA,IAAI,QAAQ,SAAC,EAAS,GAC5B,OAAO,UAAU,SAChB,EACA,SAAC,QACmB,IAAf,EACH,EAAO,OAAO,QAAQ,UAAU,SAGhC,EAAQ,QAQb,OAAO,QAAQ,UAAU,YAAY,SAAU,GAAV,IAAA,EAAA,KAClB,sBAAd,EAAK,OACT,EAAK,aAAa,YAAY,WAAM,OAAA,QAAQ,IAAI,uBAChD,EAAK,UAAU,YAAY,SAAO,EAA6C,GAAM,OAAA,EAAA,OAAA,OAAA,EAAA,WAHtF,IAAA,EAAA,EAAA,OAAA,EAAA,KAAA,SAAA,GAAA,OAAA,EAAA,OAAA,KAAA,EAMM,GAFJ,QAAQ,IAAI,GAEK,qBAAb,EAAI,KAAJ,MAAA,CAAA,EAAA,GANN,EAAA,MAAA,EAAA,KAAA,EAQe,OARf,EAAA,KAAA,KAAA,CAAA,EAAA,EAAA,CAAA,IAQe,CAAA,EAAM,EAAsB,CACtC,IAAK,EAAI,IACT,SAAU,EAAI,SACd,eAAgB,eAXrB,KAAA,EAAA,OAQU,EAAK,EAAA,OAKX,EAAK,YAAY,CAChB,KAAM,cAAe,GAAE,IAd5B,CAAA,EAAA,GAAA,KAAA,EAAA,OAAA,EAAA,EAAA,OAkBI,EAAK,YAAY,CAChB,KAAM,QACN,MAAO,IApBZ,CAAA,EAAA,GAAA,KAAA,EAuBG,MAAA,CAAA,GAvBH,KAAA,EAAA,MA0BmB,kBAAb,EAAI,MACP,OAAO,UAAU,OAAO,CAAE,GAAI,EAAI,IAAM,SAAC,GACpC,GAAiB,IAAjB,EAAM,OAAN,CAQC,EAAM,OAAS,GAClB,QAAQ,KAAK,qEAER,IAAA,EAAO,EAAM,GACb,EAAQ,EAAK,MACL,gBAAV,EAOU,aAAV,EAMU,gBAAV,GACH,EAAK,YAAY,CAChB,KAAM,WACN,SAAU,CACT,cAAe,EAAK,cACpB,WAAY,EAAK,WACjB,SAAW,EAAK,cAAgB,EAAK,cAXvC,EAAK,YAAY,CAChB,KAAM,YARP,EAAK,YAAY,CAChB,KAAM,QACN,MAAO,EAAK,aAfd,EAAK,YAAY,CAChB,KAAM,QACN,MAAO,8EA/Bb,CAAA","file":"chrome-download-background.js","sourceRoot":"../app/src/disk-writing","sourcesContent":["import { DownloadRequest, DownloadProgressResponse, DownloadSuccessResponse, DownloadErrorResponse, DownloadProgressCallback, DownloadProgress, DownloadStateRequest, DownloadIdResponse } from \"./chrome-download-types\";\n\n\n// type InterruptReason = \"FILE_FAILED\" | \"FILE_ACCESS_DENIED\" | \"FILE_NO_SPACE\" | \"FILE_NAME_TOO_LONG\" | \"FILE_TOO_LARGE\" | \"FILE_VIRUS_INFECTED\" | \"FILE_TRANSIENT_ERROR\" | \"FILE_BLOCKED\" | \"FILE_SECURITY_CHECK_FAILED\" | \"FILE_TOO_SHORT\" | \"FILE_HASH_MISMATCH\" | \"FILE_SAME_AS_SOURCE\" | \"NETWORK_FAILED\" | \"NETWORK_TIMEOUT\" | \"NETWORK_DISCONNECTED\" | \"NETWORK_SERVER_DOWN\" | \"NETWORK_INVALID_REQUEST\" | \"SERVER_FAILED\" | \"SERVER_NO_RANGE\" | \"SERVER_BAD_CONTENT\" | \"SERVER_UNAUTHORIZED\" | \"SERVER_CERT_PROBLEM\" | \"SERVER_FORBIDDEN\" | \"SERVER_UNREACHABLE\" | \"SERVER_CONTENT_LENGTH_MISMATCH\" | \"SERVER_CROSS_ORIGIN_REDIRECT\" | \"USER_CANCELED\" | \"USER_SHUTDOWN\" | \"CRASH\";\ntype DownloadItem = chrome.downloads.DownloadItem;\ntype DownloadOptions = chrome.downloads.DownloadOptions;\n\nconst startDownloadAndGetId = (options: DownloadOptions): Promise<number> => {\n\treturn new Promise((resolve, reject) => {\n\t\tchrome.downloads.download(\n\t\t\toptions,\n\t\t\t(downloadId: number) => {\n\t\t\t\tif (downloadId === undefined) {\n\t\t\t\t\treject(chrome.runtime.lastError.message);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tresolve(downloadId);\n\t\t\t\t}\n\t\t\t}\n\t\t);\n\t});\n};\n\n\nchrome.runtime.onConnect.addListener(function (port) {\n\tif (port.name !== \"chrome-downloader\") return;\n\tport.onDisconnect.addListener(() => console.log(\"port disconnected\"));\n\tport.onMessage.addListener(async (msg: DownloadRequest | DownloadStateRequest, sender) => {\n\t\tconsole.log(msg);\n\t\t\n\t\tif (msg.type === \"request-download\"){\n\t\t\ttry {\n\t\t\t\tconst id = await startDownloadAndGetId({\n\t\t\t\t\turl: msg.url,\n\t\t\t\t\tfilename: msg.filePath,\n\t\t\t\t\tconflictAction: \"overwrite\"\n\t\t\t\t});\n\t\t\t\tport.postMessage({\n\t\t\t\t\ttype: \"download-id\", id\n\t\t\t\t} as DownloadIdResponse);\n\t\t\t}\n\t\t\tcatch (e){\n\t\t\t\tport.postMessage({\n\t\t\t\t\ttype: \"error\",\n\t\t\t\t\terror: e\n\t\t\t\t} as DownloadErrorResponse);\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\tif (msg.type === \"request-state\"){\n\t\t\tchrome.downloads.search({ id: msg.id }, (items: DownloadItem[]) => {\n\t\t\t\tif (items.length === 0) {\n\t\t\t\t\tport.postMessage({\n\t\t\t\t\t\ttype: \"error\",\n\t\t\t\t\t\terror: \"download started but file not found. this may be a problem with chrome.\"\n\t\t\t\t\t} as DownloadErrorResponse);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tif (items.length > 1) {\n\t\t\t\t\t\tconsole.warn(\"more than one file for this download found. this shoud not happen\");\n\t\t\t\t\t}\n\t\t\t\t\tconst item = items[0];\n\t\t\t\t\tconst state = item.state;\n\t\t\t\t\tif (state === \"interrupted\"){\n\t\t\t\t\t\tport.postMessage({\n\t\t\t\t\t\t\ttype: \"error\",\n\t\t\t\t\t\t\terror: item.error\n\t\t\t\t\t\t} as DownloadErrorResponse);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tif (state === \"complete\") {\n\t\t\t\t\t\tport.postMessage({\n\t\t\t\t\t\t\ttype: \"success\"\n\t\t\t\t\t\t} as DownloadSuccessResponse);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tif (state === \"in_progress\"){\n\t\t\t\t\t\tport.postMessage({\n\t\t\t\t\t\t\ttype: \"progress\",\n\t\t\t\t\t\t\tprogress: {\n\t\t\t\t\t\t\t\tbytesReceived: item.bytesReceived,\n\t\t\t\t\t\t\t\ttotalBytes: item.totalBytes,\n\t\t\t\t\t\t\t\tprogress: (item.bytesReceived / item.totalBytes)\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} as DownloadProgressResponse);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\t});\n});"]}