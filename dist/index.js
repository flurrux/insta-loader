!function(){const e="mainFeed",t="post",n="personFeed",o="stories",r=()=>{let r=window.location.href;return r.endsWith("instagram.com/")||r.includes(".com/?")?e:r.includes("/p/")?t:r.includes("/reel/")?"reel":r.includes("/stories/")?o:n},i=[];let s=window.location.href,a=r();const c=document.querySelector("#react-root");new MutationObserver((()=>{const e=window.location.href;if(e===s)return;const t=s,n=a;s=e,a=r();var o;o={oldHref:t,newHref:e,oldPageType:n,newPageType:a},i.forEach((e=>e(o)))})).observe(c,{childList:!0,subtree:!0});const d=()=>{const e=r();return"personFeed"===e?["preview"]:"stories"===e?["story"]:["post"]};function l(e){const t=e.split(" ");return{src:t[0],quality:parseInt(t[1])}}function u(e){const t=function(e){return e.split(",").map(l)}(e);let n=0;for(let e=1;e<t.length;e++){t[e].quality>t[n].quality&&(n=e)}return t[n].src}const h=e=>{let t=0,n=e[0].config_width;for(let o=1;o<e.length;o++){const r=e[o].config_width;r>n&&(t=o,n=r)}return e[t].src},m=e=>{const t=e.querySelector("video, img[srcset]");return t||(e=>Array.from(e.querySelectorAll("img")).find((e=>e.offsetHeight>400)))(e)},f=e=>new Promise(((t,n)=>{const o=new XMLHttpRequest;o.addEventListener("load",(function(){try{const e=(e=>{const t=/(?<=window\.__additionalDataLoaded\(.*',).*(?=\);<)/.exec(e);if(!t)throw"__additionalDataLoaded not found on window";const n=JSON.parse(t[0]);if(!n.graphql)throw"graphql not found";if(!n.graphql.shortcode_media)throw"shortcode_media not found";const o=n.graphql.shortcode_media,r=o.owner.username,[i,s]=void 0!==o.edge_sidecar_to_children?["collection",o.edge_sidecar_to_children.edges.map((e=>e.node))]:[void 0!==o.video_url?"video":"image",[o]],a=[];for(let e=0;e<s.length;e++){let t=s[e],n={previewSrc:t.display_url};if(void 0!==t.video_url)Object.assign(n,{type:"video",src:t.video_url});else{const e=t.display_resources,o=h(e);Object.assign(n,{type:"image",srcset:e,src:o})}a.push(n)}if(0===a.length)throw"no media found";return{postType:i,mediaArray:a,username:r}})(this.responseText);t(e)}catch(e){n(e)}})),o.addEventListener("error",n),o.addEventListener("abort",n),o.open("GET",e),o.send()}));function g(){return Array.from(document.querySelector("article").parentElement.children)}const p=e=>m(e),w=e=>{if(e.querySelector('[class*="Chevron"]'))return"collection";const t=p(e);return t||(console.warn("no media-element found"),console.log(e.innerHTML)),"VIDEO"===t.tagName?"video":"image"};function y(e){const t=e.children[1],n=parseFloat(getComputedStyle(t).getPropertyValue("width")),o=e.parentElement.parentElement.getBoundingClientRect().x;for(let t=1;t<e.children.length;t++){const r=e.children[t].getBoundingClientRect().x;if(Math.abs(o-r)<n/2)return t-1}return-1}function v(e,t){const n=function(e){const t=e.querySelector("ul"),n=y(t);return t.children[n+1]}(t),o=p(n);return o.matches("video")?function(e,t){const n=t.poster;if(""===n)return console.warn("cannot find the position for this collection-element!"),null;const o=/^https:\/\/.*\.jpg/.exec(n)[0],r=e.findIndex((e=>e.previewSrc.includes(o)));return r<0?(console.warn("poster does not match any previews, therefore cannot find the index for this item"),console.log(n,o,e),null):e[r]}(e,o):function(e,t){let n="";const o=t.srcset;return n=o?u(o):t.src,{type:"image",src:n,previewSrc:"",srcset:[]}}(0,o)}function b(){return g().reduce(((e,t)=>{const n=function(e){const t=e.getBoundingClientRect(),n=(t.top+t.bottom)/2;return Math.abs(n-window.innerHeight/2)}(t);return n<e[0]?[n,t]:e}),[1/0,null])[1]}function E(){const e=window.location.href;return e.startsWith("https://www.instagram.com/stories/highlights/")?function(){const e=document.querySelector('meta[property="og:url"]');if(!e)return null;const t=e.content.match(/(?<=\.com\/).*(?=\/)/);return t?t[0]:null}():_(e)}const _=e=>/(?<=stories\/).*?(?=\/)/.exec(e)[0];function S(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const q=new EventTarget;class x{constructor(e,t,n,o){S(this,"onAdded",null),S(this,"onRemoved",null),S(this,"getContainedElements",null),S(this,"elementType",null),this.onAdded=n,this.onRemoved=o,this.getContainedElements=t,this.elementType=e}matchesType(e){return e.includes(this.elementType)}}const C=[new x("post",(e=>"ARTICLE"==e.tagName?[e]:Array.from(e.querySelectorAll("article"))),(function(e){P("onPostAdded",e)}),(function(e){P("onPostRemoved",e)})),new x("preview",(e=>Array.from(e.querySelectorAll('a[href*="/p/"]')).filter((e=>null!=e.querySelector("img"))).map((e=>e.parentElement))),(function(e){P("onPreviewAdded",e)}),(function(e){P("onPreviewRemoved",e)})),new x("story",(e=>"SECTION"==e.tagName&&Array.from(e.children).findIndex((e=>"HEADER"==e.tagName))>0?[e]:Array.from(e.querySelectorAll("header")).map((e=>e.parentElement))),(function(e){P("onStoryAdded",e)}),(function(e){P("onStoryRemoved",e)}))];function P(e,t){q.dispatchEvent(new CustomEvent(e,{detail:{element:t}}))}function A(e,t){if(1!=e.nodeType)return;let n=d();for(let o of C)if(o.matchesType(n)){let n=o.getContainedElements(e),r=t?o.onAdded:o.onRemoved;n.forEach(r)}}function L(e){A(e,!0)}function k(e){A(e,!1)}function R(e){e.addedNodes.forEach(L),e.removedNodes.forEach(k)}function D(e){e.forEach(R)}q.start=function(){L(document.body),new MutationObserver(D).observe(document,{childList:!0,subtree:!0})};function I(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const M={initial:"save",loading:"spinner-of-dots",success:"verify-sign-green",fail:"error"};class O{get downloadState(){return this._downloadState}set downloadState(e){this._downloadState=e,this._onDownloadStateChanged()}get loadingProgress(){return this._loadingProgress}set loadingProgress(e){this._loadingProgress=e,"loading"===this._downloadState&&this._drawSpinner()}constructor(){I(this,"_downloadState","initial"),I(this,"_loadingProgress",0),I(this,"_spinnerCtx",null),I(this,"_spinnerCanvas",null),I(this,"_buttonImg",null),I(this,"_rootElement",null),this._rootElement=document.createElement("a"),this._rootElement.classList.add("download-button"),Object.assign(this._rootElement.style,{width:"fit-content",height:"fit-content",cursor:"pointer"}),this._buttonImg=document.createElement("img"),Object.assign(this._buttonImg.style,{width:"inherit",height:"inherit"}),this._rootElement.appendChild(this._buttonImg),this._setInitialState()}getElement(){return this._rootElement}_setInitialState(){let e=d()[0];const t=`${M.initial}-${"post"==e?"dark":"white"}`;this._buttonImg.src=chrome.extension.getURL(`icons/${t}.png`)}_onDownloadStateChanged(){const e=this._downloadState;if("loading"===e)this._spinnerCanvas||(this._spinnerCanvas=document.createElement("canvas"),this._spinnerCtx=this._spinnerCanvas.getContext("2d"),this._drawSpinner());else{this._spinnerCanvas=null,this._spinnerCtx=null;let t=M[e];if("initial"===e){t+=`-${"post"==d()[0]?"dark":"white"}`}this._buttonImg.src=chrome.extension.getURL(`icons/${t}.png`)}}_drawSpinner(){const e=this._spinnerCtx,t=this._loadingProgress,n=32;Object.assign(this._spinnerCanvas,{width:n,height:n}),e.clearRect(0,0,n,n),e.lineWidth=4;const o=(n-e.lineWidth)/2;e.strokeStyle="cyan",e.lineCap="round",e.beginPath();const r=-Math.PI/2;e.arc(16,16,o,r,r+2*t*Math.PI),e.stroke(),this._buttonImg.src=this._spinnerCanvas.toDataURL()}}const T=async(e,t)=>{const n=await new Promise(((e,t)=>{chrome.storage.sync.get({downloadMethod:"chrome-background"},(n=>{chrome.runtime.lastError?t(chrome.runtime.lastError.message):e(n.downloadMethod)}))})),o=e.src,r=(e=>{const t=[".mp4",".jpg"];for(let n of t){const t=e.indexOf(n);if(t>=0){let o=e.substring(0,t+n.length);return o=o.substring(o.lastIndexOf("/")+1),o}}})(o);if("native"===n){const n=/(?<="username":")[^"]*/.exec(document.body.innerHTML)[0],i=await(async e=>new Promise(((t,n)=>{chrome.storage.sync.get({baseDownloadDirectory:"",directoryRules:[]},(o=>{const r=((e,t,n)=>{const o=n.directoryRules||[];o.reverse();const r=n.baseDownloadDirectory||"",i=[...o,{baseDirectory:r}];for(let n of i){const o=n.username||[],r=n.downloadAs||[],i=n.baseDirectory||"",s=n.folderPath||"";if(0!==o.length&&!o.includes(e)||0!==r.length&&!r.includes(t))continue;let a=null;if(""!==i&&(a=`${i}/${e}`),""!==s&&(a=s),null!==a)return a}})(e.userName,e.ownUserName,o);r?t(r):n("no path found. have you set a path in the extension-options?")}))})))({mediaSrc:o,userName:e.username,ownUserName:n});await((e,t)=>{const n={requests:[{action:"write media by link",data:e}],time:window.performance.now()};let o=null,r=null;const i=new Promise(((e,t)=>{o=e,r=t})),s=chrome.runtime.connect({name:"disk-downloader"});return s.onMessage.addListener(((e,n)=>{if("native host disconnect"!==e.origin){if("native host response"===e.origin){const n=e.data[0],i=n.type;if("success"===i)return void o();if("error"===i)return void r(n.data);"progress"===i&&t(n.data.progress)}"success"===e.data[0].type&&s.disconnect()}else r(e.data)})),s.postMessage(n),i})({link:o,folderPath:i,fileName:r},t)}else"chrome-background"===n&&await(i={filePath:`Instagram/${e.username}/${r}`,url:o},s=t,new Promise(((e,t)=>{const n=chrome.runtime.connect({name:"chrome-downloader"});let o=null;const r=()=>{n.postMessage({type:"request-state",id:o})};n.onMessage.addListener((i=>"download-id"===i.type?(o=i.id,void r()):"error"===i.type?(t(i.error),void n.disconnect()):"success"===i.type?(e(),void n.disconnect()):"progress"===i.type?(s(i.progress.progress),void r()):void 0)),n.postMessage({type:"request-download",filePath:i.filePath,url:i.url})})));var i,s},j=(e,t={})=>{t={onDownloadStart:()=>{},onDownloadEnd:()=>{},...t};const n=new O,o=n.getElement(),r=async()=>{n.downloadState="loading";const o=e=>n.loadingProgress=e;t.onDownloadStart();try{await(async(e,t)=>{let n=null;try{n=await e(),await T(n,t)}catch(e){console.error(e);const t=n?`${e}, \n user: ${n.username}, \n src: ${n.src}`:e;throw chrome.runtime.sendMessage({type:"show-notification",notification:{title:"download failed",message:t,iconUrl:chrome.extension.getURL("icons/insta-loader-icon-48.png")}}),e}})(e,o),n.downloadState="success"}catch(e){n.downloadState="fail"}t.onDownloadEnd()};return o.addEventListener("download-request",r),o.addEventListener("mousedown",r),o},N=e=>{const t=document.createElement("div");return t.innerHTML=e,t.firstElementChild};const $=e=>{const t=(e=>{const t=e.querySelector("section");if(!t)return void console.warn("section with buttons not found");const n=Array.from(t.querySelectorAll("svg"));return n[n.length-1]})(e),n=t.parentElement,o=t.clientHeight+"px";return{width:o,height:o,padding:getComputedStyle(n).getPropertyValue("padding")}},H=e=>{const t=(e=>e.querySelector("section"))(e),n=N('\n\t\t<div \n\t\t\tstyle="\n\t\t\t\tdisplay: flex; \n\t\t\t\tflex-direction: row;\n\t\t\t\tpadding: 8px;\n\t\t\t\tpadding-right: 0px;\n\t\t\t\tmargin-left: 10px;\n\t\t\t"\n\t\t></div>\n\t'),o=function(e){let t=null,n=null;return async()=>{if(n||(n=w(e)),!t){const n=(e=>{const t=e.querySelectorAll('a[href*="/p/"'),n=t[t.length-1].href,o=n.indexOf("/p/")+3,r=n.indexOf("/",o);return n.substring(0,r+1)})(e);t=await f(n)}const o=t.username,r=t.mediaArray,i="collection"===n?v(r,e):r[0];if(i)return{username:o,...i};console.error("could not find media of the current collection item!")}}(e),r=j(o);((e,t)=>{Object.assign(t.style,$(e))})(e,r),n.appendChild(r),t.insertAdjacentElement("beforeend",n)},U=e=>{const t=N('\n\t\t<div style="\n\t\t\t\twidth: 100%;\n\t\t\t\tposition: absolute;\n\t\t\t\tleft: 0px;\n\t\t\t\tbottom: 0px;\n\t\t\t\tflex-direction: row;"\n\t\t>\n\t\t</div>\n\t'),n=j((()=>(async e=>{const t=e.querySelector("a");if(null===t)throw"link-element not found";let n=t.href;const o=await f(n);let r=o.mediaArray[0].src;return{username:o.username,src:r}})(e)));Object.assign(n.style,{width:"24px",height:"24px",padding:"5px"}),t.appendChild(n),e.appendChild(t)},F="Enter";function B(e){e.dispatchEvent(new CustomEvent("download-request"))}document.addEventListener("keydown",(e=>{e.key===F&&function(){const e=b();if(!e)return void console.warn("could not find current post");const t=e.querySelector(".download-button");t?B(t):console.warn("could not find download-button")}()}));const W=e=>{try{const t=(e=>{const t=e.querySelector("video");if(null!==t){const e=Array.from(t.querySelectorAll("source")),n=["42","4D","64"],o=e=>n.findIndex((t=>e.type.includes(t))),r=(e,t)=>o(e)-o(t);return e.sort(r),e[e.length-1].src}{const t=e.querySelector("img[srcset]");if(null!==t)return u(t.srcset)}return null})(e),n=E();return Promise.resolve({src:t,username:n})}catch(e){return Promise.reject(e)}};function V(){const e=document.querySelector("header svg");if(!e)return void console.warn("could not add download-button in story. the svg for the pause/play button could not be found");const t=function(e,t){let n=t;for(let t=0;t<1e3;t++){if(n.matches(e))return n;n=n.parentElement}return null}("button",e);if(t)return t;console.warn("could not add download-button in story. the svg for the pause/play button has not button as an ancestor")}const X=e=>{const t=N('\n\t\t<div style="margin-right: 20px;"></div>\n\t'),n=(()=>{let e=null;return{onDownloadStart:()=>{document.querySelector("video")&&(e=(()=>{let e=!1;const t=document.querySelector("video");return{keepPaused:()=>{e=!0;const n=()=>{t.paused||t.pause(),e&&window.requestAnimationFrame(n)};n()},continue:()=>{e=!1}}})(),e.keepPaused())},onDownloadEnd:()=>{e&&e.continue()}}})(),o=j((()=>W(e)),n);t.appendChild(o);V().parentElement.insertAdjacentElement("afterbegin",t),document.addEventListener("keypress",(e=>{e.key===F&&B(o)}))};q.addEventListener("onPostAdded",(e=>{H(e.detail.element)})),q.addEventListener("onPreviewAdded",(e=>{U(e.detail.element)})),q.addEventListener("onStoryAdded",(e=>{X(e.detail.element)})),q.start();function G(e){const t=e.querySelector("section").getBoundingClientRect().bottom;return window.innerHeight-t}function J(e,t){return G(e)<-30}function Y(e,t){return G(e)>30}function z(){return g().find(J)}function K(){return g().reverse().find(Y)}function Q(e){const t=e();if(!t)return void console.warn("could not find post to scroll to");const n=-G(t),o=window.scrollY+n;window.scrollTo({left:window.scrollX,top:o,behavior:"smooth"})}document.addEventListener("keydown",(e=>{"w"===e.key?Q(K):"s"===e.key&&Q(z)}));const Z={a:"left",d:"right"},ee={left:"LeftChevron",right:"RightChevron"};document.addEventListener("keydown",(e=>{const t=Z[e.key];t&&function(e){const t=r();console.log(t);const n="stories"===t?document.body:b();if(!n)return void console.warn("could not find current-element");const o=ee[e],i=n.querySelector(`[class*="${o}"]`);if(!i)return void console.warn("could not find navigation-element");i.parentElement.click()}(t)}))}();
//# sourceMappingURL=index.js.map
