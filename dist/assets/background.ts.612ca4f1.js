function d(e){const t=chrome.runtime.lastError;return t===void 0?e:t.message||e}const c=e=>new Promise((t,r)=>{chrome.downloads.download(e,n=>{if(n!==void 0){t(n);return}r(d("chrome.runtime.lastError is undefined. no idea what the issue is, sorry"))})});async function l(e,t){try{const r=await c({url:t.url,filename:t.filePath,conflictAction:"prompt"});e.postMessage({type:"download-id",id:r})}catch(r){e.postMessage({type:"error",error:r})}}function u(e,t){chrome.downloads.search({id:t.id},r=>{if(r.length===0){e.postMessage({type:"error",error:"download started but file not found. this may be a problem with chrome."});return}else{r.length>1&&console.warn("more than one file for this download found. this shoud not happen");const n=r[0],o=n.state;if(o==="interrupted"){e.postMessage({type:"error",error:n.error});return}if(o==="complete"){e.postMessage({type:"success"});return}if(o==="in_progress"){e.postMessage({type:"progress",progress:{bytesReceived:n.bytesReceived,totalBytes:n.totalBytes,progress:n.bytesReceived/n.totalBytes}});return}}})}chrome.runtime.onConnect.addListener(e=>{e.name==="chrome-downloader"&&(e.onDisconnect.addListener(()=>console.log("port disconnected")),e.onMessage.addListener(async(t,r)=>{if(console.log(t),t.type==="request-download"){l(e,t);return}t.type==="request-state"&&u(e,t)}))});console.log("listening for instagram API calls ...");function f(e){const t={};for(const{name:r,value:n}of e)n!==void 0&&(t[r]=n);return t}function m(e){const{tabId:t,requestHeaders:r}=e;if(!r)return;const n=r.find(s=>s.name==="X-IG-WWW-Claim");if(!n)return;const o=n.value;if(!o||o.length<2)return;const i=["X-IG-App-ID","X-IG-WWW-Claim"],a=f(r.filter(s=>i.includes(s.name)));console.log("detected valid headers",a),chrome.tabs.sendMessage(t,{requestHeaders:a})}function h(e){const{tabId:t,url:r}=e,n=/(?<=i\.instagram\.com\/api\/v1\/media\/)\d*(?=\/info)/.exec(r);if(!n)return;const o=n[0];console.log("detected media ID!"),chrome.tabs.sendMessage(t,{mediaID:o})}chrome.webRequest.onSendHeaders.addListener(function(e){m(e),h(e)},{urls:["*://i.instagram.com/api/*"]},["requestHeaders"]);chrome.webNavigation.onHistoryStateUpdated.addListener(e=>{console.log("waking up")});
