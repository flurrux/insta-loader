import{f as q,n as y,s as x,c as z,O as Q,m as ge,t as pe,i as u,l as c,a as ye,r as l,p as w,b as we,d as ve,e as xe,g as X,h as G,j as be,k as m,o as Se}from"./vendor.0e969140.js";const P={mainFeed:"mainFeed",post:"post",personFeed:"personFeed",stories:"stories"},b=()=>{let e=window.location.href;return e.endsWith("instagram.com/")||e.includes(".com/?")?P.mainFeed:e.includes("/p/")?P.post:e.includes("/reel/")?"reel":e.includes("/stories/")?P.stories:P.personFeed};b();document.querySelector("#mount_0_0_8N");const B=()=>{const e=b();return e==="personFeed"?["preview"]:e==="stories"?["story"]:["post"]},S=new EventTarget;function K(e){return e.map(t=>t.parentElement).filter(t=>t!==null)}const Ee=q(e=>e.querySelectorAll('a[href*="/p/"]'),Array.from,K);function Ie(e){return e.tagName=="ARTICLE"?[e]:Array.from(e.querySelectorAll("article"))}function Pe(e){return e.tagName=="SECTION"&&Array.from(e.children).findIndex(t=>t.tagName=="HEADER")>0?[e]:K(Array.from(e.querySelectorAll("header")))}const U=(e,t)=>{S.dispatchEvent(new CustomEvent(e,{detail:{element:t}}))};class _{constructor(t,n){this.getContainedElements=n,this.elementType=t}matchesType(t){return t.includes(this.elementType)}buildEventName(t){const n=this.elementType;return`on${n[0].toUpperCase()+n.slice(1)}${t}`}onAdded(t){U(this.buildEventName("Added"),t)}onRemoved(t){U(this.buildEventName("Removed"),t)}}const De=[new _("post",Ie),new _("preview",Ee),new _("story",Pe)];function Y(e,t){if(e.nodeType!=1)return;let n=B();for(let r of De)if(r.matchesType(n)){let o=r.getContainedElements(e),i=t?r.onAdded.bind(r):r.onRemoved.bind(r);o.forEach(i)}}function J(e){e instanceof HTMLElement&&Y(e,!0)}function Ce(e){e instanceof HTMLElement&&Y(e,!1)}function Ae(e){e.addedNodes.forEach(J),e.removedNodes.forEach(Ce)}function Me(e){e.forEach(Ae)}function _e(){var e=new MutationObserver(Me);e.observe(document,{childList:!0,subtree:!0})}function ke(){J(document.body)}function Be(){ke(),_e()}S.start=Be;const F=e=>{const t=document.createElement("div");return t.innerHTML=e,t.firstElementChild};function Te(e,t){let n=t;for(let r=0;r<1e3;r++){if(n.matches(e))return n;n=n.parentElement}return null}function Z(e,t){return()=>{window.setTimeout(e,t)}}function A(e){return e?e[0]:null}function qe(e){return e?x(e[0]):y}const Fe=e=>q(t=>e.exec(t),qe);function Oe(e){const t=e.parentElement;if(!t)return null;const n=t.parentElement;return n||null}function Ne(e,t){const n=A(/(?<=translateX\()[\d\.]*(?=px)/.exec(t.style.transform));return n?Math.round(parseFloat(n)/e):null}function ee(e){const t=Oe(e);if(!t)return null;const n=t.getBoundingClientRect().x,r=1,o=e.children[r],i=parseFloat(getComputedStyle(o).getPropertyValue("width"));for(let s=r;s<e.children.length;s++){const a=e.children[s],d=a.getBoundingClientRect().x;if(Math.abs(n-d)>i/2)continue;const h=Ne(i,a);if(h!==null)return{index:h,child:a}}return null}function te(e){const t=e.querySelector("ul");if(!t)return null;const n=ee(t);return n?{list:t,...n}:null}function Re(e,t){let n=-1;const r=Z(()=>{const i=ee(e);if(!i){console.warn("could not find index and child of carousel!");return}i.index!==n&&(n=i.index,t(i))},100);new MutationObserver(r).observe(e,{childList:!0,subtree:!0}),r()}function Le(e){return Array.from(e.querySelectorAll("img")).find(t=>t.offsetHeight>400)}function E(e){const t=e.querySelector("video, img[srcset]");return t||Le(e)}function ne(e){const t=e.querySelectorAll('a[href*="/p/"');if(t.length===0)return null;const n=t[t.length-1].href,r=n.indexOf("/p/");if(r<0)return null;const o=r+3,i=n.indexOf("/",o);return i<0?null:n.substring(0,i+1)}function Ue(e,t){let n=t;for(let r=0;r<1e3;r++){if(n.matches("li"))return!0;if(n===e)return!1;const o=n.parentElement;if(!o)return!1;n=o}return!1}function T(e){const t=E(e);return t?Ue(e,t)?"collection":t.tagName==="VIDEO"?"video":"image":null}function He(e){const t=e.querySelector("header a").href,n=/(?<=\.com\/).*(?=\/)/.exec(t);return n?n[0]:null}function $e(e){const t=e.split(" ");return{src:t[0],quality:parseInt(t[1])}}function je(e){return e.split(",").map($e)}function re(e){const t=je(e);let n=0;for(let r=1;r<t.length;r++)t[r].quality>t[n].quality&&(n=r);return t[n].src}function We(e){return te(e)?.child}function Ve(e,t){const n=t.poster;if(n==="")return console.warn("cannot find the position for this collection-element!"),null;const r=A(/^https:\/\/.*\.jpg/.exec(n));if(!r)return null;const o=e.findIndex(i=>i.previewSrc.includes(r));return o<0?(console.warn("poster does not match any previews, therefore cannot find the index for this item"),console.log(n,r,e),null):e[o]}function ze(e){let t="";const n=e.srcset;return n?t=re(n):t=e.src,{type:"image",src:t,previewSrc:""}}function Qe(e,t){const n=We(t);if(!n)return console.warn("couldn't find carousel element"),null;const r=E(n);return r?r.matches("video")?Ve(e,r):r.matches("img")?ze(r):(console.warn("mediaElement does not match video or img"),null):(console.warn("couldn't find image or video"),null)}function oe(e){return parseInt(e.getAttribute("bandwidth"))}function Xe(e){return e.hasAttribute("bandwidth")}const Ge=z(oe)(Q),Ke=ge(Ge);function Ye(e){const t=e.querySelector("BaseURL");if(!t)return c({failure:"element does not have a child of type BaseURL from which the url could be extracted.",context:e});const n=t.textContent;return n===null?c({failure:"found a BaseURL-node but its textContent is null",context:{element:e,baseUrlNode:t}}):l(n)}function Je(e){const t=e.getAttribute("width");if(t===null)return c({failure:'element has no "width" attribute',context:e});const n=e.getAttribute("height");return n===null?c({failure:'element has no "height" attribute',context:e}):l({width:parseInt(t),height:parseInt(n)})}function H(e){const t=[];if(e.children.length===0)return c({failure:"AdaptationSet has zero child nodes",context:e});const n=Array.from(e.children),r=n.filter(Xe);if(r.length===0)return c({failure:"none of the childnodes has a bandwidth attribute",context:e});r.length!==n.length&&t.push({failure:"some children of this AdaptationSet have no bandwidth attribute",context:e}),console.log(r);const o=w(r,Ke),i=Ye(o);if(console.log(i),u(i))return i;const s=oe(o);return l({success:{element:o,mediaData:{url:i.right,bandwidth:s}},warnings:t})}function Ze(e){const t=[],n=e.children[0];if(n===null)return c({failure:"XMLDocument doc does not have a MPD-node",context:e});const r=Array.from(n.querySelectorAll("Period"));if(r.length===0)return c({failure:"could not find any nodes with the 'Period' tag in MPD",context:{doc:e,mpd:n}});r.length>1&&t.push({failure:"found more than 1 Period Element",context:{doc:e,MPD:n,periodNodes:r}});const o=r[0],i=Array.from(o.querySelectorAll("AdaptationSet"));if(i.length===0)return c({failure:"found no AdaptationSets in Period Element",context:o});i.length>2&&t.push({failure:"expected 2 AdaptationSets, 1 for video and 1 for audio, but got more than 2",context:{doc:e,period:o,adaptationSets:i}});const s=i.findIndex(I=>!!(I.getAttribute("contentType")==="video"||I.hasAttribute("maxFrameRate")));if(s<0)return c({failure:"could not find any AdaptationSets that contain videos, or maybe the attributes 'contentType' and 'maxFrameRate' do not work anymore.",context:{doc:e,period:o,adaptationSets:i}});const a=i[s],d=H(a);if(u(d))return c({failure:"error while trying to extract video data",context:{videoSet:a,subFailure:d.left}});const h=d.right,f=Je(h.success.element);if(u(f))return c({failure:"could not extract width or height from video",context:{doc:e,subContext:f.left}});const g=f.right,p=h.success.mediaData;let L=y;if(i.length>1){const I=i[s===0?1:0],M=H(I);if(ye(M)){const me=M.right;L=x(me.success.mediaData)}}return l({data:{video:{...p,...g},audio:L},warnings:t})}function et(e){const t=new DOMParser;return pe(()=>t.parseFromString(e,"text/xml"),n=>n instanceof Error?n:new Error("unknown error"))}function tt(e){const t=et(e);return u(t)?t:Ze(t.right)}const nt=e=>e.width*e.height,rt=z(nt)(we(Q));function $(e){return xe(rt)(e)[0].url}function ot(e){if(!("video_dash_manifest"in e))return y;const t=tt(e.video_dash_manifest);if(u(t))return console.error(t.left),y;const n=t.right;return n.warnings.length>0&&console.warn(n.warnings),x({type:"video",src:n.data.video.url,previewSrc:e.image_versions2.candidates[0].url})}function D(e){if("video_versions"in e){const n=ot(e);return ve(n)?n.value:{type:"video",src:$(e.video_versions),previewSrc:e.image_versions2.candidates[0].url}}const t=$(e.image_versions2.candidates);return{type:"image",src:t,previewSrc:t}}function it(e){return e.carousel_media.map(D)}function st(e){if(!e.items)throw console.log(e),"items not found in dataObject (see above log)";const t=e.items;if(t.length===0)throw"items are empty";const n=t[0],r=n.user.username;let o=[],i="video";if("video_versions"in n&&(i="video",o.push(D(n))),"image_versions2"in n&&(i="image",o.push(D(n))),"carousel_media"in n&&(i="collection",o=it(n)),o.length===0)throw"no media found";return{postType:i,mediaArray:o,username:r}}let v=null;function O(){if(!v)throw"trying to fetch media info from instagram API, but there was no previous request that we could imitate. please check if `web-request-listener.ts` and `foreground-collector.ts` are working properly.";return v}function at(){return v?l(v):c("trying to fetch media info from instagram API, but there was no previous request that we could imitate. please check if `web-request-listener.ts` and `foreground-collector.ts` are working properly.")}chrome.runtime.onMessage.addListener(function(e){"requestHeaders"in e&&(v=e.requestHeaders)});function ct(e){return`https://i.instagram.com/api/v1/media/${e}/info/`}async function ut(e,t){const n=await fetch(ct(t),{credentials:"include",headers:e});return l(await n.json())}async function lt(e){const t=O();return ut(t,e)}let ie=c("trying to find the media ID, but there was no previous request. please check if `web-request-listener.ts` and `foreground-collector.ts` are working properly.");function dt(){return ie}chrome.runtime.onMessage.addListener(function(e){"mediaID"in e&&(ie=l(e.mediaID))});async function ft(){const e=dt();if(u(e))return e;const t=await lt(e.right);if(u(t))throw t;const n=st(t.right);return l(n)}function ht(e){return e.srcset.length===0?e.src:re(e.srcset)}function se(e){const t=e.tagName==="VIDEO"?"video":"image",n=t==="image"?ht(e):e.src;return{type:t,src:n}}function mt(e){const t=E(e);return t?se(t):(console.log("could not find any media element in post",e),null)}function gt(e,t){if(e==="video")return null;if(e==="image")return mt(t);const n=te(t);if(!n)return console.warn("could not find the current index of carousel"),null;const r=E(n.child);return!r||!(r instanceof HTMLImageElement)?null:se(r)}const pt=e=>{let t=null,n=null;return async()=>{if(!n&&(n=T(e),!n)){console.error("could not find type of post");return}const r=gt(n,e);if(r)return{username:He(e),...r};if(b()!=="post"){console.warn("please open the page of this post in a new tab. downloading videos directly from the mainfeed is not working right now unfortunately. we're working on a fix!");return}if(!t){if(!ne(e)){console.error("could not find href of post");return}const d=await ft();if(u(d)){console.error(d.left);return}t=d.right}const{username:o,mediaArray:i}=t,s=n==="collection"?Qe(i,e):i[0];if(!s){console.error("could not find media of the current collection item!");return}return{username:o,...s}}};function ae(e){return e.map(t=>`\\${t}`).join("|")}function yt(e){const t=ae(e);return new RegExp(`[^/]*(${t})`)}function wt(e,t){return new RegExp(ae(e)).exec(t)!==null}const vt=(e,t)=>n=>{const r=e.exec(n);if(r!==null){const o=r[0];return l(o)}return wt(t,n)?c(`could not extract a filename from the url '${n}' although it appears to contain a valid file-extension.`):c(`the url '${n}' does not contain any of the expected file-extensions: ${t.join(", ")}`)},xt=e=>vt(yt(e),e),bt=xt([".mp4",".jpg",".webp",".webm"]);function St(){const e=/(?<="username":")[^"]*/.exec(document.body.innerHTML);return e?e[0]:null}const Et=(e,t)=>new Promise((n,r)=>{const o=chrome.runtime.connect({name:"chrome-downloader"});let i=null;const s=()=>{o.postMessage({type:"request-state",id:i})};o.onMessage.addListener(a=>{if(a.type==="download-id"){i=a.id,s();return}if(a.type==="error"){r(a.error),o.disconnect();return}if(a.type==="success"){n(),o.disconnect();return}if(a.type==="progress"){t(a.progress.progress),s();return}}),o.postMessage({type:"request-download",filePath:e.filePath,url:e.url})}),It=(e,t)=>{const n={requests:[{action:"write media by link",data:e}],time:window.performance.now()};let r=null,o=null;const i=new Promise((a,d)=>{r=a,o=d}),s=chrome.runtime.connect({name:"disk-downloader"});return s.onMessage.addListener((a,d)=>{if(a.origin==="native host disconnect"){o(a.data);return}else if(a.origin==="native host response"){const f=a.data[0],g=f.type;if(g==="success"){r();return}else if(g==="error"){o(f.data);return}else g==="progress"&&t(f.data.progress)}a.data[0].type==="success"&&s.disconnect()}),s.postMessage(n),i},Pt=(e,t,n)=>{const r=n.directoryRules||[];r.reverse();const o=n.baseDownloadDirectory||"",i=[...r,{baseDirectory:o}];for(let s of i){const a=s.username||[],d=s.downloadAs||[],h=s.baseDirectory||"",f=s.folderPath||"";if(!((a.length===0||a.includes(e))&&(d.length===0||d.includes(t))))continue;let p=null;if(h!==""&&(p=`${h}/${e}`),f!==""&&(p=f),p!==null)return p}},Dt=async e=>new Promise((t,n)=>{chrome.storage.sync.get({baseDownloadDirectory:"",directoryRules:[]},r=>{const o=Pt(e.userName,e.ownUserName,r);o?t(o):n("no path found. have you set a path in the extension-options?")})});function C(e){return chrome.runtime.getURL(`assets/icons/${e}.png`)}const j={initial:"save",loading:"spinner-of-dots",success:"verify-sign-green",fail:"error"};class Ct{constructor(){this._downloadState="initial",this._loadingProgress=0,this._spinnerCtx=null,this._spinnerCanvas=null,this._buttonImg=null,this._rootElement=null,this._rootElement=document.createElement("a"),this._rootElement.classList.add("download-button"),Object.assign(this._rootElement.style,{width:"fit-content",height:"fit-content",cursor:"pointer"}),this._buttonImg=document.createElement("img"),Object.assign(this._buttonImg.style,{width:"inherit",height:"inherit"}),this._rootElement.appendChild(this._buttonImg),this._setInitialState()}get downloadState(){return this._downloadState}set downloadState(t){this._downloadState=t,this._onDownloadStateChanged()}get loadingProgress(){return this._loadingProgress}set loadingProgress(t){this._loadingProgress=t,this._downloadState==="loading"&&this._drawSpinner()}getElement(){return this._rootElement}_setInitialState(){let n=B()[0]=="post"?"dark":"white";const r=`${j.initial}-${n}`;this._buttonImg.src=C(r)}_onDownloadStateChanged(){const t=this._downloadState;if(t==="loading")this._spinnerCanvas||(this._spinnerCanvas=document.createElement("canvas"),this._spinnerCtx=this._spinnerCanvas.getContext("2d"),this._drawSpinner());else{this._spinnerCanvas=null,this._spinnerCtx=null;let n=j[t];t==="initial"&&(n+=`-${B()[0]=="post"?"dark":"white"}`),this._buttonImg.src=C(n)}}_drawSpinner(){const t=this._spinnerCtx,n=this._loadingProgress,r=32;Object.assign(this._spinnerCanvas,{width:r,height:r}),t.clearRect(0,0,r,r),t.lineWidth=4;const o=(r-t.lineWidth)/2;t.strokeStyle="cyan",t.lineCap="round",t.beginPath();const i=r/2,s=-Math.PI/2;t.arc(i,i,o,s,s+n*2*Math.PI),t.stroke(),this._buttonImg.src=this._spinnerCanvas.toDataURL()}}const At="chrome-background",Mt=()=>new Promise((e,t)=>{chrome.storage.sync.get({downloadMethod:At},n=>{if(chrome.runtime.lastError){t(chrome.runtime.lastError.message);return}e(n.downloadMethod)})}),_t=async(e,t)=>{const n=await Mt(),r=e.src,o=bt(r);if(u(o))throw o.left;const i=o.right;if(n==="native"){const s=St(),a=await Dt({mediaSrc:r,userName:e.username,ownUserName:s});await It({link:r,folderPath:a,fileName:i},t)}else n==="chrome-background"&&await Et({filePath:`Instagram/${e.username}/${i}`,url:r},t)},kt=async(e,t)=>{let n=null;try{n=await e(),await _t(n,t)}catch(r){console.error(r);const o=n?`${r}, 
 user: ${n.username}, 
 src: ${n.src}`:r;throw chrome.runtime.sendMessage({type:"show-notification",notification:{title:"download failed",message:o,iconUrl:C("insta-loader-icon-48")}}),r}},ce=(e,t={})=>{t={onDownloadStart:()=>{},onDownloadEnd:()=>{},...t};const n=new Ct,r=n.getElement(),o=async()=>{n.downloadState="loading";const i=s=>n.loadingProgress=s;t.onDownloadStart();try{await kt(e,i),n.downloadState="success"}catch{n.downloadState="fail"}t.onDownloadEnd()};return r.addEventListener("download-request",o),r.addEventListener("mousedown",o),r};function Bt(e){return F(`
		<div 
			style="
				display: flex; 
				flex-direction: row;
				padding: 8px;
				padding-right: 0px;
				margin-left: 10px;
			"
		>
			<a 
				href="${e}"
				style="width: fit-content; height: fit-content; cursor: pointer;"
			>
				<img 
					style="width: inherit; height: inherit;"
					src="${C("external-link-white")}"
				/>
			</a>
		</div>
	`)}function Tt(e){const t=e.querySelector("section");if(!t)return console.warn("trying to find bar with like-button, save-button, etc. in order to inject the download-button, but cannot find it!"),null;const n=Array.from(t.querySelectorAll("svg"));return n.length===0?null:n[n.length-1]}const qt=e=>{const t=Tt(e);if(!t)return null;const n=t.parentElement;if(!n)return null;const r=t.clientHeight+"px",o=getComputedStyle(n).getPropertyValue("padding");return{width:r,height:r,padding:o}},ue=(e,t)=>{Object.assign(t.style,qt(e))};function Ft(e){const t=ce(pt(e));ue(e,t);const n=F(`
		<div 
			style="
				display: flex; 
				flex-direction: row;
				padding: 8px;
				padding-right: 0px;
				margin-left: 10px;
			"
		></div>
	`);return n.appendChild(t),n}function Ot(e){const t=Bt(ne(e));return ue(e,t.firstElementChild),t}function Nt(e){return new Promise(t=>{const n=T(e);if(n){t(n);return}const r=Z(()=>{const i=T(e);!i||(t(i),o.disconnect())},600),o=new MutationObserver(r);o.observe(e,{childList:!0,subtree:!0})})}async function Rt(e,t,n){const r=t.style.display,o=a=>{t.style.display=a?r:"none",e.style.display=a?"none":"initial"};if(b()!=="mainFeed"){e.style.display="none";return}const i=await Nt(n);if(i==="image")return;if(i==="video"){o(!1);return}const s=n.querySelector("ul");if(!s)return null;Re(s,({child:a})=>{console.log(a);const d=E(a);!d||o(d.matches("img"))})}function Lt(e){const t=e.querySelector("section");if(!t){console.warn("trying to inject download buttons into post, but cannot find any child with tag 'Section'");return}const n=Ot(e);t.appendChild(n);const r=Ft(e);t.appendChild(r),Rt(n,r,e)}function Ut(){return document.querySelector("article")?.parentElement}function N(){const e=Ut();return e?Array.from(e.children):[]}function Ht(e){const t=e.getBoundingClientRect(),n=(t.top+t.bottom)/2;return Math.abs(n-window.innerHeight/2)}function le(){const e=N();return e.length===0?null:e.reduce((n,r)=>{const o=Ht(r);return o<n[0]?[o,r]:n},[1/0,null])[1]}const de="Enter";function fe(e){e.dispatchEvent(new CustomEvent("download-request"))}function $t(e){return e.querySelector(".download-button")}function jt(){const e=le();if(!e){console.warn("download by shortcut: could not find the currently visible post to download");return}const t=$t(e);if(t===null){console.warn("download by shortcut: found the currently visible post, but there seems to be no download button. are you sure it's there?");return}fe(t)}document.addEventListener("keydown",e=>{e.key===de&&jt()});function Wt(){return w(location.pathname,e=>/(?<=\/stories\/.*\/)\d*/.exec(e),A,X)}const Vt=()=>w(document.querySelector("section section"),G("expected to find the story-element in a section inside another section, but this query returned null. are you sure you are currently watching a story? if yes, instagram might have changed things up in the DOM. i'm deeply sorry and ashamed."));function zt(e){const t=e.querySelector("header");if(!t)return c(["trying to find the progress-bars in this story but could not find the header-element that was expected to be there. look for yourself:",e]);const n=t.firstChild;return n?.firstChild?l(n):c(["there appears to be not a single progress-bar in this story. it is more likely that the DOM has another shape than expected. the following element was expected to contain all progress-bars of this story",n])}function Qt(e){for(const t of e.children){const{width:n}=t.style;if(n.length!==0)return parseFloat(n)}return 0}function Xt(e){return Qt(e)<100}function Gt(){const e=Vt();if(u(e))return e;const t=zt(e.right);if(u(t))return t;const n=w(t.right.children,Array.from,be(Xt));return m(n)?c("trying to find the current story-index by looking for the first progress-bar that has not finished. but it appears that every single progress-bar has completed."):l(n.value)}function Kt(){const{pathname:e}=location;return e.startsWith("/stories/highlights/")?"highlight_reel":"user_reel"}function Yt(){const e=window.location.href;return location.pathname.startsWith("/stories/highlights/")?Zt():en(e)}function Jt(e,t){return G(`could not extract username from url: ${t}`)(A(e.exec(t)))}function Zt(){const e=/(?<=:\/\/www\.instagram\.com\/).*?(?=\/)/,t=w('link[href*="://www.instagram.com/"]',r=>document.querySelectorAll(r),Array.from,Se(q(r=>r.href,r=>e.exec(r),X)));if(m(t))return c("trying to find a username on the profile page, but there seems to be no link element where we could read off the url.");const n=t.value[0];return l(n)}function en(e){return Jt(/(?<=stories\/).*?(?=\/)/,e)}function tn(e){return`https://i.instagram.com/api/v1/feed/reels_media/?reel_ids=highlight%3A${e}`}const nn=()=>w(location.pathname,Fe(/(?<=\/stories\/highlights\/)\d*/));async function rn(e,t){const n=await fetch(tn(t),{credentials:"include",headers:e});return l(await n.json())}async function on(){const e=at();if(u(e))return e;const t=nn();return m(t)?c("could not find the ID of the highlights-story"):rn(e.right,t.value)}function sn(e){return`https://i.instagram.com/api/v1/feed/reels_media/?reel_ids=${e}`}async function an(e,t){const n=await fetch(sn(t),{credentials:"include",headers:e});return l(await n.json())}async function cn(e){const t=O();return an(t,e)}function un(e){return`https://i.instagram.com/api/v1/feed/user/${e}/username/?count=1`}async function ln(e,t){const r=await(await fetch(un(t),{credentials:"include",headers:e})).json();console.log("fetched user-info",r);const o=r.user;return l(o)}async function dn(e){const t=O();return ln(t,e)}async function fn(){const e=Yt();if(u(e))return e;const t=e.right,n=await dn(t);if(u(n))return n;const o=n.right.pk.toString(),i=await cn(o);return u(i)?i:l(i.right.reels_media[0])}async function hn(){const e=await on();return u(e)?e:l(e.right.reels_media[0])}async function mn(){return Kt()==="highlight_reel"?hn():fn()}function gn(e){const t=Wt();if(m(t))return c(`could not story-id in url ${location.href}`);const n=t.value,r=e.items.find(o=>o.pk===n);return r?l(r):(console.log(e.items,n),c(`could not find story-ID ${n} in any of the fetched story-items`))}function pn(e){const t=Gt();return u(t)?t:l(e.items[t.right])}function yn(e){return e.reel_type==="user_reel"?gn(e):pn(e)}function wn(){let e=y;return async()=>{if(m(e)){const a=await mn();if(u(a))throw a.left;e=x(a.right)}const t=e.value,n=yn(t);if(u(n))return n;const r=n.right,o=D(r),{username:i}=t.user;return{src:o.src,username:i}}}const vn=()=>{let e=!1;const t=document.querySelector("video");return{keepPaused:()=>{e=!0;const o=()=>{t.paused||t.pause(),e&&window.requestAnimationFrame(o)};o()},continue:()=>{e=!1}}};function xn(){return document.querySelector("header svg")}function bn(){const e=xn();if(!e){console.warn("could not add download-button in story. the svg for the pause/play button could not be found");return}const t=Te("button",e);if(!t){console.warn("could not add download-button in story. the svg for the pause/play button has not button as an ancestor");return}return t}const Sn=e=>{const t=F(`
		<div style="margin-right: 20px;"></div>
	`),n=(()=>{let s=null;return{onDownloadStart:()=>{document.querySelector("video")&&(s=vn(),s.keepPaused())},onDownloadEnd:()=>{!s||s.continue()}}})(),r=ce(wn(),n);t.appendChild(r),bn().parentElement.insertAdjacentElement("afterbegin",t),document.addEventListener("keypress",s=>{s.key===de&&fe(r)})};S.addEventListener("onPostAdded",e=>{Lt(e.detail.element)});S.addEventListener("onStoryAdded",e=>{Sn(e.detail.element)});S.start();const he=30;function R(e){const t=e.querySelector("section");if(t===null)return console.warn("trying to calculate distance to bottom, cannot find a 'section' element in post"),y;const n=t.getBoundingClientRect().bottom,r=window.innerHeight;return x(r-n)}function En(e){const t=R(e);return m(t)?!1:t.value<-he}function In(e){const t=R(e);return m(t)?!1:t.value>he}function Pn(){return N().find(En)}function Dn(){return N().reverse().find(In)}function W(e){const t=e();if(!t){console.warn("could not find post to scroll to");return}const n=-R(t),r=window.scrollY+n;window.scrollTo({left:window.scrollX,top:r,behavior:"smooth"})}function Cn(){const e={"scroll-up":"w","scroll-down":"s"};document.addEventListener("keydown",t=>{t.key===e["scroll-up"]?W(Dn):t.key===e["scroll-down"]&&W(Pn)})}Cn();const V={a:"left",d:"right"},An={left:"LeftChevron",right:"RightChevron"};function k(){console.warn("you've tried to navigate to the next or previous image/video but we couldn't find the button to click on")}function Mn(e){const n=b()==="stories"?document.body:le();if(!n){k();return}const r=An[e],o=n.querySelector(`[class*="${r}"]`);if(!o){k();return}const i=o.parentElement;if(!i){k();return}i.click()}document.addEventListener("keydown",e=>{const{key:t}=e;t in V&&Mn(V[t])});console.log("### insta loader initialized ###");
