import{O as P,n as N,N as G,E as c,a as m,_ as k,b as J}from"./vendor.8cd73852.js";function F(e){return parseInt(e.getAttribute("bandwidth"))}function Z(e){return e.hasAttribute("bandwidth")}const ee=P.contramap(F)(N.Ord),te=G.max(ee);function ne(e){const t=e.querySelector("BaseURL");if(!t)return c.left({failure:"element does not have a child of type BaseURL from which the url could be extracted.",context:e});const n=t.textContent;return n===null?c.left({failure:"found a BaseURL-node but its textContent is null",context:{element:e,baseUrlNode:t}}):c.right(n)}function oe(e){const t=e.getAttribute("width");if(t===null)return c.left({failure:'element has no "width" attribute',context:e});const n=e.getAttribute("height");return n===null?c.left({failure:'element has no "height" attribute',context:e}):c.right({width:parseInt(t),height:parseInt(n)})}function O(e){const t=[];if(e.children.length===0)return c.left({failure:"AdaptationSet has zero child nodes",context:e});const n=Array.from(e.children),o=n.filter(Z);if(o.length===0)return c.left({failure:"none of the childnodes has a bandwidth attribute",context:e});o.length!==n.length&&t.push({failure:"some children of this AdaptationSet have no bandwidth attribute",context:e});const r=k.pipe(o,te),i=ne(r);if(c.isLeft(i))return i;const s=F(r);return c.right({success:{element:r,mediaData:{url:i.right,bandwidth:s}},warnings:t})}function re(e){const t=[],n=e.children[0];if(n===null)return c.left({failure:"XMLDocument doc does not have a MPD-node",context:e});const o=Array.from(n.querySelectorAll("Period"));if(o.length===0)return c.left({failure:"could not find any nodes with the 'Period' tag in MPD",context:{doc:e,mpd:n}});o.length>1&&t.push({failure:"found more than 1 Period Element",context:{doc:e,MPD:n,periodNodes:o}});const r=o[0],i=Array.from(r.querySelectorAll("AdaptationSet"));if(i.length===0)return c.left({failure:"found no AdaptationSets in Period Element",context:r});i.length>2&&t.push({failure:"expected 2 AdaptationSets, 1 for video and 1 for audio, but got more than 2",context:{doc:e,period:r,adaptationSets:i}});const s=i.findIndex(v=>v.hasAttribute("maxFrameRate"));if(s<0)return c.left({failure:"could not find any AdaptationSets that contain videos, or maybe the attribute 'maxFrameRate' is not indicative of AdaptationSets with videos anymore",context:{doc:e,period:r,adaptationSets:i}});const a=i[s],l=O(a);if(c.isLeft(l))return c.left({failure:"error while trying to extract video data",context:{videoSet:a,subFailure:l.left}});const u=l.right,d=oe(u.success.element);if(c.isLeft(d))return c.left({failure:"could not extract width or height from video",context:{doc:e,subContext:d.left}});const f=d.right,h=u.success.mediaData;let T=m.none;if(i.length>1){const v=i[s===0?1:0],R=O(v);if(c.isRight(R)){const Y=R.right;T=m.some(Y.success.mediaData)}}return c.right({data:{video:{...h,...f},audio:T},warnings:t})}function ie(e){const t=new DOMParser;return c.tryCatch(()=>t.parseFromString(e,"text/xml"),n=>n instanceof Error?n:new Error("unknown error"))}function se(e){const t=ie(e);return c.isLeft(t)?t:re(t.right)}const w={mainFeed:"mainFeed",post:"post",personFeed:"personFeed",stories:"stories"},y=()=>{let e=window.location.href;return e.endsWith("instagram.com/")||e.includes(".com/?")?w.mainFeed:e.includes("/p/")?w.post:e.includes("/reel/")?"reel":e.includes("/stories/")?w.stories:w.personFeed},ae=[],ce=e=>{ae.forEach(t=>t(e))};let S=window.location.href,x=y();const de=document.querySelector("#react-root"),le=()=>{const e=window.location.href;if(e===S)return;const t=S,n=x;S=e,x=y(),ce({oldHref:t,newHref:e,oldPageType:n,newPageType:x})};new MutationObserver(le).observe(de,{childList:!0,subtree:!0});const b=()=>{const e=y();return e==="personFeed"?["preview"]:e==="stories"?["story"]:["post"]};function ue(e){const t=e.split(" ");return{src:t[0],quality:parseInt(t[1])}}function fe(e){return e.split(",").map(ue)}function U(e){const t=fe(e);let n=0;for(let o=1;o<t.length;o++)t[o].quality>t[n].quality&&(n=o);return t[n].src}const he=()=>/(?<="username":")[^"]*/.exec(document.body.innerHTML)[0],me=e=>Array.from(e.querySelectorAll("img")).find(t=>t.offsetHeight>400),ge=e=>{const t=e.querySelector("video, img[srcset]");return t||me(e)},pe=e=>e.width*e.height,we=P.contramap(pe)(P.reverse(N.Ord));function A(e){return J.sort(we)(e)[0].url}function ye(e){return"video_versions"in e?e.video_versions:e.image_versions2.candidates}k.flow(ye,A);function ve(e){if(!("video_dash_manifest"in e))return m.none;const t=se(e.video_dash_manifest);if(c.isLeft(t))return console.error(t.left),m.none;const n=t.right;return n.warnings.length>0&&console.warn(n.warnings),m.some({type:"video",src:n.data.video.url,previewSrc:e.image_versions2.candidates[0].url})}function D(e){if("video_versions"in e){const n=ve(e);return m.isSome(n)?n.value:{type:"video",src:A(e.video_versions),previewSrc:e.image_versions2.candidates[0].url}}const t=A(e.image_versions2.candidates);return{type:"image",src:t,previewSrc:t}}function Se(e){return e.carousel_media.map(D)}const xe=e=>{const t=/(?<=window\.__additionalDataLoaded\(.*',).*(?=\);<)/.exec(e);if(!t)throw"__additionalDataLoaded not found on window";if(!Array.isArray(t))throw console.log(t),"dataText is not an array! (see above log what it actually is, i have no idea)";let n=JSON.parse(t[0]);if(!n.items)throw console.log(n),"items not found in dataObject (see above log)";const o=n.items;if(o.length===0)throw"items are empty";const r=o[0],i=r.user.username;let s=[],a=null;if("video_versions"in r&&(a="video",s.push(D(r))),"image_versions2"in r&&(a="image",s.push(D(r))),"carousel_media"in r&&(a="collection",s=Se(r)),s.length===0)throw"no media found";return{postType:a,mediaArray:s,username:i}};async function H(e){const n=await(await fetch(e)).text();return xe(n)}function Ee(){return document.querySelector("article").parentElement}function _(){return Array.from(Ee().children)}const Pe=e=>{const t=e.querySelectorAll('a[href*="/p/"'),n=t[t.length-1].href,o=n.indexOf("/p/")+3,r=n.indexOf("/",o);return n.substring(0,r+1)},j=e=>ge(e),be=e=>{if(e.querySelector('[class*="Chevron"]'))return"collection";const t=j(e);return t||(console.warn("no media-element found"),console.log(e.innerHTML)),t.tagName==="VIDEO"?"video":"image"};function Ae(e){const t=e.children[1],n=parseFloat(getComputedStyle(t).getPropertyValue("width")),r=e.parentElement.parentElement.getBoundingClientRect().x;for(let i=1;i<e.children.length;i++){const a=e.children[i].getBoundingClientRect().x;if(Math.abs(r-a)<n/2)return i-1}return-1}function De(e){const t=e.querySelector("ul"),n=Ae(t);return t.children[n+1]}function Ce(e,t){const n=t.poster;if(n==="")return console.warn("cannot find the position for this collection-element!"),null;const o=/^https:\/\/.*\.jpg/.exec(n)[0],r=e.findIndex(i=>i.previewSrc.includes(o));return r<0?(console.warn("poster does not match any previews, therefore cannot find the index for this item"),console.log(n,o,e),null):e[r]}function _e(e,t){let n="";const o=t.srcset;return o?n=U(o):n=t.src,{type:"image",src:n,previewSrc:""}}function Ie(e,t){const n=De(t),o=j(n);return o.matches("video")?Ce(e,o):_e(e,o)}function Be(e){let t=null,n=null;return async()=>{if(n||(n=be(e)),!t){const s=Pe(e);t=await H(s)}const o=t.username,r=t.mediaArray,i=n==="collection"?Ie(r,e):r[0];if(!i){console.error("could not find media of the current collection item!");return}return{username:o,...i}}}function Me(e){const t=e.getBoundingClientRect(),n=(t.top+t.bottom)/2;return Math.abs(n-window.innerHeight/2)}function $(){return _().reduce((n,o)=>{const r=Me(o);return r<n[0]?[r,o]:n},[1/0,null])[1]}const Te=e=>{const t=e.querySelector("video");if(t!==null){const n=Array.from(t.querySelectorAll("source")),o=["42","4D","64"],r=s=>o.findIndex(a=>s.type.includes(a)),i=(s,a)=>r(s)-r(a);return n.sort(i),n[n.length-1].src}else{const n=e.querySelector("img[srcset]");if(n!==null)return U(n.srcset)}return null};function Re(){const e=document.querySelector('meta[property="og:url"]');if(!e)return null;const n=e.content.match(/(?<=\.com\/).*(?=\/)/);return n?n[0]:null}function Oe(){const e=window.location.href;return e.startsWith("https://www.instagram.com/stories/highlights/")?Re():qe(e)}const qe=e=>/(?<=stories\/).*?(?=\/)/.exec(e)[0],g=new EventTarget,Le=e=>Array.from(e.querySelectorAll('a[href*="/p/"]')).filter(t=>t.querySelector("img")!=null).map(t=>t.parentElement),Ne=e=>e.tagName=="ARTICLE"?[e]:Array.from(e.querySelectorAll("article")),ke=e=>e.tagName=="SECTION"&&Array.from(e.children).findIndex(t=>t.tagName=="HEADER")>0?[e]:Array.from(e.querySelectorAll("header")).map(t=>t.parentElement);class E{constructor(t,n,o,r){this.onAdded=null,this.onRemoved=null,this.getContainedElements=null,this.elementType=null,this.onAdded=o,this.onRemoved=r,this.getContainedElements=n,this.elementType=t}matchesType(t){return t.includes(this.elementType)}}const Fe=[new E("post",Ne,je,$e),new E("preview",Le,Ue,He),new E("story",ke,Ve,Qe)];function p(e,t){g.dispatchEvent(new CustomEvent(e,{detail:{element:t}}))}function Ue(e){p("onPreviewAdded",e)}function He(e){p("onPreviewRemoved",e)}function je(e){p("onPostAdded",e)}function $e(e){p("onPostRemoved",e)}function Ve(e){p("onStoryAdded",e)}function Qe(e){p("onStoryRemoved",e)}function V(e,t){if(e.nodeType!=1)return;let n=b();for(let o of Fe)if(o.matchesType(n)){let r=o.getContainedElements(e),i=t?o.onAdded:o.onRemoved;r.forEach(i)}}function Q(e){V(e,!0)}function We(e){V(e,!1)}function ze(e){e.addedNodes.forEach(Q),e.removedNodes.forEach(We)}function Xe(e){e.forEach(ze)}function Ke(){var e=new MutationObserver(Xe);e.observe(document,{childList:!0,subtree:!0})}function Ye(){Q(document.body)}function Ge(){Ye(),Ke()}g.start=Ge;function W(e){return e.map(t=>`\\${t}`).join("|")}function Je(e){const t=W(e);return new RegExp(`[^/]*(${t})`)}function Ze(e,t){return new RegExp(W(e)).exec(t)!==null}const et=(e,t)=>n=>{const o=e.exec(n);if(o!==null){const r=o[0];return c.right(r)}return Ze(t,n)?c.left(`could not extract a filename from the url '${n}' although it appears to contain a valid file-extension.`):c.left(`the url '${n}' does not contain any of the expected file-extensions: ${t.join(", ")}`)},tt=e=>et(Je(e),e),nt=tt([".mp4",".jpg",".webp",".webm"]),ot=(e,t)=>new Promise((n,o)=>{const r=chrome.runtime.connect({name:"chrome-downloader"});let i=null;const s=()=>{r.postMessage({type:"request-state",id:i})};r.onMessage.addListener(a=>{if(a.type==="download-id"){i=a.id,s();return}if(a.type==="error"){o(a.error),r.disconnect();return}if(a.type==="success"){n(),r.disconnect();return}if(a.type==="progress"){t(a.progress.progress),s();return}}),r.postMessage({type:"request-download",filePath:e.filePath,url:e.url})}),rt=(e,t)=>{const n={requests:[{action:"write media by link",data:e}],time:window.performance.now()};let o=null,r=null;const i=new Promise((a,l)=>{o=a,r=l}),s=chrome.runtime.connect({name:"disk-downloader"});return s.onMessage.addListener((a,l)=>{if(a.origin==="native host disconnect"){r(a.data);return}else if(a.origin==="native host response"){const d=a.data[0],f=d.type;if(f==="success"){o();return}else if(f==="error"){r(d.data);return}else f==="progress"&&t(d.data.progress)}a.data[0].type==="success"&&s.disconnect()}),s.postMessage(n),i},it=(e,t,n)=>{const o=n.directoryRules||[];o.reverse();const r=n.baseDownloadDirectory||"",i=[...o,{baseDirectory:r}];for(let s of i){const a=s.username||[],l=s.downloadAs||[],u=s.baseDirectory||"",d=s.folderPath||"";if(!((a.length===0||a.includes(e))&&(l.length===0||l.includes(t))))continue;let h=null;if(u!==""&&(h=`${u}/${e}`),d!==""&&(h=d),h!==null)return h}},st=async e=>new Promise((t,n)=>{chrome.storage.sync.get({baseDownloadDirectory:"",directoryRules:[]},o=>{const r=it(e.userName,e.ownUserName,o);r?t(r):n("no path found. have you set a path in the extension-options?")})});function C(e){return chrome.runtime.getURL(`assets/icons/${e}.png`)}const q={initial:"save",loading:"spinner-of-dots",success:"verify-sign-green",fail:"error"};class at{constructor(){this._downloadState="initial",this._loadingProgress=0,this._spinnerCtx=null,this._spinnerCanvas=null,this._buttonImg=null,this._rootElement=null,this._rootElement=document.createElement("a"),this._rootElement.classList.add("download-button"),Object.assign(this._rootElement.style,{width:"fit-content",height:"fit-content",cursor:"pointer"}),this._buttonImg=document.createElement("img"),Object.assign(this._buttonImg.style,{width:"inherit",height:"inherit"}),this._rootElement.appendChild(this._buttonImg),this._setInitialState()}get downloadState(){return this._downloadState}set downloadState(t){this._downloadState=t,this._onDownloadStateChanged()}get loadingProgress(){return this._loadingProgress}set loadingProgress(t){this._loadingProgress=t,this._downloadState==="loading"&&this._drawSpinner()}getElement(){return this._rootElement}_setInitialState(){let n=b()[0]=="post"?"dark":"white";const o=`${q.initial}-${n}`;this._buttonImg.src=C(o)}_onDownloadStateChanged(){const t=this._downloadState;if(t==="loading")this._spinnerCanvas||(this._spinnerCanvas=document.createElement("canvas"),this._spinnerCtx=this._spinnerCanvas.getContext("2d"),this._drawSpinner());else{this._spinnerCanvas=null,this._spinnerCtx=null;let n=q[t];t==="initial"&&(n+=`-${b()[0]=="post"?"dark":"white"}`),this._buttonImg.src=C(n)}}_drawSpinner(){const t=this._spinnerCtx,n=this._loadingProgress,o=32;Object.assign(this._spinnerCanvas,{width:o,height:o}),t.clearRect(0,0,o,o),t.lineWidth=4;const r=(o-t.lineWidth)/2;t.strokeStyle="cyan",t.lineCap="round",t.beginPath();const i=o/2,s=-Math.PI/2;t.arc(i,i,r,s,s+n*2*Math.PI),t.stroke(),this._buttonImg.src=this._spinnerCanvas.toDataURL()}}const ct="chrome-background",dt=()=>new Promise((e,t)=>{chrome.storage.sync.get({downloadMethod:ct},n=>{if(chrome.runtime.lastError){t(chrome.runtime.lastError.message);return}e(n.downloadMethod)})}),lt=async(e,t)=>{const n=await dt(),o=e.src,r=nt(o);if(c.isLeft(r))throw r.left;const i=r.right;if(n==="native"){const s=he(),a=await st({mediaSrc:o,userName:e.username,ownUserName:s});await rt({link:o,folderPath:a,fileName:i},t)}else n==="chrome-background"&&await ot({filePath:`Instagram/${e.username}/${i}`,url:o},t)},ut=async(e,t)=>{let n=null;try{n=await e(),await lt(n,t)}catch(o){console.error(o);const r=n?`${o}, 
 user: ${n.username}, 
 src: ${n.src}`:o;throw chrome.runtime.sendMessage({type:"show-notification",notification:{title:"download failed",message:r,iconUrl:C("insta-loader-icon-48")}}),o}},I=(e,t={})=>{t={onDownloadStart:()=>{},onDownloadEnd:()=>{},...t};const n=new at,o=n.getElement(),r=async()=>{n.downloadState="loading";const i=s=>n.loadingProgress=s;t.onDownloadStart();try{await ut(e,i),n.downloadState="success"}catch{n.downloadState="fail"}t.onDownloadEnd()};return o.addEventListener("download-request",r),o.addEventListener("mousedown",r),o},B=e=>{const t=document.createElement("div");return t.innerHTML=e,t.firstElementChild};function ft(e,t){let n=t;for(let o=0;o<1e3;o++){if(n.matches(e))return n;n=n.parentElement}return null}const ht=e=>e.querySelector("section"),mt=e=>{const t=e.querySelector("section");if(!t){console.warn("section with buttons not found");return}const n=Array.from(t.querySelectorAll("svg"));return n[n.length-1]},gt=e=>{const t=mt(e),n=t.parentElement,o=t.clientHeight+"px",r=getComputedStyle(n).getPropertyValue("padding");return{width:o,height:o,padding:r}},pt=(e,t)=>{Object.assign(t.style,gt(e))},wt=e=>{const t=ht(e),n=B(`
		<div 
			style="
				display: flex; 
				flex-direction: row;
				padding: 8px;
				padding-right: 0px;
				margin-left: 10px;
			"
		></div>
	`),o=Be(e),r=I(o);pt(e,r),n.appendChild(r),t.insertAdjacentElement("beforeend",n)},yt=async e=>{const t=e.querySelector("a");if(t===null)throw"link-element not found";let n=t.href;const o=await H(n);let r=o.mediaArray[0].src;return{username:o.username,src:r}},vt=e=>{const t=B(`
		<div style="
				width: 100%;
				position: absolute;
				left: 0px;
				bottom: 0px;
				flex-direction: row;"
		>
		</div>
	`),o=I(()=>yt(e));Object.assign(o.style,{width:"24px",height:"24px",padding:"5px"}),t.appendChild(o),e.appendChild(t)},z="Enter";function X(e){e.dispatchEvent(new CustomEvent("download-request"))}function St(e){return e.querySelector(".download-button")}function xt(){const e=$();if(!e){console.warn("could not find current post");return}const t=St(e);if(!t){console.warn("could not find download-button");return}X(t)}document.addEventListener("keydown",e=>{e.key===z&&xt()});const Et=e=>{try{const t=Te(e),n=Oe();return Promise.resolve({src:t,username:n})}catch(t){return Promise.reject(t)}},Pt=()=>{let e=!1;const t=document.querySelector("video");return{keepPaused:()=>{e=!0;const r=()=>{t.paused||t.pause(),e&&window.requestAnimationFrame(r)};r()},continue:()=>{e=!1}}};function bt(){return document.querySelector("header svg")}function At(){const e=bt();if(!e){console.warn("could not add download-button in story. the svg for the pause/play button could not be found");return}const t=ft("button",e);if(!t){console.warn("could not add download-button in story. the svg for the pause/play button has not button as an ancestor");return}return t}const Dt=e=>{const t=B(`
		<div style="margin-right: 20px;"></div>
	`),n=(()=>{let s=null;return{onDownloadStart:()=>{document.querySelector("video")&&(s=Pt(),s.keepPaused())},onDownloadEnd:()=>{!s||s.continue()}}})(),o=I(()=>Et(e),n);t.appendChild(o),At().parentElement.insertAdjacentElement("afterbegin",t),document.addEventListener("keypress",s=>{s.key===z&&X(o)})};g.addEventListener("onPostAdded",e=>{wt(e.detail.element)});g.addEventListener("onPreviewAdded",e=>{vt(e.detail.element)});g.addEventListener("onStoryAdded",e=>{Dt(e.detail.element)});g.start();const K=30;function M(e){const n=e.querySelector("section").getBoundingClientRect().bottom;return window.innerHeight-n}function Ct(e,t){return M(e)<-K}function _t(e,t){return M(e)>K}function It(){return _().find(Ct)}function Bt(){return _().reverse().find(_t)}function L(e){const t=e();if(!t){console.warn("could not find post to scroll to");return}const n=-M(t),o=window.scrollY+n;window.scrollTo({left:window.scrollX,top:o,behavior:"smooth"})}const Mt="w",Tt="s";document.addEventListener("keydown",e=>{e.key===Mt?L(Bt):e.key===Tt&&L(It)});const Rt={a:"left",d:"right"},Ot={left:"LeftChevron",right:"RightChevron"};function qt(e){const t=y();console.log(t);const n=t==="stories"?document.body:$();if(!n){console.warn("could not find current-element");return}const o=Ot[e],r=n.querySelector(`[class*="${o}"]`);if(!r){console.warn("could not find navigation-element");return}r.parentElement.click()}document.addEventListener("keydown",e=>{const t=Rt[e.key];!t||qt(t)});
