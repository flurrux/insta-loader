import{_ as W,E as g,O as h}from"./vendor.a19b4b9f.js";const p=[];function V(){return p.length===0?null:p[0]}chrome.runtime.onMessage.addListener(function(e){const{url:t}=e;!t||p.includes(t)||p.push(t)});const m={mainFeed:"mainFeed",post:"post",personFeed:"personFeed",stories:"stories"},P=()=>{let e=window.location.href;return e.endsWith("instagram.com/")||e.includes(".com/?")?m.mainFeed:e.includes("/p/")?m.post:e.includes("/reel/")?"reel":e.includes("/stories/")?m.stories:m.personFeed};P();document.querySelector("#mount_0_0_8N");const E=()=>{const e=P();return e==="personFeed"?["preview"]:e==="stories"?["story"]:["post"]},u=new EventTarget;function A(e){return e.map(t=>t.parentElement).filter(t=>t!==null)}const Q=W.flow(e=>e.querySelectorAll('a[href*="/p/"]'),Array.from,A);function z(e){return e.tagName=="ARTICLE"?[e]:Array.from(e.querySelectorAll("article"))}function X(e){return e.tagName=="SECTION"&&Array.from(e.children).findIndex(t=>t.tagName=="HEADER")>0?[e]:A(Array.from(e.querySelectorAll("header")))}const _=(e,t)=>{u.dispatchEvent(new CustomEvent(e,{detail:{element:t}}))};class w{constructor(t,n){this.getContainedElements=n,this.elementType=t}matchesType(t){return t.includes(this.elementType)}buildEventName(t){const n=this.elementType;return`on${n[0].toUpperCase()+n.slice(1)}${t}`}onAdded(t){_(this.buildEventName("Added"),t)}onRemoved(t){_(this.buildEventName("Removed"),t)}}const G=[new w("post",z),new w("preview",Q),new w("story",X)];function I(e,t){if(e.nodeType!=1)return;let n=E();for(let o of G)if(o.matchesType(n)){let r=o.getContainedElements(e),i=t?o.onAdded.bind(o):o.onRemoved.bind(o);r.forEach(i)}}function M(e){e instanceof HTMLElement&&I(e,!0)}function K(e){e instanceof HTMLElement&&I(e,!1)}function Y(e){e.addedNodes.forEach(M),e.removedNodes.forEach(K)}function J(e){e.forEach(Y)}function Z(){var e=new MutationObserver(J);e.observe(document,{childList:!0,subtree:!0})}function ee(){M(document.body)}function te(){ee(),Z()}u.start=te;const B=e=>{const t=document.createElement("div");return t.innerHTML=e,t.firstElementChild};function ne(e,t){let n=t;for(let o=0;o<1e3;o++){if(n.matches(e))return n;n=n.parentElement}return null}function N(e){return e.map(t=>`\\${t}`).join("|")}function oe(e){const t=N(e);return new RegExp(`[^/]*(${t})`)}function re(e,t){return new RegExp(N(e)).exec(t)!==null}const se=(e,t)=>n=>{const o=e.exec(n);if(o!==null){const r=o[0];return g.right(r)}return re(t,n)?g.left(`could not extract a filename from the url '${n}' although it appears to contain a valid file-extension.`):g.left(`the url '${n}' does not contain any of the expected file-extensions: ${t.join(", ")}`)},ie=e=>se(oe(e),e),le=ie([".mp4",".jpg",".webp",".webm"]);function ce(){const e=/(?<="username":")[^"]*/.exec(document.body.innerHTML);return e?e[0]:null}const ae=(e,t)=>new Promise((n,o)=>{const r=chrome.runtime.connect({name:"chrome-downloader"});let i=null;const s=()=>{r.postMessage({type:"request-state",id:i})};r.onMessage.addListener(l=>{if(l.type==="download-id"){i=l.id,s();return}if(l.type==="error"){o(l.error),r.disconnect();return}if(l.type==="success"){n(),r.disconnect();return}if(l.type==="progress"){t(l.progress.progress),s();return}}),r.postMessage({type:"request-download",filePath:e.filePath,url:e.url})}),ue=(e,t)=>{const n={requests:[{action:"write media by link",data:e}],time:window.performance.now()};let o=null,r=null;const i=new Promise((l,a)=>{o=l,r=a}),s=chrome.runtime.connect({name:"disk-downloader"});return s.onMessage.addListener((l,a)=>{if(l.origin==="native host disconnect"){r(l.data);return}else if(l.origin==="native host response"){const c=l.data[0],d=c.type;if(d==="success"){o();return}else if(d==="error"){r(c.data);return}else d==="progress"&&t(c.data.progress)}l.data[0].type==="success"&&s.disconnect()}),s.postMessage(n),i},de=(e,t,n)=>{const o=n.directoryRules||[];o.reverse();const r=n.baseDownloadDirectory||"",i=[...o,{baseDirectory:r}];for(let s of i){const l=s.username||[],a=s.downloadAs||[],y=s.baseDirectory||"",c=s.folderPath||"";if(!((l.length===0||l.includes(e))&&(a.length===0||a.includes(t))))continue;let f=null;if(y!==""&&(f=`${y}/${e}`),c!==""&&(f=c),f!==null)return f}},fe=async e=>new Promise((t,n)=>{chrome.storage.sync.get({baseDownloadDirectory:"",directoryRules:[]},o=>{const r=de(e.userName,e.ownUserName,o);r?t(r):n("no path found. have you set a path in the extension-options?")})});function S(e){return chrome.runtime.getURL(`assets/icons/${e}.png`)}const T={initial:"save",loading:"spinner-of-dots",success:"verify-sign-green",fail:"error"};class me{constructor(){this._downloadState="initial",this._loadingProgress=0,this._spinnerCtx=null,this._spinnerCanvas=null,this._buttonImg=null,this._rootElement=null,this._rootElement=document.createElement("a"),this._rootElement.classList.add("download-button"),Object.assign(this._rootElement.style,{width:"fit-content",height:"fit-content",cursor:"pointer"}),this._buttonImg=document.createElement("img"),Object.assign(this._buttonImg.style,{width:"inherit",height:"inherit"}),this._rootElement.appendChild(this._buttonImg),this._setInitialState()}get downloadState(){return this._downloadState}set downloadState(t){this._downloadState=t,this._onDownloadStateChanged()}get loadingProgress(){return this._loadingProgress}set loadingProgress(t){this._loadingProgress=t,this._downloadState==="loading"&&this._drawSpinner()}getElement(){return this._rootElement}_setInitialState(){let n=E()[0]=="post"?"dark":"white";const o=`${T.initial}-${n}`;this._buttonImg.src=S(o)}_onDownloadStateChanged(){const t=this._downloadState;if(t==="loading")this._spinnerCanvas||(this._spinnerCanvas=document.createElement("canvas"),this._spinnerCtx=this._spinnerCanvas.getContext("2d"),this._drawSpinner());else{this._spinnerCanvas=null,this._spinnerCtx=null;let n=T[t];t==="initial"&&(n+=`-${E()[0]=="post"?"dark":"white"}`),this._buttonImg.src=S(n)}}_drawSpinner(){const t=this._spinnerCtx,n=this._loadingProgress,o=32;Object.assign(this._spinnerCanvas,{width:o,height:o}),t.clearRect(0,0,o,o),t.lineWidth=4;const r=(o-t.lineWidth)/2;t.strokeStyle="cyan",t.lineCap="round",t.beginPath();const i=o/2,s=-Math.PI/2;t.arc(i,i,r,s,s+n*2*Math.PI),t.stroke(),this._buttonImg.src=this._spinnerCanvas.toDataURL()}}const ge="chrome-background",he=()=>new Promise((e,t)=>{chrome.storage.sync.get({downloadMethod:ge},n=>{if(chrome.runtime.lastError){t(chrome.runtime.lastError.message);return}e(n.downloadMethod)})}),pe=async(e,t)=>{const n=await he(),o=e.src,r=le(o);if(g.isLeft(r))throw r.left;const i=r.right;if(n==="native"){const s=ce(),l=await fe({mediaSrc:o,userName:e.username,ownUserName:s});await ue({link:o,folderPath:l,fileName:i},t)}else n==="chrome-background"&&await ae({filePath:`Instagram/${e.username}/${i}`,url:o},t)},ye=async(e,t)=>{let n=null;try{n=await e(),await pe(n,t)}catch(o){console.error(o);const r=n?`${o}, 
 user: ${n.username}, 
 src: ${n.src}`:o;throw chrome.runtime.sendMessage({type:"show-notification",notification:{title:"download failed",message:r,iconUrl:S("insta-loader-icon-48")}}),o}},k=(e,t={})=>{t={onDownloadStart:()=>{},onDownloadEnd:()=>{},...t};const n=new me,o=n.getElement(),r=async()=>{n.downloadState="loading";const i=s=>n.loadingProgress=s;t.onDownloadStart();try{await ye(e,i),n.downloadState="success"}catch{n.downloadState="fail"}t.onDownloadEnd()};return o.addEventListener("download-request",r),o.addEventListener("mousedown",r),o};function we(e){return Array.from(e.querySelectorAll("img")).find(t=>t.offsetHeight>400)}function b(e){const t=e.querySelector("video, img[srcset]");return t||we(e)}function ve(e){const t=e.split(" ");return{src:t[0],quality:parseInt(t[1])}}function Ee(e){return e.split(",").map(ve)}function L(e){const t=Ee(e);let n=0;for(let o=1;o<t.length;o++)t[o].quality>t[n].quality&&(n=o);return t[n].src}function Se(e){return e.srcset.length===0?e.src:L(e.srcset)}function O(e){const t=e.tagName==="VIDEO"?"video":"image",n=t==="image"?Se(e):e.src;return{type:t,src:n}}function Pe(e){const t=e.parentElement;if(!t)return null;const n=t.parentElement;return n||null}function be(e){const t=Pe(e);if(!t)return null;const n=e.children[1],o=parseFloat(getComputedStyle(n).getPropertyValue("width")),r=t.getBoundingClientRect().x;for(let i=1;i<e.children.length;i++){const l=e.children[i].getBoundingClientRect().x;if(Math.abs(r-l)<o/2)return i-1}return-1}function Ce(e){const t=e.querySelector("ul");if(t===null)return null;const n=be(t);return n===null?null:{list:t,index:n}}function xe(e){const t=Ce(e);if(!t)return console.warn("could not find the current index of carousel"),null;const{index:n,list:o}=t,r=o.children[n+1],i=b(r);return i?O(i):(console.warn("could not find any media element in carousel at index "+n,r),null)}function _e(e,t){let n=t;for(let o=0;o<1e3;o++){if(n.matches("li"))return!0;if(n===e)return!1;const r=n.parentElement;if(!r)return!1;n=r}return!1}function F(e){const t=b(e);return t?_e(e,t)?"carousel":t.tagName==="VIDEO"?"video":"image":(console.warn("no media-element found"),console.log(e.innerHTML),null)}function R(e){const t=e.querySelector("header a").href,n=/(?<=\.com\/).*(?=\/)/.exec(t);return n?n[0]:null}function Te(e){const t=b(e);return t?O(t):(console.log("could not find any media element in post",e),null)}function De(e){const t=R(e);if(!t)return console.warn("could not username from post"),null;const n=F(e);if(!n)return console.warn("could not find type of post"),null;const o=n==="carousel"?xe(e):Te(e);return o?{username:t,...o}:(console.warn("could not find media-src of post"),null)}function qe(e){const t=e.querySelector("section");if(!t)return console.warn("trying to find bar with like-button, save-button, etc. in order to inject the download-button, but cannot find it!"),null;const n=Array.from(t.querySelectorAll("svg"));return n.length===0?null:n[n.length-1]}const Ae=e=>{const t=qe(e);if(!t)return null;const n=t.parentElement;if(!n)return null;const o=t.clientHeight+"px",r=getComputedStyle(n).getPropertyValue("padding");return{width:o,height:o,padding:r}},Ie=(e,t)=>{Object.assign(t.style,Ae(e))},Me=e=>{const t=F(e);if(console.log(t),t==="video"){const o=V();if(console.log(o),!o)return Promise.reject("no video-url collected so far");const r=R(e);return r?Promise.resolve({src:o,username:r}):Promise.reject("couldn't find username in post")}const n=De(e);return n?Promise.resolve(n):Promise.reject("media-src not found")};function Be(e){const t=e.querySelector("section");if(!t){console.warn("trying to inject download buttons into post, but cannot find any child with tag 'Section'");return}const n=B(`
		<div 
			style="
				display: flex; 
				flex-direction: row;
				padding: 8px;
				padding-right: 0px;
				margin-left: 10px;
			"
		></div>
	`),r=k(()=>Me(e));Ie(e,r),n.appendChild(r),t.insertAdjacentElement("beforeend",n)}function Ne(e){return e?e[0]:null}function ke(e){const t=e.querySelector("video");if(t===null)return;const n=Array.from(t.querySelectorAll("source")),o=["42","4D","64"],r=s=>o.findIndex(l=>s.type.includes(l)),i=(s,l)=>r(s)-r(l);return n.sort(i),n[n.length-1].src}function Le(e){const t=ke(e);if(t)return t;const n=e.querySelector("img[srcset]");return n!==null?L(n.srcset):null}function Oe(){const e=document.querySelector('meta[property="og:url"]');if(!e)return null;const n=e.content.match(/(?<=\.com\/).*(?=\/)/);return n?n[0]:null}function Fe(){const e=window.location.href;return e.startsWith("https://www.instagram.com/stories/highlights/")?Oe():Re(e)}function Re(e){return Ne(/(?<=stories\/).*?(?=\/)/.exec(e))}function Ue(){return document.querySelector("article")?.parentElement}function C(){const e=Ue();return e?Array.from(e.children):[]}function $e(e){const t=e.getBoundingClientRect(),n=(t.top+t.bottom)/2;return Math.abs(n-window.innerHeight/2)}function U(){const e=C();return e.length===0?null:e.reduce((n,o)=>{const r=$e(o);return r<n[0]?[r,o]:n},[1/0,null])[1]}const $="Enter";function j(e){e.dispatchEvent(new CustomEvent("download-request"))}function je(e){return e.querySelector(".download-button")}function He(){const e=U();if(!e){console.warn("download by shortcut: could not find the currently visible post to download");return}const t=je(e);if(t===null){console.warn("download by shortcut: found the currently visible post, but there seems to be no download button. are you sure it's there?");return}j(t)}document.addEventListener("keydown",e=>{e.key===$&&He()});const We=e=>{try{const t=Le(e),n=Fe();return Promise.resolve({src:t,username:n})}catch(t){return Promise.reject(t)}},Ve=()=>{let e=!1;const t=document.querySelector("video");return{keepPaused:()=>{e=!0;const r=()=>{t.paused||t.pause(),e&&window.requestAnimationFrame(r)};r()},continue:()=>{e=!1}}};function Qe(){return document.querySelector("header svg")}function ze(){const e=Qe();if(!e){console.warn("could not add download-button in story. the svg for the pause/play button could not be found");return}const t=ne("button",e);if(!t){console.warn("could not add download-button in story. the svg for the pause/play button has not button as an ancestor");return}return t}const Xe=e=>{const t=B(`
		<div style="margin-right: 20px;"></div>
	`),n=(()=>{let s=null;return{onDownloadStart:()=>{document.querySelector("video")&&(s=Ve(),s.keepPaused())},onDownloadEnd:()=>{!s||s.continue()}}})(),o=k(()=>We(e),n);t.appendChild(o),ze().parentElement.insertAdjacentElement("afterbegin",t),document.addEventListener("keypress",s=>{s.key===$&&j(o)})};u.addEventListener("onPostAdded",e=>{Be(e.detail.element)});u.addEventListener("onStoryAdded",e=>{Xe(e.detail.element)});u.start();const H=30;function x(e){const t=e.querySelector("section");if(t===null)return console.warn("trying to calculate distance to bottom, cannot find a 'section' element in post"),h.none;const n=t.getBoundingClientRect().bottom,o=window.innerHeight;return h.some(o-n)}function Ge(e){const t=x(e);return h.isNone(t)?!1:t.value<-H}function Ke(e){const t=x(e);return h.isNone(t)?!1:t.value>H}function Ye(){return C().find(Ge)}function Je(){return C().reverse().find(Ke)}function D(e){const t=e();if(!t){console.warn("could not find post to scroll to");return}const n=-x(t),o=window.scrollY+n;window.scrollTo({left:window.scrollX,top:o,behavior:"smooth"})}function Ze(){const e={"scroll-up":"w","scroll-down":"s"};document.addEventListener("keydown",t=>{t.key===e["scroll-up"]?D(Je):t.key===e["scroll-down"]&&D(Ye)})}Ze();const q={a:"left",d:"right"},et={left:"LeftChevron",right:"RightChevron"};function v(){console.warn("you've tried to navigate to the next or previous image/video but we couldn't find the button to click on")}function tt(e){const n=P()==="stories"?document.body:U();if(!n){v();return}const o=et[e],r=n.querySelector(`[class*="${o}"]`);if(!r){v();return}const i=r.parentElement;if(!i){v();return}i.click()}document.addEventListener("keydown",e=>{const{key:t}=e;t in q&&tt(q[t])});
