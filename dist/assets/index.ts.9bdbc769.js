import{f as _,i as T,a as q,n as f,s as p,p as y,r as l,l as u,b as C,c as d,d as U,e as g,g as Y,h as Pe,j as Ce,k as J,O as Z,m as De,t as Ae,o as Be,q as Me,u as ke}from"./vendor.a8b559c9.js";const I={mainFeed:"mainFeed",post:"post",personFeed:"personFeed",stories:"stories"},w=()=>{let e=window.location.href;return e.endsWith("instagram.com/")||e.includes(".com/?")?I.mainFeed:e.includes("/p/")?I.post:e.includes("/reel/")?"reel":e.includes("/stories/")?I.stories:I.personFeed},_e=e=>e==="post"||e==="reel";w();document.querySelector("#mount_0_0_8N");const M=()=>{const e=w();return e==="personFeed"?["preview"]:e==="stories"?["story"]:["post"]},x=new EventTarget;function ee(e){return e.map(t=>t.parentElement).filter(t=>t!==null)}const Te=_(e=>e.querySelectorAll('a[href*="/p/"]'),Array.from,ee);function qe(e){if(w()==="mainFeed"){if(e.tagName=="ARTICLE")return[e];const t=Array.from(e.querySelectorAll("article"));if(t.length>0)return t}else return e.tagName=="MAIN"?[e]:Array.from(e.querySelectorAll("main"));return[]}function Oe(e){return e.tagName=="SECTION"&&Array.from(e.children).findIndex(t=>t.tagName=="HEADER")>0?[e]:ee(Array.from(e.querySelectorAll("header")))}const $=(e,t)=>{x.dispatchEvent(new CustomEvent(e,{detail:{element:t}}))};class A{constructor(t,n){this.getContainedElements=n,this.elementType=t}matchesType(t){return t.includes(this.elementType)}buildEventName(t){const n=this.elementType;return`on${n[0].toUpperCase()+n.slice(1)}${t}`}onAdded(t){$(this.buildEventName("Added"),t)}onRemoved(t){$(this.buildEventName("Removed"),t)}}const Fe=[new A("post",qe),new A("preview",Te),new A("story",Oe)];function te(e,t){if(e.nodeType!=1)return;let n=M();for(let r of Fe){if(!r.matchesType(n))continue;let o=r.getContainedElements(e),i=t?r.onAdded.bind(r):r.onRemoved.bind(r);o.forEach(i)}}function ne(e){e instanceof HTMLElement&&te(e,!0)}function Ne(e){e instanceof HTMLElement&&te(e,!1)}function Re(e){e.addedNodes.forEach(ne),e.removedNodes.forEach(Ne)}function Le(e){e.forEach(Re)}function He(){var e=new MutationObserver(Le);e.observe(document,{childList:!0,subtree:!0})}function Ue(){ne(document.body)}function $e(){Ue(),He()}x.start=$e;function je(e){return new Promise(t=>setTimeout(t,e))}async function We(e,t,n){for(let r=0;r<t;r++){const o=n();if(T(o))return o.value;await je(e)}throw"attempt was unsuccessful"}function Ve(e,t){return q(e.querySelector(t))}async function re(e,t,n,r){return We(e,t,()=>Ve(n,r))}const O=e=>{const t=document.createElement("div");return t.innerHTML=e,t.firstElementChild};function oe(e,t){return()=>{window.setTimeout(e,t)}}function F(e){return e?e[0]:null}function ze(e){return e?p(e[0]):f}const Qe=e=>_(t=>e.exec(t),ze);function Xe(e){const t=e.parentElement;if(!t)return null;const n=t.parentElement;return n||null}function Ge(e,t){const n=F(/(?<=translateX\()[\d\.]*(?=px)/.exec(t.style.transform));return n?Math.round(parseFloat(n)/e):null}function ie(e){const t=Xe(e);if(!t)return null;const n=t.getBoundingClientRect().x,r=1,o=e.children[r],i=parseFloat(getComputedStyle(o).getPropertyValue("width"));for(let s=r;s<e.children.length;s++){const a=e.children[s],c=a.getBoundingClientRect().x;if(Math.abs(n-c)>i/2)continue;const h=Ge(i,a);if(h!==null)return{index:h,child:a}}return null}function Ke(e){const t=e.querySelector("ul");if(!t)return null;const n=ie(t);return n?{list:t,...n}:null}function se(e,t){let n=-1;const r=oe(()=>{const i=ie(e);if(!i){console.warn("could not find index and child of carousel!");return}i.index!==n&&(n=i.index,t(i))},100);new MutationObserver(r).observe(e,{childList:!0,subtree:!0}),r()}function Ye(e){return y(e.querySelectorAll("img"),Array.from,t=>t.find(n=>n.naturalWidth>400))}function S(e){return e.querySelector("video")??Ye(e)}function Je(e){const t=e.querySelectorAll('a[href*="/p/"');if(t.length===0)return null;const n=t[t.length-1].href,r=n.indexOf("/p/");if(r<0)return null;const o=r+3,i=n.indexOf("/",o);return i<0?null:n.substring(0,i+1)}function Ze(e,t){let n=t;for(let r=0;r<1e3;r++){if(n.matches("li"))return!0;if(n===e)return!1;const o=n.parentElement;if(!o)return!1;n=o}return!1}function k(e){const t=S(e);return t?Ze(e,t)?p("collection"):p(t.tagName==="VIDEO"?"video":"image"):f}function ae(e){return e.map(t=>`\\${t}`).join("|")}function et(e){const t=ae(e);return new RegExp(`[^/]*(${t})`)}function tt(e,t){return new RegExp(ae(e)).exec(t)!==null}const nt=(e,t)=>n=>{const r=e.exec(n);if(r!==null){const o=r[0];return l(o)}return tt(t,n)?u(`could not extract a filename from the url '${n}' although it appears to contain a valid file-extension.`):u(`the url '${n}' does not contain any of the expected file-extensions: ${t.join(", ")}`)},rt=e=>nt(et(e),e),ot=rt([".mp4",".jpg",".webp",".webm",".heic"]),it=(e,t)=>new Promise((n,r)=>{const o=C.exports.runtime.connect({name:"chrome-downloader"});let i=null;const s=()=>{o.postMessage({type:"request-state",id:i})};o.onMessage.addListener(a=>{if(a.type==="download-id"){i=a.id,s();return}if(a.type==="error"){r(a.error),o.disconnect();return}if(a.type==="success"){n(),o.disconnect();return}if(a.type==="progress"){t(a.progress.progress),s();return}}),o.postMessage({type:"request-download",filePath:e.filePath,url:e.url})});function P(e){return C.exports.runtime.getURL(`assets/icons/${e}.png`)}const j={initial:"save",loading:"spinner-of-dots",success:"verify-sign-green",fail:"error"};class st{constructor(){this._downloadState="initial",this._loadingProgress=0,this._spinnerCtx=null,this._spinnerCanvas=null,this._buttonImg=null,this._rootElement=null,this._rootElement=document.createElement("a"),this._rootElement.classList.add("download-button"),Object.assign(this._rootElement.style,{width:"fit-content",height:"fit-content",cursor:"pointer"}),this._buttonImg=document.createElement("img"),Object.assign(this._buttonImg.style,{width:"inherit",height:"inherit"}),this._rootElement.appendChild(this._buttonImg),this._setInitialState()}get downloadState(){return this._downloadState}set downloadState(t){this._downloadState=t,this._onDownloadStateChanged()}get loadingProgress(){return this._loadingProgress}set loadingProgress(t){this._loadingProgress=t,this._downloadState==="loading"&&this._drawSpinner()}getElement(){return this._rootElement}_setInitialState(){let n=M()[0]=="post"?"dark":"white";const r=`${j.initial}-${n}`;this._buttonImg.src=P(r)}_onDownloadStateChanged(){const t=this._downloadState;if(t==="loading")this._spinnerCanvas||(this._spinnerCanvas=document.createElement("canvas"),this._spinnerCtx=this._spinnerCanvas.getContext("2d"),this._drawSpinner());else{this._spinnerCanvas=null,this._spinnerCtx=null;let n=j[t];t==="initial"&&(n+=`-${M()[0]=="post"?"dark":"white"}`),this._buttonImg.src=P(n)}}_drawSpinner(){const t=this._spinnerCtx,n=this._loadingProgress,r=32;Object.assign(this._spinnerCanvas,{width:r,height:r}),t.clearRect(0,0,r,r),t.lineWidth=4;const o=(r-t.lineWidth)/2;t.strokeStyle="cyan",t.lineCap="round",t.beginPath();const i=r/2,s=-Math.PI/2;t.arc(i,i,o,s,s+n*2*Math.PI),t.stroke(),this._buttonImg.src=this._spinnerCanvas.toDataURL()}}async function at(e){const{mediaInfo:t,loadingCallback:n}=e,r=t.src,o=ot(r);if(d(o))return o;const i=o.right;return await it({filePath:`Instagram/${t.username}/${i}`,url:r},n),l(void 0)}function W(e){C.exports.runtime.sendMessage({type:"show-notification",notification:{title:"download failed",message:e,iconUrl:P("insta-loader-icon-48")}})}async function ut(e){const{fetchMediaInfo:t,loadingCallback:n}=e,r=await t();if(d(r))return console.error(r.left),W("something went wrong while trying to fetch the image or video. sorry for this vague message. i'm trying to provide better messages in future releases."),!1;const o=r.right,i=await at({mediaInfo:o,loadingCallback:n});if(d(i)){const s=i.left;return console.error(s),W(`we've successfully figured out the download url and username, but the download failed anyway. not exactly sure why. i will try to include the exact reason soon. you may want to try downloading this file on your own. here's the url:
${o.src}
username: ${o.username}`),!1}return!0}const ue=e=>{const{fetchMediaInfo:t,onDownloadStart:n=U,onDownloadEnd:r=U}=e,o=new st,i=o.getElement(),s=async()=>{o.downloadState="loading";const a=h=>{o.loadingProgress=h};n(void 0);const c=await ut({fetchMediaInfo:t,loadingCallback:a});o.downloadState=c?"success":"fail",r(c)};return i.addEventListener("download-request",s),i.addEventListener("mousedown",s),i};function ct(e){return O(`
		<div 
			style="
				display: flex; 
				flex-direction: row;
				padding: 8px;
				padding-right: 0px;
				margin-left: 10px;
			"
		>
			<a 
				href="${e}"
				style="width: fit-content; height: fit-content; cursor: pointer;"
			>
				<img 
					style="width: inherit; height: inherit;"
					src="${P("external-link-white")}"
				/>
			</a>
		</div>
	`)}function ce(e,t){let n=t;for(let r=0;r<1e3;r++){if(e(n))return p(n);const o=n.parentElement;if(!o)return f;n=o}return f}function lt(e){const t=e.querySelector('img[alt*="profile picture"]');if(!t)return u(["could not find the authors username in this post",e]);const r=t.getAttribute("alt").replace("'s profile picture","");return l(r)}function dt(e){const t=e.split(" ");return{src:t[0],quality:parseInt(t[1])}}function ft(e){return e.split(",").map(dt)}function ht(e){const t=ft(e);let n=0;for(let r=1;r<t.length;r++)t[r].quality>t[n].quality&&(n=r);return t[n].src}function gt(e){return e.srcset.length===0?e.src:ht(e.srcset)}function le(e){const t=e.tagName==="VIDEO"?"video":"image",n=t==="image"?gt(e):e.src;return{type:t,src:n}}function pt(e){const t=S(e);return t?le(t):(console.log("could not find any media element in post",e),null)}function mt(e,t){if(e==="video")return null;if(e==="image")return pt(t);const n=Ke(t);if(!n)return null;const r=S(n.child);return!r||!(r instanceof HTMLImageElement)?null:le(r)}function yt(e){let t=0;return async function(){const n=await re(100,5,e,"ul");let r=!1,o=!1,i=0;se(n,({child:s,index:a})=>{const c=S(s);if(!c)return;const h=c.matches("video");r?(a>i?t+=h?1:0:a<i&&(t+=o?-1:0),o=h):(o=h,t=o?0:-1,r=!0),i=a})}(),()=>t}function wt(){const e=document.querySelector('script[type="application/ld+json"]');if(!e)return f;try{const t=JSON.parse(e.innerHTML);if(typeof t!="object")return f;const r=(Array.isArray(t)?t:[t]).find(o=>typeof o!="object"?!1:o["@type"]==="SocialMediaPosting");return r?p(r):f}catch{return f}}function vt(e){const t=yt(e);let n=f,r=f;return async()=>{if(g(r)&&(r=k(e)),g(r))return u(["could not find type of post",e]);const o=r.value,i=mt(o,e);if(i){const v=lt(e);return d(v)?v:l({username:v.right,...i})}if(!_e(w()))return u("please open the page of this post in a new tab. downloading videos directly from the mainfeed is currently not supported.");if(g(n)&&(n=wt()),g(n))return u("couldn't find any social-media posting in the DOM");const s=n.value,a=s.video,{author:c}=s,h=c.identifier?.value??c.alternateName,m=t();return m<0||m>=a.length?u("video index is out of bounds. i'm as surprised as you are."):l({type:"video",username:h,src:a[m].contentUrl})}}function de(e){const t=e.querySelector('polygon[points="20 21 12 13.44 4 21 4 3 20 3 20 21"]');if(!t)return f;const n=ce(i=>i.matches('*[role="button"]'),t);if(g(n))return f;const o=n.value.parentElement;return o==null?f:o.matches('*[role="button"]')?p(o):f}const bt=e=>{const t=de(e);if(g(t))return null;const n=t.value,r=n.parentElement;if(!r)return null;const o=n.clientHeight+"px",i=getComputedStyle(r).getPropertyValue("padding");return{width:o,height:o,padding:i}},fe=(e,t)=>{Object.assign(t.style,bt(e))};function he(e){const t=ue({fetchMediaInfo:vt(e)});fe(e,t);const n=O(`
		<div 
			style="
				display: flex; 
				flex-direction: row;
				padding: 8px;
				padding-right: 0px;
				margin-left: 10px;
			"
		></div>
	`);return n.appendChild(t),n}function xt(e){const t=ct(Je(e));return fe(e,t.firstElementChild),t}function St(e){return new Promise(t=>{const n=k(e);if(T(n)){t(n.value);return}const r=oe(()=>{const i=k(e);g(i)||(t(i.value),o.disconnect())},600),o=new MutationObserver(r);o.observe(e,{childList:!0,subtree:!0})})}async function Et(e,t,n){const r=t.style.display,o=a=>{t.style.display=a?r:"none",e.style.display=a?"none":"initial"};if(w()!=="mainFeed"){e.style.display="none";return}const i=await St(n);if(i==="image")return;if(i==="video"){o(!1);return}const s=n.querySelector("ul");!s||se(s,({child:a,index:c})=>{const h=S(a);!h||o(h.matches("img"))})}function It(e){const t=de(e);if(g(t)){console.warn("trying to inject download buttons into post, but cannot find the save-button for reference");return}const r=t.value.parentElement?.parentElement;Object.assign(r?.style,{display:"flex",alignItems:"center"});const o=xt(e);r.appendChild(o);const i=he(e);r.appendChild(i),Et(o,i,e)}async function Pt(e){if(!await re(200,10,e,"polygon"))return u(["trying to inject download buttons into post, but cannot find any child with tag 'polygon' that was expected to be in the following element: ",e]);const n=Array.from(e.querySelectorAll("polygon"));if(n.length!==2&&console.warn(`expected to find exactly two svg-polygon elements on this page, but got a different number, namely ${n.length}`),n.length<1)return u("expected to find atleast one svg-polygon on this page that belonged to the share-button, but did not find any.");const r=n[0],o=ce(h=>h.matches("button"),r);if(g(o))return u(["found an svg-polygon element that was assumed to belong to the share-button. then we tried to find the share-button itself, but got no matches. here is the polygon element:",r]);const i=o.value,s=i.parentElement;if(!s)return u(["found the share-button, but the DOM structure is not as expected and therefore can't find find the point where to inject the download button. here is the share-button:",i]);const a=s.parentElement,c=a.lastChild;return Object.assign(c.style,{display:"flex",alignItems:"baseline"}),l({likeCommentShareBar:a,saveButtonWrapper:c})}async function Ct(e){const t=await Pt(e);if(d(t)){console.warn(t.left);return}const{saveButtonWrapper:n,likeCommentShareBar:r}=t.right,o=he(e);n.appendChild(o);const i=r.querySelector("svg")?.width.baseVal.value;i!==void 0&&Object.assign(o.querySelector("img").style,{width:`${i}px`,height:`${i}px`})}function Dt(e){w()==="mainFeed"?It(e):Ct(e)}function At(){return document.querySelector("article")?.parentElement}function N(){const e=At();return e?Array.from(e.children):[]}function Bt(e){const t=e.getBoundingClientRect(),n=(t.top+t.bottom)/2;return Math.abs(n-window.innerHeight/2)}function ge(){const e=N();return e.length===0?null:e.reduce((n,r)=>{const o=Bt(r);return o<n[0]?[o,r]:n},[1/0,null])[1]}const pe="Enter";function me(e){e.dispatchEvent(new CustomEvent("download-request"))}function Mt(e){return e.querySelector(".download-button")}function kt(){const e=ge();if(!e){console.warn("download by shortcut: could not find the currently visible post to download");return}const t=Mt(e);if(t===null){console.warn("download by shortcut: found the currently visible post, but there seems to be no download button. are you sure it's there?");return}me(t)}document.addEventListener("keydown",e=>{e.key===pe&&kt()});function ye(){return y(location.pathname,e=>/(?<=\/stories\/.*\/)\d*/.exec(e),F,q)}const _t=()=>y(document.querySelector("section section"),Y("expected to find the story-element in a section inside another section, but this query returned null. are you sure you are currently watching a story? if yes, instagram might have changed things up in the DOM. i'm deeply sorry and ashamed."));function Tt(e){const t=e.querySelector("header");if(!t)return u(["trying to find the progress-bars in this story but could not find the header-element that was expected to be there. look for yourself:",e]);const n=t.firstChild;return n?.firstChild?l(n):u(["there appears to be not a single progress-bar in this story. it is more likely that the DOM has another shape than expected. the following element was expected to contain all progress-bars of this story",n])}function qt(e){for(const t of e.children){const{width:n}=t.style;if(n.length!==0)return parseFloat(n)}return 0}function Ot(e){return qt(e)<100}function Ft(){const e=_t();if(d(e))return e;const t=Tt(e.right);if(d(t))return t;const n=y(t.right.children,Array.from,Pe(Ot));return g(n)?u("trying to find the current story-index by looking for the first progress-bar that has not finished. but it appears that every single progress-bar has completed."):l(n.value)}function we(){const{pathname:e}=location;return e.startsWith("/stories/highlights/")?"highlight_reel":"user_reel"}function Nt(){const e=window.location.href;return location.pathname.startsWith("/stories/highlights/")?Lt():Ht(e)}function Rt(e,t){return Y(`could not extract username from url: ${t}`)(F(e.exec(t)))}function Lt(){const e=/(?<=:\/\/www\.instagram\.com\/).*?(?=\/)/,t=y('link[href*="://www.instagram.com/"]',r=>document.querySelectorAll(r),Array.from,Ce(_(r=>r.href,r=>e.exec(r),q)));if(g(t))return u("trying to find a username on the profile page, but there seems to be no link element where we could read off the url.");const n=t.value[0];return l(n)}function Ht(e){return Rt(/(?<=stories\/).*?(?=\/)/,e)}function ve(e){return parseInt(e.getAttribute("bandwidth"))}function Ut(e){return e.hasAttribute("bandwidth")}const $t=J(ve)(Z),jt=De($t);function Wt(e){const t=e.querySelector("BaseURL");if(!t)return u({failure:"element does not have a child of type BaseURL from which the url could be extracted.",context:e});const n=t.textContent;return n===null?u({failure:"found a BaseURL-node but its textContent is null",context:{element:e,baseUrlNode:t}}):l(n)}function Vt(e){const t=e.getAttribute("width");if(t===null)return u({failure:'element has no "width" attribute',context:e});const n=e.getAttribute("height");return n===null?u({failure:'element has no "height" attribute',context:e}):l({width:parseInt(t),height:parseInt(n)})}function V(e){const t=[];if(e.children.length===0)return u({failure:"AdaptationSet has zero child nodes",context:e});const n=Array.from(e.children),r=n.filter(Ut);if(r.length===0)return u({failure:"none of the childnodes has a bandwidth attribute",context:e});r.length!==n.length&&t.push({failure:"some children of this AdaptationSet have no bandwidth attribute",context:e});const o=y(r,jt),i=Wt(o);if(d(i))return i;const s=ve(o);return l({success:{element:o,mediaData:{url:i.right,bandwidth:s}},warnings:t})}function zt(e){const t=[],n=e.children[0];if(n===null)return u({failure:"XMLDocument doc does not have a MPD-node",context:e});const r=Array.from(n.querySelectorAll("Period"));if(r.length===0)return u({failure:"could not find any nodes with the 'Period' tag in MPD",context:{doc:e,mpd:n}});r.length>1&&t.push({failure:"found more than 1 Period Element",context:{doc:e,MPD:n,periodNodes:r}});const o=r[0],i=Array.from(o.querySelectorAll("AdaptationSet"));if(i.length===0)return u({failure:"found no AdaptationSets in Period Element",context:o});i.length>2&&t.push({failure:"expected 2 AdaptationSets, 1 for video and 1 for audio, but got more than 2",context:{doc:e,period:o,adaptationSets:i}});const s=i.findIndex(E=>!!(E.getAttribute("contentType")==="video"||E.hasAttribute("maxFrameRate")));if(s<0)return u({failure:"could not find any AdaptationSets that contain videos, or maybe the attributes 'contentType' and 'maxFrameRate' do not work anymore.",context:{doc:e,period:o,adaptationSets:i}});const a=i[s],c=V(a);if(d(c))return u({failure:"error while trying to extract video data",context:{videoSet:a,subFailure:c.left}});const h=c.right,m=Vt(h.success.element);if(d(m))return u({failure:"could not extract width or height from video",context:{doc:e,subContext:m.left}});const v=m.right,Ee=h.success.mediaData;let H=f;if(i.length>1){const E=i[s===0?1:0],D=V(E);if(Be(D)){const Ie=D.right;H=p(Ie.success.mediaData)}}return l({data:{video:{...Ee,...v},audio:H},warnings:t})}function Qt(e){const t=new DOMParser;return Ae(()=>t.parseFromString(e,"text/xml"),n=>n instanceof Error?n:new Error("unknown error"))}function Xt(e){const t=Qt(e);return d(t)?t:zt(t.right)}const Gt=e=>e.width*e.height,Kt=J(Gt)(Me(Z));function z(e){return ke(Kt)(e)[0].url}function Yt(e){if(!e.video_dash_manifest)return f;const t=Xt(e.video_dash_manifest);if(d(t))return console.error(t.left),f;const n=t.right;return n.warnings.length>0&&console.warn(n.warnings),p({type:"video",src:n.data.video.url,previewSrc:e.image_versions2.candidates[0].url})}function Jt(e){if(e.video_versions){const n=Yt(e);return T(n)?n.value:{type:"video",src:z(e.video_versions),previewSrc:e.image_versions2.candidates[0].url}}const t=z(e.image_versions2.candidates);return{type:"image",src:t,previewSrc:t}}let b={"X-IG-App-ID":"936619743392459"};const be="trying to fetch media info from instagram API, but there was no previous request that we could imitate. please check if `web-request-listener.ts` and `foreground-collector.ts` are working properly.";function xe(){if(!b)throw be;return b}function Zt(){return b?l(b):u(be)}let Q=f,X=!1;C.exports.runtime.onMessage.addListener(function(e){"requestBody"in e&&g(Q)&&(Q=p(e.requestBody)),"requestHeaders"in e&&!X&&(b=e.requestHeaders,X=!0)});const en="https://www.instagram.com/api/v1/";function R(e){return`${en}${e}`}function tn(e){return R(`feed/reels_media/?reel_ids=highlight%3A${e}`)}const nn=()=>y(location.pathname,Qe(/(?<=\/stories\/highlights\/)\d*/));async function rn(e,t){const n=await fetch(tn(t),{credentials:"include",headers:e});return l(await n.json())}async function on(){const e=Zt();if(d(e))return e;const t=nn();return g(t)?u("could not find the ID of the highlights-story"):rn(e.right,t.value)}function sn(e){return R(`feed/reels_media/?reel_ids=${e}`)}async function an(e,t){const n=await fetch(sn(t),{credentials:"include",headers:e});return l(await n.json())}async function un(e){const t=xe();return an(t,e)}function cn(e){return R(`feed/user/${e}/username/?count=1`)}async function ln(e,t){const r=await(await fetch(cn(t),{credentials:"include",headers:e})).json();console.log("fetched user-info",r);const o=r.user;return l(o)}async function dn(e){const t=xe();return ln(t,e)}async function fn(){const e=Nt();if(d(e))return e;const t=e.right,n=await dn(t);if(d(n))return n;const o=n.right.pk.toString(),i=await un(o);return d(i)?i:l(i.right.reels_media[0])}async function hn(){const e=await on();return d(e)?e:l(e.right.reels_media[0])}async function gn(){return we()==="highlight_reel"?hn():fn()}function pn(e){const t=ye();if(g(t))return u(`could not story-id in url ${location.href}`);const n=t.value,r=e.items.find(o=>o.pk===n);return r?l(r):(console.log(e.items,n),u(`could not find story-ID ${n} in any of the fetched story-items`))}function mn(e){const t=Ft();return d(t)?t:l(e.items[t.right])}function yn(e){return e.reel_type==="user_reel"?pn(e):mn(e)}function wn(e){if(we()!==e.reel_type)return!0;const n=ye();if(g(n))return console.warn("trying to check if the current story-cache is stale by searching for the current story item, given the urls id, but could not find an id in the url. are you sure you are watching a story?"),!0;const r=n.value;return!e.items.some(o=>o.pk===r)}function vn(){let e=f;return async()=>{if(g(e)||wn(e.value)){console.log("refreshing story cache");const s=await gn();if(d(s))return s;e=p(s.right)}const t=e.value,n=yn(t);if(d(n))return n;const r=n.right,o=Jt(r),{username:i}=t.user;return l({src:o.src,username:i})}}function bn(){let e=!1;const t=document.querySelector("video");return{keepPaused:()=>{e=!0;const o=()=>{t&&!t.paused&&t.pause(),e&&window.requestAnimationFrame(o)};o()},continue:()=>{e=!1}}}function xn(){const e=document.querySelector('header *[role="button"]');return e?l(e):u("could not add download-button in story. the svg for the pause/play button has not button as an ancestor")}const Sn=e=>{const t=O(`
		<div style="margin-right: 8px;"></div>
	`),n=function(){let c=null;return{onDownloadStart:()=>{document.querySelector("video")&&(c=bn(),c.keepPaused())},onDownloadEnd:h=>{!c||c.continue()}}}(),r=ue({fetchMediaInfo:vn(),...n}),o=24;Object.assign(r.style,{width:`${o}px`}),t.appendChild(r);const i=xn();if(d(i)){console.warn(i.left);return}i.right.parentElement.insertAdjacentElement("afterbegin",t),document.addEventListener("keypress",c=>{c.key===pe&&me(r)})};x.addEventListener("onPostAdded",e=>Dt(e.detail.element));x.addEventListener("onStoryAdded",e=>Sn(e.detail.element));x.start();const Se=30;function L(e){const t=e.querySelector("section");if(t===null)return console.warn("trying to calculate distance to bottom, cannot find a 'section' element in post"),f;const n=t.getBoundingClientRect().bottom,r=window.innerHeight;return p(r-n)}function En(e){const t=L(e);return g(t)?!1:t.value<-Se}function In(e){const t=L(e);return g(t)?!1:t.value>Se}function Pn(){return N().find(En)}function Cn(){return N().reverse().find(In)}function G(e){const t=e();if(!t){console.warn("could not find post to scroll to");return}const n=-L(t),r=window.scrollY+n;window.scrollTo({left:window.scrollX,top:r,behavior:"smooth"})}function Dn(){const e={"scroll-up":"w","scroll-down":"s"};document.addEventListener("keydown",t=>{t.key===e["scroll-up"]?G(Cn):t.key===e["scroll-down"]&&G(Pn)})}Dn();const K={a:"left",d:"right"},An={left:"LeftChevron",right:"RightChevron"};function B(){console.warn("you've tried to navigate to the next or previous image/video but we couldn't find the button to click on")}function Bn(e){const n=w()==="stories"?document.body:ge();if(!n){B();return}const r=An[e],o=n.querySelector(`[class*="${r}"]`);if(!o){B();return}const i=o.parentElement;if(!i){B();return}i.click()}document.addEventListener("keydown",e=>{const{key:t}=e;t in K&&Bn(K[t])});console.log("### insta loader initialized ###");
