import{f as q,i as X,a as F,n as m,s as x,c as u,r as l,d as h,l as c,e as G,O as J,m as St,t as Et,g as It,p as y,h as Dt,j as Ct,k as Pt,o as _t,q as At,b as p,u as K,v as Bt,w as Mt}from"./vendor.adf0e26f.js";const D={mainFeed:"mainFeed",post:"post",personFeed:"personFeed",stories:"stories"},w=()=>{let t=window.location.href;return t.endsWith("instagram.com/")||t.includes(".com/?")?D.mainFeed:t.includes("/p/")?D.post:t.includes("/reel/")?"reel":t.includes("/stories/")?D.stories:D.personFeed},kt=t=>t==="post"||t==="reel";w();document.querySelector("#mount_0_0_8N");const k=()=>{const t=w();return t==="personFeed"?["preview"]:t==="stories"?["story"]:["post"]},E=new EventTarget;function Y(t){return t.map(e=>e.parentElement).filter(e=>e!==null)}const Tt=q(t=>t.querySelectorAll('a[href*="/p/"]'),Array.from,Y);function qt(t){if(w()==="mainFeed"){if(t.tagName=="ARTICLE")return[t];const e=Array.from(t.querySelectorAll("article"));if(e.length>0)return e}else return t.tagName=="MAIN"?[t]:Array.from(t.querySelectorAll("main"));return[]}function Ft(t){return t.tagName=="SECTION"&&Array.from(t.children).findIndex(e=>e.tagName=="HEADER")>0?[t]:Y(Array.from(t.querySelectorAll("header")))}const $=(t,e)=>{E.dispatchEvent(new CustomEvent(t,{detail:{element:e}}))};class B{constructor(e,n){this.getContainedElements=n,this.elementType=e}matchesType(e){return e.includes(this.elementType)}buildEventName(e){const n=this.elementType;return`on${n[0].toUpperCase()+n.slice(1)}${e}`}onAdded(e){$(this.buildEventName("Added"),e)}onRemoved(e){$(this.buildEventName("Removed"),e)}}const Ot=[new B("post",qt),new B("preview",Tt),new B("story",Ft)];function Z(t,e){if(t.nodeType!=1)return;let n=k();for(let r of Ot){if(!r.matchesType(n))continue;let o=r.getContainedElements(t),i=e?r.onAdded.bind(r):r.onRemoved.bind(r);o.forEach(i)}}function tt(t){t instanceof HTMLElement&&Z(t,!0)}function Nt(t){t instanceof HTMLElement&&Z(t,!1)}function Rt(t){t.addedNodes.forEach(tt),t.removedNodes.forEach(Nt)}function Ht(t){t.forEach(Rt)}function Lt(){var t=new MutationObserver(Ht);t.observe(document,{childList:!0,subtree:!0})}function Ut(){tt(document.body)}function $t(){Ut(),Lt()}E.start=$t;function jt(t){return new Promise(e=>setTimeout(e,t))}async function Wt(t,e,n){for(let r=0;r<e;r++){const o=n();if(X(o))return o.value;await jt(t)}throw"attempt was unsuccessful"}function zt(t,e){return F(t.querySelector(e))}async function Vt(t,e,n,r){return Wt(t,e,()=>zt(n,r))}const O=t=>{const e=document.createElement("div");return e.innerHTML=t,e.firstElementChild};function et(t,e){return()=>{window.setTimeout(t,e)}}function N(t){return t?t[0]:null}function Qt(t){return t?x(t[0]):m}const Xt=t=>q(e=>t.exec(e),Qt);function Gt(t){const e=t.parentElement;if(!e)return null;const n=e.parentElement;return n||null}function Jt(t,e){const n=N(/(?<=translateX\()[\d\.]*(?=px)/.exec(e.style.transform));return n?Math.round(parseFloat(n)/t):null}function nt(t){const e=Gt(t);if(!e)return null;const n=e.getBoundingClientRect().x,r=1,o=t.children[r],i=parseFloat(getComputedStyle(o).getPropertyValue("width"));for(let a=r;a<t.children.length;a++){const s=t.children[a],d=s.getBoundingClientRect().x;if(Math.abs(n-d)>i/2)continue;const g=Jt(i,s);if(g!==null)return{index:g,child:s}}return null}function Kt(t){const e=t.querySelector("ul");if(!e)return null;const n=nt(e);return n?{list:e,...n}:null}function Yt(t,e){let n=-1;const r=et(()=>{const i=nt(t);if(!i){console.warn("could not find index and child of carousel!");return}i.index!==n&&(n=i.index,e(i))},100);new MutationObserver(r).observe(t,{childList:!0,subtree:!0}),r()}function Zt(t){return Array.from(t.querySelectorAll("img")).find(e=>e.offsetHeight>400)}function _(t){const e=t.querySelector("video, img[srcset]");return e||Zt(t)}function rt(t){const e=t.querySelectorAll('a[href*="/p/"');if(e.length===0)return null;const n=e[e.length-1].href,r=n.indexOf("/p/");if(r<0)return null;const o=r+3,i=n.indexOf("/",o);return i<0?null:n.substring(0,i+1)}function te(t,e){let n=e;for(let r=0;r<1e3;r++){if(n.matches("li"))return!0;if(n===t)return!1;const o=n.parentElement;if(!o)return!1;n=o}return!1}function T(t){const e=_(t);return e?te(t,e)?"collection":e.tagName==="VIDEO"?"video":"image":null}function ee(t){const e=t.querySelector("header a").href,n=/(?<=\.com\/).*(?=\/)/.exec(e);return n?n[0]:null}function ne(t,e){const n=re(e);return u(n)?n:l(t[n.right])}function re(t){const e=ot(t);if(h(e))return c("attempted to find the indicator dots of a collection, but no luck. instagram might have changed the DOM and the current method of detection doesn't work anymore");const r=e.value.children;let o=0;for(let i=1;i<r.length;i++)r[i].className.length<=r[o].className.length||(o=i);return l(o)}function ot(t){if(!("clientWidth"in t))return m;const{clientWidth:o,clientHeight:i}=t;if(o>100&&i<10&&i>4)return x(t);if(!("children"in t))return m;for(const a of t.children){const s=ot(a);if(!h(s))return s}return m}function it(t){return parseInt(t.getAttribute("bandwidth"))}function oe(t){return t.hasAttribute("bandwidth")}const ie=G(it)(J),se=St(ie);function ae(t){const e=t.querySelector("BaseURL");if(!e)return c({failure:"element does not have a child of type BaseURL from which the url could be extracted.",context:t});const n=e.textContent;return n===null?c({failure:"found a BaseURL-node but its textContent is null",context:{element:t,baseUrlNode:e}}):l(n)}function ce(t){const e=t.getAttribute("width");if(e===null)return c({failure:'element has no "width" attribute',context:t});const n=t.getAttribute("height");return n===null?c({failure:'element has no "height" attribute',context:t}):l({width:parseInt(e),height:parseInt(n)})}function j(t){const e=[];if(t.children.length===0)return c({failure:"AdaptationSet has zero child nodes",context:t});const n=Array.from(t.children),r=n.filter(oe);if(r.length===0)return c({failure:"none of the childnodes has a bandwidth attribute",context:t});r.length!==n.length&&e.push({failure:"some children of this AdaptationSet have no bandwidth attribute",context:t});const o=y(r,se),i=ae(o);if(u(i))return i;const a=it(o);return l({success:{element:o,mediaData:{url:i.right,bandwidth:a}},warnings:e})}function ue(t){const e=[],n=t.children[0];if(n===null)return c({failure:"XMLDocument doc does not have a MPD-node",context:t});const r=Array.from(n.querySelectorAll("Period"));if(r.length===0)return c({failure:"could not find any nodes with the 'Period' tag in MPD",context:{doc:t,mpd:n}});r.length>1&&e.push({failure:"found more than 1 Period Element",context:{doc:t,MPD:n,periodNodes:r}});const o=r[0],i=Array.from(o.querySelectorAll("AdaptationSet"));if(i.length===0)return c({failure:"found no AdaptationSets in Period Element",context:o});i.length>2&&e.push({failure:"expected 2 AdaptationSets, 1 for video and 1 for audio, but got more than 2",context:{doc:t,period:o,adaptationSets:i}});const a=i.findIndex(I=>!!(I.getAttribute("contentType")==="video"||I.hasAttribute("maxFrameRate")));if(a<0)return c({failure:"could not find any AdaptationSets that contain videos, or maybe the attributes 'contentType' and 'maxFrameRate' do not work anymore.",context:{doc:t,period:o,adaptationSets:i}});const s=i[a],d=j(s);if(u(d))return c({failure:"error while trying to extract video data",context:{videoSet:s,subFailure:d.left}});const g=d.right,f=ce(g.success.element);if(u(f))return c({failure:"could not extract width or height from video",context:{doc:t,subContext:f.left}});const v=f.right,b=g.success.mediaData;let U=m;if(i.length>1){const I=i[a===0?1:0],A=j(I);if(It(A)){const xt=A.right;U=x(xt.success.mediaData)}}return l({data:{video:{...b,...v},audio:U},warnings:e})}function le(t){const e=new DOMParser;return Et(()=>e.parseFromString(t,"text/xml"),n=>n instanceof Error?n:new Error("unknown error"))}function de(t){const e=le(t);return u(e)?e:ue(e.right)}const fe=t=>t.width*t.height,he=G(fe)(Dt(J));function W(t){return Ct(he)(t)[0].url}function ge(t){if(!t.video_dash_manifest)return m;const e=de(t.video_dash_manifest);if(u(e))return console.error(e.left),m;const n=e.right;return n.warnings.length>0&&console.warn(n.warnings),x({type:"video",src:n.data.video.url,previewSrc:t.image_versions2.candidates[0].url})}function C(t){if(t.video_versions){const n=ge(t);return X(n)?n.value:{type:"video",src:W(t.video_versions),previewSrc:t.image_versions2.candidates[0].url}}const e=W(t.image_versions2.candidates);return{type:"image",src:e,previewSrc:e}}function me(t){return t.carousel_media.map(C)}function ye(t){if(!t.items)throw console.log(t),"items not found in dataObject (see above log)";const e=t.items;if(e.length===0)throw"items are empty";const n=e[0],r=n.user.username;let o=[],i="video";if(n.video_versions&&(i="video",o.push(C(n))),n.image_versions2&&(i="image",o.push(C(n))),n.carousel_media&&(i="collection",o=me(n)),o.length===0)throw"no media found";return{postType:i,mediaArray:o,username:r}}const pe=t=>y(t,At(e=>encodeURIComponent(e[0])),_t,Pt(([e,n])=>`${e}=${n}`),e=>e.join("&"));let we=!1,S={"X-IG-App-ID":"936619743392459"};const st="trying to fetch media info from instagram API, but there was no previous request that we could imitate. please check if `web-request-listener.ts` and `foreground-collector.ts` are working properly.";function at(){if(!S)throw st;return S}function ct(){return S?l(S):c(st)}let ut={};p.exports.runtime.onMessage.addListener(function(t){"requestHeaders"in t&&!we&&(S=t.requestHeaders),"requestBody"in t&&(ut=t.requestBody)});function ve(){const t=ct();return u(t)?t:l({headers:t.right,body:ut})}async function be(t){const{headers:e,body:n}=t,r=pe(n);try{const i=await(await fetch("https://www.instagram.com/graphql/query",{method:"POST",credentials:"include",headers:e,body:r})).json();return l(i)}catch(o){return c(o)}}async function xe(){const t=ve();if(u(t))return t;const e=await be(t.right);if(u(e))return e;const n=e.right,r=e.right?.data?.xdt_api__v1__media__shortcode__web_info;return r===void 0?c({message:"`response.data.xdt_api__v1__media__shortcode__web_info` is not defined",response:n}):l(r)}async function Se(){const t=await xe();if(u(t))throw t;const e=ye(t.right);return l(e)}function Ee(t){const e=t.split(" ");return{src:e[0],quality:parseInt(e[1])}}function Ie(t){return t.split(",").map(Ee)}function De(t){const e=Ie(t);let n=0;for(let r=1;r<e.length;r++)e[r].quality>e[n].quality&&(n=r);return e[n].src}function Ce(t){return t.srcset.length===0?t.src:De(t.srcset)}function lt(t){const e=t.tagName==="VIDEO"?"video":"image",n=e==="image"?Ce(t):t.src;return{type:e,src:n}}function Pe(t){const e=_(t);return e?lt(e):(console.log("could not find any media element in post",t),null)}function _e(t,e){if(t==="video")return null;if(t==="image")return Pe(e);const n=Kt(e);if(!n)return console.warn("could not find the current index of carousel"),null;const r=_(n.child);return!r||!(r instanceof HTMLImageElement)?null:lt(r)}const Ae=t=>{let e=null,n=null;return async()=>{if(!n&&(n=T(t),!n)){console.error("could not find type of post");return}const r=_e(n,t);if(r)return{username:ee(t),...r};if(!kt(w())){console.warn("please open the page of this post in a new tab. downloading videos directly from the mainfeed is currently not supported.");return}if(!e){if(!rt(t)){console.error("could not find href of post");return}const d=await Se();if(u(d)){console.error(d.left);return}e=d.right}const{username:o,mediaArray:i}=e,a=n==="collection"?ne(i,t):l(i[0]);if(u(a)){console.error(a.left);return}return{username:o,...a.right}}};function dt(t){return t.map(e=>`\\${e}`).join("|")}function Be(t){const e=dt(t);return new RegExp(`[^/]*(${e})`)}function Me(t,e){return new RegExp(dt(t)).exec(e)!==null}const ke=(t,e)=>n=>{const r=t.exec(n);if(r!==null){const o=r[0];return l(o)}return Me(e,n)?c(`could not extract a filename from the url '${n}' although it appears to contain a valid file-extension.`):c(`the url '${n}' does not contain any of the expected file-extensions: ${e.join(", ")}`)},Te=t=>ke(Be(t),t),qe=Te([".mp4",".jpg",".webp",".webm"]);function Fe(){const t=/(?<="username":")[^"]*/.exec(document.body.innerHTML);return t?t[0]:null}const Oe=(t,e)=>new Promise((n,r)=>{const o=p.exports.runtime.connect({name:"chrome-downloader"});let i=null;const a=()=>{o.postMessage({type:"request-state",id:i})};o.onMessage.addListener(s=>{if(s.type==="download-id"){i=s.id,a();return}if(s.type==="error"){r(s.error),o.disconnect();return}if(s.type==="success"){n(),o.disconnect();return}if(s.type==="progress"){e(s.progress.progress),a();return}}),o.postMessage({type:"request-download",filePath:t.filePath,url:t.url})}),Ne=(t,e)=>{const n={requests:[{action:"write media by link",data:t}],time:window.performance.now()};let r=null,o=null;const i=new Promise((s,d)=>{r=s,o=d}),a=p.exports.runtime.connect({name:"disk-downloader"});return a.onMessage.addListener((s,d)=>{if(s.origin==="native host disconnect"){o(s.data);return}else if(s.origin==="native host response"){const f=s.data[0],v=f.type;if(v==="success"){r();return}else if(v==="error"){o(f.data);return}else v==="progress"&&e(f.data.progress)}s.data[0].type==="success"&&a.disconnect()}),a.postMessage(n),i},Re=(t,e,n)=>{const r=n.directoryRules||[];r.reverse();const o=n.baseDownloadDirectory||"",i=[...r,{baseDirectory:o}];for(let a of i){const s=a.username||[],d=a.downloadAs||[],g=a.baseDirectory||"",f=a.folderPath||"";if(!((s.length===0||s.includes(t))&&(d.length===0||d.includes(e))))continue;let b=null;if(g!==""&&(b=`${g}/${t}`),f!==""&&(b=f),b!==null)return b}return null};async function He(t){const e=await p.exports.storage.sync.get({baseDownloadDirectory:"",directoryRules:[]}),n=Re(t.userName,t.ownUserName,e);if(!n)throw"no path found. have you set a path in the extension-options?";return n}function P(t){return p.exports.runtime.getURL(`assets/icons/${t}.png`)}const z={initial:"save",loading:"spinner-of-dots",success:"verify-sign-green",fail:"error"};class Le{constructor(){this._downloadState="initial",this._loadingProgress=0,this._spinnerCtx=null,this._spinnerCanvas=null,this._buttonImg=null,this._rootElement=null,this._rootElement=document.createElement("a"),this._rootElement.classList.add("download-button"),Object.assign(this._rootElement.style,{width:"fit-content",height:"fit-content",cursor:"pointer"}),this._buttonImg=document.createElement("img"),Object.assign(this._buttonImg.style,{width:"inherit",height:"inherit"}),this._rootElement.appendChild(this._buttonImg),this._setInitialState()}get downloadState(){return this._downloadState}set downloadState(e){this._downloadState=e,this._onDownloadStateChanged()}get loadingProgress(){return this._loadingProgress}set loadingProgress(e){this._loadingProgress=e,this._downloadState==="loading"&&this._drawSpinner()}getElement(){return this._rootElement}_setInitialState(){let n=k()[0]=="post"?"dark":"white";const r=`${z.initial}-${n}`;this._buttonImg.src=P(r)}_onDownloadStateChanged(){const e=this._downloadState;if(e==="loading")this._spinnerCanvas||(this._spinnerCanvas=document.createElement("canvas"),this._spinnerCtx=this._spinnerCanvas.getContext("2d"),this._drawSpinner());else{this._spinnerCanvas=null,this._spinnerCtx=null;let n=z[e];e==="initial"&&(n+=`-${k()[0]=="post"?"dark":"white"}`),this._buttonImg.src=P(n)}}_drawSpinner(){const e=this._spinnerCtx,n=this._loadingProgress,r=32;Object.assign(this._spinnerCanvas,{width:r,height:r}),e.clearRect(0,0,r,r),e.lineWidth=4;const o=(r-e.lineWidth)/2;e.strokeStyle="cyan",e.lineCap="round",e.beginPath();const i=r/2,a=-Math.PI/2;e.arc(i,i,o,a,a+n*2*Math.PI),e.stroke(),this._buttonImg.src=this._spinnerCanvas.toDataURL()}}const Ue="chrome-background";async function $e(){return(await p.exports.storage.sync.get({downloadMethod:Ue})).downloadMethod}const je=async(t,e)=>{const n=await $e(),r=t.src,o=qe(r);if(u(o))throw o.left;const i=o.right;if(n==="native"){const a=Fe(),s=await He({mediaSrc:r,userName:t.username,ownUserName:a});await Ne({link:r,folderPath:s,fileName:i},e)}else n==="chrome-background"&&await Oe({filePath:`Instagram/${t.username}/${i}`,url:r},e)},We=async(t,e)=>{let n=null;try{n=await t(),await je(n,e)}catch(r){console.error(r);const o=n?`${r}, 
 user: ${n.username}, 
 src: ${n.src}`:r;throw p.exports.runtime.sendMessage({type:"show-notification",notification:{title:"download failed",message:o,iconUrl:P("insta-loader-icon-48")}}),r}},ft=(t,e={})=>{e={onDownloadStart:()=>{},onDownloadEnd:()=>{},...e};const n=new Le,r=n.getElement(),o=async()=>{n.downloadState="loading";const i=a=>n.loadingProgress=a;e.onDownloadStart();try{await We(t,i),n.downloadState="success"}catch{n.downloadState="fail"}e.onDownloadEnd()};return r.addEventListener("download-request",o),r.addEventListener("mousedown",o),r};function ze(t){return O(`
		<div 
			style="
				display: flex; 
				flex-direction: row;
				padding: 8px;
				padding-right: 0px;
				margin-left: 10px;
			"
		>
			<a 
				href="${t}"
				style="width: fit-content; height: fit-content; cursor: pointer;"
			>
				<img 
					style="width: inherit; height: inherit;"
					src="${P("external-link-white")}"
				/>
			</a>
		</div>
	`)}function Ve(t){const e=t.querySelector("section");if(!e)return console.warn("trying to find bar with like-button, save-button, etc. in order to inject the download-button, but cannot find it!"),null;const n=Array.from(e.querySelectorAll("svg"));return n.length===0?null:n[n.length-1]}const Qe=t=>{const e=Ve(t);if(!e)return null;const n=e.parentElement;if(!n)return null;const r=e.clientHeight+"px",o=getComputedStyle(n).getPropertyValue("padding");return{width:r,height:r,padding:o}},ht=(t,e)=>{Object.assign(e.style,Qe(t))};function gt(t){const e=ft(Ae(t));ht(t,e);const n=O(`
		<div 
			style="
				display: flex; 
				flex-direction: row;
				padding: 8px;
				padding-right: 0px;
				margin-left: 10px;
			"
		></div>
	`);return n.appendChild(e),n}function Xe(t){const e=ze(rt(t));return ht(t,e.firstElementChild),e}function Ge(t){return new Promise(e=>{const n=T(t);if(n){e(n);return}const r=et(()=>{const i=T(t);!i||(e(i),o.disconnect())},600),o=new MutationObserver(r);o.observe(t,{childList:!0,subtree:!0})})}async function Je(t,e,n){const r=e.style.display,o=s=>{e.style.display=s?r:"none",t.style.display=s?"none":"initial"};if(w()!=="mainFeed"){t.style.display="none";return}const i=await Ge(n);if(i==="image")return;if(i==="video"){o(!1);return}const a=n.querySelector("ul");if(!a)return null;Yt(a,({child:s})=>{const d=_(s);!d||o(d.matches("img"))})}function Ke(t){const e=t.querySelector("section");if(!e){console.warn("trying to inject download buttons into post, but cannot find any child with tag 'Section'");return}const n=Xe(t);e.appendChild(n);const r=gt(t);e.appendChild(r),Je(n,r,t)}async function Ye(t){const e=await Vt(200,10,t,"section");if(!e){console.warn("trying to inject download buttons into post, but cannot find any child with tag 'Section' that was expected to be in the following element: ",t);return}const n=e.previousElementSibling;if(!n){console.warn("trying to inject download button into post, but cannot find the bar with the like, comment, share buttons. it was supposed to be the previous sibling of the following element: ",e);return}const r=gt(t);n.appendChild(r);const o=n.querySelector("svg")?.width.baseVal.value;o!==void 0&&Object.assign(r.querySelector("img").style,{width:`${o}px`,height:`${o}px`})}function Ze(t){w()==="mainFeed"?Ke(t):Ye(t)}function tn(){return document.querySelector("article")?.parentElement}function R(){const t=tn();return t?Array.from(t.children):[]}function en(t){const e=t.getBoundingClientRect(),n=(e.top+e.bottom)/2;return Math.abs(n-window.innerHeight/2)}function mt(){const t=R();return t.length===0?null:t.reduce((n,r)=>{const o=en(r);return o<n[0]?[o,r]:n},[1/0,null])[1]}const yt="Enter";function pt(t){t.dispatchEvent(new CustomEvent("download-request"))}function nn(t){return t.querySelector(".download-button")}function rn(){const t=mt();if(!t){console.warn("download by shortcut: could not find the currently visible post to download");return}const e=nn(t);if(e===null){console.warn("download by shortcut: found the currently visible post, but there seems to be no download button. are you sure it's there?");return}pt(e)}document.addEventListener("keydown",t=>{t.key===yt&&rn()});function wt(){return y(location.pathname,t=>/(?<=\/stories\/.*\/)\d*/.exec(t),N,F)}const on=()=>y(document.querySelector("section section"),K("expected to find the story-element in a section inside another section, but this query returned null. are you sure you are currently watching a story? if yes, instagram might have changed things up in the DOM. i'm deeply sorry and ashamed."));function sn(t){const e=t.querySelector("header");if(!e)return c(["trying to find the progress-bars in this story but could not find the header-element that was expected to be there. look for yourself:",t]);const n=e.firstChild;return n?.firstChild?l(n):c(["there appears to be not a single progress-bar in this story. it is more likely that the DOM has another shape than expected. the following element was expected to contain all progress-bars of this story",n])}function an(t){for(const e of t.children){const{width:n}=e.style;if(n.length!==0)return parseFloat(n)}return 0}function cn(t){return an(t)<100}function un(){const t=on();if(u(t))return t;const e=sn(t.right);if(u(e))return e;const n=y(e.right.children,Array.from,Bt(cn));return h(n)?c("trying to find the current story-index by looking for the first progress-bar that has not finished. but it appears that every single progress-bar has completed."):l(n.value)}function vt(){const{pathname:t}=location;return t.startsWith("/stories/highlights/")?"highlight_reel":"user_reel"}function ln(){const t=window.location.href;return location.pathname.startsWith("/stories/highlights/")?fn():hn(t)}function dn(t,e){return K(`could not extract username from url: ${e}`)(N(t.exec(e)))}function fn(){const t=/(?<=:\/\/www\.instagram\.com\/).*?(?=\/)/,e=y('link[href*="://www.instagram.com/"]',r=>document.querySelectorAll(r),Array.from,Mt(q(r=>r.href,r=>t.exec(r),F)));if(h(e))return c("trying to find a username on the profile page, but there seems to be no link element where we could read off the url.");const n=e.value[0];return l(n)}function hn(t){return dn(/(?<=stories\/).*?(?=\/)/,t)}const gn="https://www.instagram.com/api/v1/";function H(t){return`${gn}${t}`}function mn(t){return H(`feed/reels_media/?reel_ids=highlight%3A${t}`)}const yn=()=>y(location.pathname,Xt(/(?<=\/stories\/highlights\/)\d*/));async function pn(t,e){const n=await fetch(mn(e),{credentials:"include",headers:t});return l(await n.json())}async function wn(){const t=ct();if(u(t))return t;const e=yn();return h(e)?c("could not find the ID of the highlights-story"):pn(t.right,e.value)}function vn(t){return H(`feed/reels_media/?reel_ids=${t}`)}async function bn(t,e){const n=await fetch(vn(e),{credentials:"include",headers:t});return l(await n.json())}async function xn(t){const e=at();return bn(e,t)}function Sn(t){return H(`feed/user/${t}/username/?count=1`)}async function En(t,e){const r=await(await fetch(Sn(e),{credentials:"include",headers:t})).json();console.log("fetched user-info",r);const o=r.user;return l(o)}async function In(t){const e=at();return En(e,t)}async function Dn(){const t=ln();if(u(t))return t;const e=t.right,n=await In(e);if(u(n))return n;const o=n.right.pk.toString(),i=await xn(o);return u(i)?i:l(i.right.reels_media[0])}async function Cn(){const t=await wn();return u(t)?t:l(t.right.reels_media[0])}async function Pn(){return vt()==="highlight_reel"?Cn():Dn()}function _n(t){const e=wt();if(h(e))return c(`could not story-id in url ${location.href}`);const n=e.value,r=t.items.find(o=>o.pk===n);return r?l(r):(console.log(t.items,n),c(`could not find story-ID ${n} in any of the fetched story-items`))}function An(t){const e=un();return u(e)?e:l(t.items[e.right])}function Bn(t){return t.reel_type==="user_reel"?_n(t):An(t)}function Mn(t){if(vt()!==t.reel_type)return!0;const n=wt();if(h(n))return console.warn("trying to check if the current story-cache is stale by searching for the current story item, given the urls id, but could not find an id in the url. are you sure you are watching a story?"),!0;const r=n.value;return!t.items.some(o=>o.pk===r)}function kn(){let t=m;return async()=>{if(h(t)||Mn(t.value)){console.log("refreshing story cache");const s=await Pn();if(u(s))throw s.left;t=x(s.right)}const e=t.value,n=Bn(e);if(u(n))return n;const r=n.right,o=C(r),{username:i}=e.user;return{src:o.src,username:i}}}const Tn=()=>{let t=!1;const e=document.querySelector("video");return{keepPaused:()=>{t=!0;const o=()=>{e.paused||e.pause(),t&&window.requestAnimationFrame(o)};o()},continue:()=>{t=!1}}};function qn(){const t=document.querySelector("header button");return t?l(t):c("could not add download-button in story. the svg for the pause/play button has not button as an ancestor")}const Fn=t=>{const e=O(`
		<div style="margin-right: 8px;"></div>
	`),n=(()=>{let s=null;return{onDownloadStart:()=>{document.querySelector("video")&&(s=Tn(),s.keepPaused())},onDownloadEnd:()=>{!s||s.continue()}}})(),r=ft(kn(),n);e.appendChild(r);const o=qn();if(u(o)){console.warn(o.left);return}o.right.parentElement.insertAdjacentElement("afterbegin",e),document.addEventListener("keypress",s=>{s.key===yt&&pt(r)})};E.addEventListener("onPostAdded",t=>Ze(t.detail.element));E.addEventListener("onStoryAdded",t=>Fn(t.detail.element));E.start();const bt=30;function L(t){const e=t.querySelector("section");if(e===null)return console.warn("trying to calculate distance to bottom, cannot find a 'section' element in post"),m;const n=e.getBoundingClientRect().bottom,r=window.innerHeight;return x(r-n)}function On(t){const e=L(t);return h(e)?!1:e.value<-bt}function Nn(t){const e=L(t);return h(e)?!1:e.value>bt}function Rn(){return R().find(On)}function Hn(){return R().reverse().find(Nn)}function V(t){const e=t();if(!e){console.warn("could not find post to scroll to");return}const n=-L(e),r=window.scrollY+n;window.scrollTo({left:window.scrollX,top:r,behavior:"smooth"})}function Ln(){const t={"scroll-up":"w","scroll-down":"s"};document.addEventListener("keydown",e=>{e.key===t["scroll-up"]?V(Hn):e.key===t["scroll-down"]&&V(Rn)})}Ln();const Q={a:"left",d:"right"},Un={left:"LeftChevron",right:"RightChevron"};function M(){console.warn("you've tried to navigate to the next or previous image/video but we couldn't find the button to click on")}function $n(t){const n=w()==="stories"?document.body:mt();if(!n){M();return}const r=Un[t],o=n.querySelector(`[class*="${r}"]`);if(!o){M();return}const i=o.parentElement;if(!i){M();return}i.click()}document.addEventListener("keydown",t=>{const{key:e}=t;e in Q&&$n(Q[e])});console.log("### insta loader initialized ###");
