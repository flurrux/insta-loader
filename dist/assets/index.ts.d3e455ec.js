import{s as p,n as h,f as F,i as v,p as g,a as x,l as s,r as c,c as l,d as f,e as Pt,g as tt,O as et,m as At,t as Bt,h as _t,j as kt,k as Mt,b as A,o as j,q as nt,u as qt,v as Ot,w as Tt,x as Ft,y as Nt,z as Rt}from"./vendor.b289aac1.js";const I={mainFeed:"mainFeed",post:"post",personFeed:"personFeed",stories:"stories"},w=()=>{let t=window.location.href;return t.endsWith("instagram.com/")||t.includes(".com/?")?I.mainFeed:t.includes("/p/")?I.post:t.includes("/reel/")?"reel":t.includes("/stories/")?I.stories:I.personFeed},Lt=t=>t==="post"||t==="reel";w();document.querySelector("#mount_0_0_8N");const q=()=>{const t=w();return t==="personFeed"?["preview"]:t==="stories"?["story"]:["post"]};function D(t,e){let n=e;for(let r=0;r<1e3;r++){if(t(n))return p(n);const o=n.parentElement;if(!o)return h;n=o}return h}const b=new EventTarget;function rt(t){return t.map(e=>e.parentElement).filter(e=>e!==null)}const Ht=F(t=>[...W(t,'a[href*="/p/"]'),...W(t,'a[href*="/reel/"]')],rt);function W(t,e){return g(t.querySelectorAll(e),Array.from,n=>n)}function $t(t){if(w()==="mainFeed"){if(t.tagName=="ARTICLE")return[t];const e=Array.from(t.querySelectorAll("article"));if(e.length>0)return e}else return t.tagName=="MAIN"?[t]:Array.from(t.querySelectorAll("main"));return[]}function Ut(t){if(t.matches("section")&&Array.from(t.children).findIndex(e=>e.tagName=="HEADER")>0)return[t];if(t.querySelector("*[aria-label=Menu]")){const e=D(n=>n.matches("section"),t);if(v(e))return[e.value]}return g(t.querySelectorAll("header"),Array.from,rt)}const z=(t,e)=>{b.dispatchEvent(new CustomEvent(t,{detail:{element:e}}))};class k{constructor(e,n){this.getContainedElements=n,this.elementType=e}matchesType(e){return e.includes(this.elementType)}buildEventName(e){const n=this.elementType;return`on${n[0].toUpperCase()+n.slice(1)}${e}`}onAdded(e){z(this.buildEventName("Added"),e)}onRemoved(e){z(this.buildEventName("Removed"),e)}}const jt=[new k("post",$t),new k("preview",Ht),new k("story",Ut)];function ot(t,e){if(t.nodeType!=1)return;let n=q();for(let r of jt){if(!r.matchesType(n))continue;let o=r.getContainedElements(t),i=e?r.onAdded.bind(r):r.onRemoved.bind(r);o.forEach(i)}}function it(t){t instanceof HTMLElement&&ot(t,!0)}function Wt(t){t instanceof HTMLElement&&ot(t,!1)}function zt(t){t.addedNodes.forEach(it),t.removedNodes.forEach(Wt)}function Vt(t){t.forEach(zt)}function Qt(){var t=new MutationObserver(Vt);t.observe(document,{childList:!0,subtree:!0})}function Xt(){it(document.body)}function Gt(){Xt(),Qt()}b.start=Gt;function Kt(t){const e=t.detail.element,n=e.querySelector("a");n||console.warn("Attempted to replace /reel/ by /p/, but could not find a link element. Here is the supposed parent:",e);const r=n.href;!r||!r.includes("/reel/")||(n.href=r.replace("/reel/","/p/"))}function Yt(t){return new Promise(e=>setTimeout(e,t))}async function Jt(t,e,n){for(let r=0;r<e;r++){const o=n();if(v(o))return o.value;await Yt(t)}throw"attempt was unsuccessful"}function Zt(t,e){return x(t.querySelector(e))}async function te(t,e,n,r){return Jt(t,e,()=>Zt(n,r))}const N=t=>{const e=document.createElement("div");return e.innerHTML=t,e.firstElementChild};function st(t,e){return()=>{window.setTimeout(t,e)}}function R(t){return t?t[0]:null}function ee(t){return t?p(t[0]):h}const ne=t=>F(e=>t.exec(e),ee);function re(t){const e=t.parentElement;if(!e)return null;const n=e.parentElement;return n||null}function oe(t,e){const n=R(/(?<=translateX\()[\d\.]*(?=px)/.exec(e.style.transform));return n?Math.round(parseFloat(n)/t):null}function at(t){const e=re(t);if(!e)return null;const n=e.getBoundingClientRect().x,r=1,o=t.children[r],i=parseFloat(getComputedStyle(o).getPropertyValue("width"));for(let u=r;u<t.children.length;u++){const a=t.children[u],d=a.getBoundingClientRect().x;if(Math.abs(n-d)>i/2)continue;const m=oe(i,a);if(m!==null)return{index:m,child:a}}return null}function ie(t){const e=t.querySelector("ul");if(!e)return null;const n=at(e);return n?{list:e,...n}:null}function se(t,e){let n=-1;const r=st(()=>{const i=at(t);if(!i){console.warn("could not find index and child of carousel!");return}i.index!==n&&(n=i.index,e(i))},100);new MutationObserver(r).observe(t,{childList:!0,subtree:!0}),r()}function ae(t){const e=t.querySelectorAll('a[href*="/p/"');if(e.length===0)return null;const n=e[e.length-1].href,r=n.indexOf("/p/");if(r<0)return null;const o=r+3,i=n.indexOf("/",o);return i<0?null:n.substring(0,i+1)}function ue(t){return g(t.querySelectorAll("img"),Array.from,e=>e.find(n=>n.naturalWidth>400))}function B(t){return t.querySelector("video")??ue(t)}function ce(t,e){let n=e;for(let r=0;r<1e3;r++){if(n.matches("li"))return!0;if(n===t)return!1;const o=n.parentElement;if(!o)return!1;n=o}return!1}function O(t){const e=B(t);return e?ce(t,e)?p("collection"):p(e.tagName==="VIDEO"?"video":"image"):h}function le(t){const e=t.querySelector('img[alt*="profile picture"]');if(!e)return s(["could not find the authors username in this post",t]);const r=e.getAttribute("alt").replace("'s profile picture","");return c(r)}function de(t,e){const n=fe(e);return l(n)?n:c(t[n.right])}function fe(t){const e=ut(t);if(f(e))return s("attempted to find the indicator dots of a collection, but no luck. instagram might have changed the DOM and the current method of detection doesn't work anymore");const r=e.value.children;let o=0;for(let i=1;i<r.length;i++)r[i].className.length<=r[o].className.length||(o=i);return c(o)}function ut(t){if(!("clientWidth"in t))return h;const{clientWidth:o,clientHeight:i}=t;if(o>100&&i<10&&i>4)return p(t);if(!("children"in t))return h;for(const u of t.children){const a=ut(u);if(!f(a))return a}return h}function he(t){const e=t.split(" ");return{src:e[0],quality:parseInt(e[1])}}function me(t){return t.split(",").map(he)}function pe(t){const e=me(t);let n=0;for(let r=1;r<e.length;r++)e[r].quality>e[n].quality&&(n=r);return e[n].src}function ge(t){return t.srcset.length===0?t.src:pe(t.srcset)}function ct(t){const e=t.tagName==="VIDEO"?"video":"image",n=e==="image"?ge(t):t.src;return{type:e,src:n}}function ye(t){const e=B(t);return e?ct(e):(console.log("could not find any media element in post",t),null)}function we(t,e){if(t==="video")return null;if(t==="image")return ye(e);const n=ie(e);if(!n)return null;const r=B(n.child);return!r||!(r instanceof HTMLImageElement)?null:ct(r)}function ve(t){try{return c(JSON.parse(t.innerText))}catch(e){return s(e)}}function T(t,e){if(typeof e!="object")return h;if(e===null)return h;if(Array.isArray(e))for(const n of e){const r=T(t,n);if(!f(r))return r}for(const[n,r]of Object.entries(e)){if(n!==t){const o=T(t,r);if(f(o))continue;return o}return p(r)}return h}function be(){const t="xdt_api__v1__media__shortcode__web_info",e=g(document.body.querySelectorAll("script"),d=>Array.from(d),Pt(d=>d.innerText.includes(t)));if(f(e))return s(`could not find any script on this page that contains the string "${t}"`);const n=e.value,r=ve(n);if(l(r))return r;const o=r.right,i=T(t,o);if(f(i))return s([`could not find any property with they key "${t}", weirdly enough`,o]);const a=i.value.items;return!a||!Array.isArray(a)||a.length===0?s(["the 'items' property on the webInfo object does not exist or is not an array with at least one item",o]):c(a[0])}function lt(t){return parseInt(t.getAttribute("bandwidth"))}function xe(t){return t.hasAttribute("bandwidth")}const Se=tt(lt)(et),Ee=At(Se);function Ie(t){const e=t.querySelector("BaseURL");if(!e)return s({failure:"element does not have a child of type BaseURL from which the url could be extracted.",context:t});const n=e.textContent;return n===null?s({failure:"found a BaseURL-node but its textContent is null",context:{element:t,baseUrlNode:e}}):c(n)}function De(t){const e=t.getAttribute("width");if(e===null)return s({failure:'element has no "width" attribute',context:t});const n=t.getAttribute("height");return n===null?s({failure:'element has no "height" attribute',context:t}):c({width:parseInt(e),height:parseInt(n)})}function V(t){const e=[];if(t.children.length===0)return s({failure:"AdaptationSet has zero child nodes",context:t});const n=Array.from(t.children),r=n.filter(xe);if(r.length===0)return s({failure:"none of the childnodes has a bandwidth attribute",context:t});r.length!==n.length&&e.push({failure:"some children of this AdaptationSet have no bandwidth attribute",context:t});const o=g(r,Ee),i=Ie(o);if(l(i))return i;const u=lt(o);return c({success:{element:o,mediaData:{url:i.right,bandwidth:u}},warnings:e})}function Ce(t){const e=[],n=t.children[0];if(n===null)return s({failure:"XMLDocument doc does not have a MPD-node",context:t});const r=Array.from(n.querySelectorAll("Period"));if(r.length===0)return s({failure:"could not find any nodes with the 'Period' tag in MPD",context:{doc:t,mpd:n}});r.length>1&&e.push({failure:"found more than 1 Period Element",context:{doc:t,MPD:n,periodNodes:r}});const o=r[0],i=Array.from(o.querySelectorAll("AdaptationSet"));if(i.length===0)return s({failure:"found no AdaptationSets in Period Element",context:o});i.length>2&&e.push({failure:"expected 2 AdaptationSets, 1 for video and 1 for audio, but got more than 2",context:{doc:t,period:o,adaptationSets:i}});const u=i.findIndex(E=>!!(E.getAttribute("contentType")==="video"||E.hasAttribute("maxFrameRate")));if(u<0)return s({failure:"could not find any AdaptationSets that contain videos, or maybe the attributes 'contentType' and 'maxFrameRate' do not work anymore.",context:{doc:t,period:o,adaptationSets:i}});const a=i[u],d=V(a);if(l(d))return s({failure:"error while trying to extract video data",context:{videoSet:a,subFailure:d.left}});const m=d.right,y=De(m.success.element);if(l(y))return s({failure:"could not extract width or height from video",context:{doc:t,subContext:y.left}});const It=y.right,Dt=m.success.mediaData;let U=h;if(i.length>1){const E=i[u===0?1:0],_=V(E);if(_t(_)){const Ct=_.right;U=p(Ct.success.mediaData)}}return c({data:{video:{...Dt,...It},audio:U},warnings:e})}function Pe(t){const e=new DOMParser;return Bt(()=>e.parseFromString(t,"text/xml"),n=>n instanceof Error?n:new Error("unknown error"))}function Ae(t){const e=Pe(t);return l(e)?e:Ce(e.right)}const Be=t=>t.width*t.height,_e=tt(Be)(kt(et));function Q(t){return Mt(_e)(t)[0].url}function ke(t){if(!t.video_dash_manifest)return h;const e=Ae(t.video_dash_manifest);if(l(e))return console.error(e.left),h;const n=e.right;return n.warnings.length>0&&console.warn(n.warnings),p({type:"video",src:n.data.video.url,previewSrc:t.image_versions2.candidates[0].url})}function C(t){if(t.video_versions){const n=ke(t);return v(n)?n.value:{type:"video",src:Q(t.video_versions),previewSrc:t.image_versions2.candidates[0].url}}const e=Q(t.image_versions2.candidates);return{type:"image",src:e,previewSrc:e}}function Me(t){return t.carousel_media.map(C)}function qe(t){const e=t.user.username;let n=[],r="video";return t.carousel_media?(r="collection",n=Me(t)):t.video_versions?(r="video",n.push(C(t))):(r="image",n.push(C(t))),n.length===0?s("no media found"):c({postType:r,mediaArray:n,username:e})}function Oe(){const t=document.querySelector("meta[content*='instagram://media?id=']");if(!t)return s("could not find media-id on this page. are you sure this is a page with a single post?");const n=t.getAttribute("content").replace("instagram://media?id=","");return c(n)}const Te=t=>{let e=h,n=h;return async function(){if(f(n)&&(n=O(t)),f(n))return s(["could not find type of post",t]);const r=n.value,o=we(r,t);if(o){const d=le(t);return l(d)?d:c({username:d.right,...o})}if(!Lt(w()))return s("please open the page of this post in a new tab. downloading videos directly from the mainfeed is currently not supported.");if(f(e)){const d=await Fe();if(l(d))return d;const m=d.right,y=qe(m);if(l(y))return y;e=p(y.right)}if(f(e))return s("this fail case should never occur");const i=e.value,{mediaArray:u}=i,a=r==="collection"?de(u,t):c(u[0]);return l(a)?a.left:c({username:i.username,...a.right})}};async function Fe(){if(location.pathname.match("/.*/reel/")){const t=Oe();if(l(t))return s("tried to download this reel but could not find the id of this post");const n=`https://www.instagram.com/api/v1/media/${t.right}/info/`;try{const r=await(await fetch(n)).json();return c(r.items[0])}catch(r){return s(r)}}else return be()}function dt(t){return t.map(e=>`\\${e}`).join("|")}function Ne(t){const e=dt(t);return new RegExp(`[^/]*(${e})`)}function Re(t,e){return new RegExp(dt(t)).exec(e)!==null}const Le=(t,e)=>n=>{const r=t.exec(n);if(r!==null){const o=r[0];return c(o)}return Re(e,n)?s(`could not extract a filename from the url '${n}' although it appears to contain a valid file-extension.`):s(`the url '${n}' does not contain any of the expected file-extensions: ${e.join(", ")}`)},He=t=>Le(Ne(t),t),$e=He([".mp4",".jpg",".webp",".webm",".heic"]),Ue=(t,e)=>new Promise((n,r)=>{const o=A.exports.runtime.connect({name:"chrome-downloader"});let i=null;const u=()=>{o.postMessage({type:"request-state",id:i})};o.onMessage.addListener(a=>{if(a.type==="download-id"){i=a.id,u();return}if(a.type==="error"){r(a.error),o.disconnect();return}if(a.type==="success"){n(),o.disconnect();return}if(a.type==="progress"){e(a.progress.progress),u();return}}),o.postMessage({type:"request-download",filePath:t.filePath,url:t.url})});function P(t){return A.exports.runtime.getURL(`assets/icons/${t}.png`)}const X={initial:"save",loading:"spinner-of-dots",success:"verify-sign-green",fail:"error"};class je{constructor(){this._downloadState="initial",this._loadingProgress=0,this._spinnerCtx=null,this._spinnerCanvas=null,this._buttonImg=null,this._rootElement=null,this._rootElement=document.createElement("a"),this._rootElement.classList.add("download-button"),Object.assign(this._rootElement.style,{width:"fit-content",height:"fit-content",cursor:"pointer"}),this._buttonImg=document.createElement("img"),Object.assign(this._buttonImg.style,{width:"inherit",height:"inherit"}),this._rootElement.appendChild(this._buttonImg),this._setInitialState()}get downloadState(){return this._downloadState}set downloadState(e){this._downloadState=e,this._onDownloadStateChanged()}get loadingProgress(){return this._loadingProgress}set loadingProgress(e){this._loadingProgress=e,this._downloadState==="loading"&&this._drawSpinner()}getElement(){return this._rootElement}_setInitialState(){let n=q()[0]=="post"?"dark":"white";const r=`${X.initial}-${n}`;this._buttonImg.src=P(r)}_onDownloadStateChanged(){const e=this._downloadState;if(e==="loading")this._spinnerCanvas||(this._spinnerCanvas=document.createElement("canvas"),this._spinnerCtx=this._spinnerCanvas.getContext("2d"),this._drawSpinner());else{this._spinnerCanvas=null,this._spinnerCtx=null;let n=X[e];e==="initial"&&(n+=`-${q()[0]=="post"?"dark":"white"}`),this._buttonImg.src=P(n)}}_drawSpinner(){const e=this._spinnerCtx,n=this._loadingProgress,r=32;Object.assign(this._spinnerCanvas,{width:r,height:r}),e.clearRect(0,0,r,r),e.lineWidth=4;const o=(r-e.lineWidth)/2;e.strokeStyle="cyan",e.lineCap="round",e.beginPath();const i=r/2,u=-Math.PI/2;e.arc(i,i,o,u,u+n*2*Math.PI),e.stroke(),this._buttonImg.src=this._spinnerCanvas.toDataURL()}}async function We(t){const{mediaInfo:e,loadingCallback:n}=t,r=e.src,o=$e(r);if(l(o))return o;const i=o.right;return await Ue({filePath:`Instagram/${e.username}/${i}`,url:r},n),c(void 0)}function G(t){A.exports.runtime.sendMessage({type:"show-notification",notification:{title:"download failed",message:t,iconUrl:P("insta-loader-icon-48")}})}async function ze(t){const{fetchMediaInfo:e,loadingCallback:n}=t,r=await e();if(l(r))return console.error(r.left),G("something went wrong while trying to fetch the image or video. sorry for this vague message. i'm trying to provide better messages in future releases."),!1;const o=r.right,i=await We({mediaInfo:o,loadingCallback:n});if(l(i)){const u=i.left;return console.error(u),G(`we've successfully figured out the download url and username, but the download failed anyway. not exactly sure why. i will try to include the exact reason soon. you may want to try downloading this file on your own. here's the url:
${o.src}
username: ${o.username}`),!1}return!0}const ft=t=>{const{fetchMediaInfo:e,onDownloadStart:n=j,onDownloadEnd:r=j}=t,o=new je,i=o.getElement(),u=async()=>{o.downloadState="loading";const a=m=>{o.loadingProgress=m};n(void 0);const d=await ze({fetchMediaInfo:e,loadingCallback:a});o.downloadState=d?"success":"fail",r(d)};return i.addEventListener("download-request",u),i.addEventListener("mousedown",u),i};function Ve(t){return N(`
		<div 
			style="
				display: flex; 
				flex-direction: row;
				padding: 8px;
				padding-right: 0px;
				margin-left: 10px;
			"
		>
			<a 
				href="${t}"
				style="width: fit-content; height: fit-content; cursor: pointer;"
			>
				<img 
					style="width: inherit; height: inherit;"
					src="${P("external-link-white")}"
				/>
			</a>
		</div>
	`)}function ht(t){const e=t.querySelector('[aria-label="Save"]');if(!e)return h;const n=D(i=>i.matches('*[role="button"]'),e);if(f(n))return h;const o=n.value.parentElement;return o==null?h:o.matches('*[role="button"]')?p(o):h}const Qe=t=>{const e=ht(t);if(f(e))return null;const n=e.value,r=n.parentElement;if(!r)return null;const o=n.clientHeight+"px",i=getComputedStyle(r).getPropertyValue("padding");return{width:o,height:o,padding:i}},mt=(t,e)=>{Object.assign(e.style,Qe(t))};function pt(t){const e=ft({fetchMediaInfo:Te(t)});mt(t,e);const n=N(`
		<div 
			style="
				display: flex; 
				flex-direction: row;
				padding: 8px;
				padding-right: 0px;
				margin-left: 10px;
			"
		></div>
	`);return n.appendChild(e),n}function Xe(t){const e=Ve(ae(t));return mt(t,e.firstElementChild),e}function Ge(t){return new Promise(e=>{const n=O(t);if(v(n)){e(n.value);return}const r=st(()=>{const i=O(t);f(i)||(e(i.value),o.disconnect())},600),o=new MutationObserver(r);o.observe(t,{childList:!0,subtree:!0})})}async function Ke(t,e,n){const r=e.style.display,o=a=>{e.style.display=a?r:"none",t.style.display=a?"none":"initial"};if(w()!=="mainFeed"){t.style.display="none";return}const i=await Ge(n);if(i==="image")return;if(i==="video"){o(!1);return}const u=n.querySelector("ul");!u||se(u,({child:a,index:d})=>{const m=B(a);!m||o(m.matches("img"))})}function Ye(t){const e=ht(t);if(f(e)){console.warn("trying to inject download buttons into post, but cannot find the save-button for reference");return}const r=e.value.parentElement?.parentElement;Object.assign(r?.style,{display:"flex",alignItems:"center"});const o=Xe(t);r.appendChild(o);const i=pt(t);r.appendChild(i),Ke(o,i,t)}async function Je(t){const e='aria-label*="Share"',n=await te(500,10,t,`[${e}]`);if(!n)return s([`did not find ${e} after 10 attempts.`]);const r=Ze(n);if(l(r))return r;const o=r.right,i=o.parentElement;if(!i)return s(["found the share-button, but the DOM structure is not as expected and therefore can't find find the point where to inject the download button. here is the share-button:",o]);const u=i.parentElement,a=u.lastChild;return Object.assign(a.style,{display:"flex",alignItems:"baseline"}),c({likeCommentShareBar:u,saveButtonWrapper:a})}function Ze(t){const e=D(r=>r.matches('[role="button"]'),t);if(v(e))return c(e.value);const n=D(r=>r.matches('[type="button"]'),t);return v(n)?c(n.value):s(["didn't find any parent with a role of button. here's the starting point:",t])}async function tn(t){const e=await Je(t);if(l(e)){console.warn(e.left);return}const{saveButtonWrapper:n,likeCommentShareBar:r}=e.right,o=pt(t);n.appendChild(o);const i=r.querySelector("svg")?.width.baseVal.value;i!==void 0&&Object.assign(o.querySelector("img").style,{width:`${i}px`,height:`${i}px`})}function en(t){w()==="mainFeed"?Ye(t):tn(t)}function nn(){return document.querySelector("article")?.parentElement}function L(){const t=nn();return t?Array.from(t.children):[]}function rn(t){const e=t.getBoundingClientRect(),n=(e.top+e.bottom)/2;return Math.abs(n-window.innerHeight/2)}function gt(){const t=L();return t.length===0?null:t.reduce((n,r)=>{const o=rn(r);return o<n[0]?[o,r]:n},[1/0,null])[1]}const yt="Enter";function wt(t){t.dispatchEvent(new CustomEvent("download-request"))}function on(t){return t.querySelector(".download-button")}function sn(){const t=gt();if(!t){console.warn("download by shortcut: could not find the currently visible post to download");return}const e=on(t);if(e===null){console.warn("download by shortcut: found the currently visible post, but there seems to be no download button. are you sure it's there?");return}wt(e)}document.addEventListener("keydown",t=>{t.key===yt&&sn()});function vt(){return g(location.pathname,t=>/(?<=\/stories\/.*\/)\d*/.exec(t),R,x)}function an(){return g(document.querySelectorAll("section"),t=>Array.from(t),Tt(t=>({section:t,size:t.offsetWidth*t.offsetHeight})),t=>(t=t.slice(),t.sort((e,n)=>n.size-e.size),t),Ot(0),qt(({section:t})=>t),nt(()=>s("expected to find the story-element in the largest section element on this page, but this query returned null. are you sure you are currently watching a story? if yes, instagram might have changed things up in the DOM. i'm deeply sorry and ashamed."),t=>c(t)))}function un(t){const e=t.querySelector(".download-button"),n=function(){let r=e;for(let o=0;o<20;o++){if(r.offsetWidth>200)return c(r);const i=x(r?.parentElement);if(f(i))break;r=i.value}return s("starting from the download button, we attempted to find an ancestor with a width greater than 200 pixels, but had no success.")}();return l(n)?n:g(n.right,r=>r.parentElement?.firstElementChild,x,nt(()=>s("found an ancestor of the download button with the expected width, but not the expected DOM structure"),c))}function cn(t){return t.childElementCount>0}function ln(){const t=an();if(l(t))return t;const e=un(t.right);if(l(e))return e;const n=g(e.right.children,Array.from,Ft(cn));return f(n)?s("trying to find the current story-index by looking for the first progress-bar that has not finished. but it appears that every single progress-bar has completed."):c(n.value)}function bt(){const{pathname:t}=location;return t.startsWith("/stories/highlights/")?"highlight_reel":"user_reel"}function dn(){const t=window.location.href;return location.pathname.startsWith("/stories/highlights/")?hn():mn(t)}function fn(t,e){return Nt(`could not extract username from url: ${e}`)(R(t.exec(e)))}function hn(){const t=/(?<=:\/\/www\.instagram\.com\/).*?(?=\/)/,e=g('link[href*="://www.instagram.com/"]',r=>document.querySelectorAll(r),Array.from,Rt(F(r=>r.href,r=>t.exec(r),x)));if(f(e))return s("trying to find a username on the profile page, but there seems to be no link element where we could read off the url.");const n=e.value[0];return c(n)}function mn(t){return fn(/(?<=stories\/).*?(?=\/)/,t)}let S={"X-IG-App-ID":"936619743392459"};const xt="trying to fetch media info from instagram API, but there was no previous request that we could imitate. please check if `web-request-listener.ts` and `foreground-collector.ts` are working properly.";function St(){if(!S)throw xt;return S}function pn(){return S?c(S):s(xt)}let K=h,Y=!1;A.exports.runtime.onMessage.addListener(function(t){"requestBody"in t&&f(K)&&(K=p(t.requestBody)),"requestHeaders"in t&&!Y&&(S=t.requestHeaders,Y=!0)});const gn="https://www.instagram.com/api/v1/";function H(t){return`${gn}${t}`}function yn(t){return H(`feed/reels_media/?reel_ids=highlight%3A${t}`)}const wn=()=>g(location.pathname,ne(/(?<=\/stories\/highlights\/)\d*/));async function vn(t,e){const n=await fetch(yn(e),{credentials:"include",headers:t});return c(await n.json())}async function bn(){const t=pn();if(l(t))return t;const e=wn();return f(e)?s("could not find the ID of the highlights-story"):vn(t.right,e.value)}function xn(t){return H(`feed/reels_media/?reel_ids=${t}`)}async function Sn(t,e){const n=await fetch(xn(e),{credentials:"include",headers:t});return c(await n.json())}async function En(t){const e=St();return Sn(e,t)}function In(t){return H(`feed/user/${t}/username/?count=1`)}async function Dn(t,e){const r=await(await fetch(In(e),{credentials:"include",headers:t})).json();console.log("fetched user-info",r);const o=r.user;return c(o)}async function Cn(t){const e=St();return Dn(e,t)}async function Pn(){const t=dn();if(l(t))return t;const e=t.right,n=await Cn(e);if(l(n))return n;const o=n.right.pk.toString(),i=await En(o);return l(i)?i:c(i.right.reels_media[0])}async function An(){const t=await bn();return l(t)?t:c(t.right.reels_media[0])}async function Bn(){return bt()==="highlight_reel"?An():Pn()}function _n(t){const e=vt();if(f(e))return s(`could not story-id in url ${location.href}`);const n=e.value,r=t.items.find(o=>o.pk===n);return r?c(r):(console.log(t.items,n),s(`could not find story-ID ${n} in any of the fetched story-items`))}function kn(t){const e=ln();return l(e)?e:c(t.items[e.right])}function Mn(t){return t.reel_type==="user_reel"?_n(t):kn(t)}function qn(t){if(bt()!==t.reel_type)return!0;const n=vt();if(f(n))return console.warn("trying to check if the current story-cache is stale by searching for the current story item, given the urls id, but could not find an id in the url. are you sure you are watching a story?"),!0;const r=n.value;return!t.items.some(o=>o.pk===r)}function On(){let t=h;return async()=>{if(f(t)||qn(t.value)){console.log("refreshing story cache");const u=await Bn();if(l(u))return u;t=p(u.right)}const e=t.value,n=Mn(e);if(l(n))return n;const r=n.right,o=C(r),{username:i}=e.user;return c({src:o.src,username:i})}}const Tn=t=>{const e=N(`
		<div style="margin-right: 8px;"></div>
	`),n=function(){let d=null;return{onDownloadStart:()=>{document.querySelector("video")&&(d=Nn(),d.keepPaused())},onDownloadEnd:m=>{!d||d.continue()}}}(),r=ft({fetchMediaInfo:On(),...n}),o=24;Object.assign(r.style,{width:`${o}px`}),e.appendChild(r);const i=Fn(t);if(l(i)){console.warn(i.left);return}const a=i.right.parentElement;a?a.insertAdjacentElement("afterbegin",e):console.error("the playButton has no parentElement."),document.addEventListener("keypress",d=>{d.key===yt&&wt(r)})};function Fn(t){const e=t.querySelector("*[aria-label=Play]")??t.querySelector("*[aria-label=Pause]");if(!e)return s("could not add download-button in story. the svg for the pause/play button has no button as an ancestor");const n=e.parentElement?.parentElement;return n?(n.getAttribute("role")!=="button"&&console.warn("the grandparent of this playButton has no role attribute with value 'button'. this is unexpected, but not necessarily breaking"),c(n)):s("found the playbutton but it has no grandparent which is very weird and will probably never ever happen")}function Nn(){let t=!1;const e=document.querySelector("video");return{keepPaused:()=>{t=!0;const o=()=>{e&&!e.paused&&e.pause(),t&&window.requestAnimationFrame(o)};o()},continue:()=>{t=!1}}}b.addEventListener("onPostAdded",t=>en(t.detail.element));b.addEventListener("onPreviewAdded",Kt);b.addEventListener("onStoryAdded",t=>Tn(t.detail.element));b.start();const Et=30;function $(t){const e=t.querySelector("section");if(e===null)return console.warn("trying to calculate distance to bottom, cannot find a 'section' element in post"),h;const n=e.getBoundingClientRect().bottom,r=window.innerHeight;return p(r-n)}function Rn(t){const e=$(t);return f(e)?!1:e.value<-Et}function Ln(t){const e=$(t);return f(e)?!1:e.value>Et}function Hn(){return L().find(Rn)}function $n(){return L().reverse().find(Ln)}function J(t){const e=t();if(!e){console.warn("could not find post to scroll to");return}const n=-$(e),r=window.scrollY+n;window.scrollTo({left:window.scrollX,top:r,behavior:"smooth"})}function Un(){const t={"scroll-up":"w","scroll-down":"s"};document.addEventListener("keydown",e=>{e.key===t["scroll-up"]?J($n):e.key===t["scroll-down"]&&J(Hn)})}Un();const Z={a:"left",d:"right"},jn={left:"LeftChevron",right:"RightChevron"};function M(){console.warn("you've tried to navigate to the next or previous image/video but we couldn't find the button to click on")}function Wn(t){const n=w()==="stories"?document.body:gt();if(!n){M();return}const r=jn[t],o=n.querySelector(`[class*="${r}"]`);if(!o){M();return}const i=o.parentElement;if(!i){M();return}i.click()}document.addEventListener("keydown",t=>{const{key:e}=t;e in Z&&Wn(Z[e])});console.log("### insta loader initialized ###");
