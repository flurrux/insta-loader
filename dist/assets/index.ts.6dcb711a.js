import{_ as C,O as P,n as U,N as oe,E as c,a as u,b as re}from"./vendor.f161ea17.js";const w={mainFeed:"mainFeed",post:"post",personFeed:"personFeed",stories:"stories"},p=()=>{let e=window.location.href;return e.endsWith("instagram.com/")||e.includes(".com/?")?w.mainFeed:e.includes("/p/")?w.post:e.includes("/reel/")?"reel":e.includes("/stories/")?w.stories:w.personFeed};p();document.querySelector("#mount_0_0_8N");const A=()=>{const e=p();return e==="personFeed"?["preview"]:e==="stories"?["story"]:["post"]},y=new EventTarget;function $(e){return e.map(t=>t.parentElement).filter(t=>t!==null)}const ie=C.flow(e=>e.querySelectorAll('a[href*="/p/"]'),Array.from,$);function se(e){return e.tagName=="ARTICLE"?[e]:Array.from(e.querySelectorAll("article"))}function ae(e){return e.tagName=="SECTION"&&Array.from(e.children).findIndex(t=>t.tagName=="HEADER")>0?[e]:$(Array.from(e.querySelectorAll("header")))}const k=(e,t)=>{y.dispatchEvent(new CustomEvent(e,{detail:{element:t}}))};class x{constructor(t,n){this.getContainedElements=n,this.elementType=t}matchesType(t){return t.includes(this.elementType)}buildEventName(t){const n=this.elementType;return`on${n[0].toUpperCase()+n.slice(1)}${t}`}onAdded(t){k(this.buildEventName("Added"),t)}onRemoved(t){k(this.buildEventName("Removed"),t)}}const ce=[new x("post",se),new x("preview",ie),new x("story",ae)];function H(e,t){if(e.nodeType!=1)return;let n=A();for(let o of ce)if(o.matchesType(n)){let r=o.getContainedElements(e),i=t?o.onAdded.bind(o):o.onRemoved.bind(o);r.forEach(i)}}function j(e){e instanceof HTMLElement&&H(e,!0)}function le(e){e instanceof HTMLElement&&H(e,!1)}function ue(e){e.addedNodes.forEach(j),e.removedNodes.forEach(le)}function de(e){e.forEach(ue)}function fe(){var e=new MutationObserver(de);e.observe(document,{childList:!0,subtree:!0})}function he(){j(document.body)}function me(){he(),fe()}y.start=me;const _=e=>{const t=document.createElement("div");return t.innerHTML=e,t.firstElementChild};function ge(e,t){let n=t;for(let o=0;o<1e3;o++){if(n.matches(e))return n;n=n.parentElement}return null}function pe(e){return Array.from(e.querySelectorAll("img")).find(t=>t.offsetHeight>400)}function S(e){const t=e.querySelector("video, img[srcset]");return t||pe(e)}function ye(e){const t=e.split(" ");return{src:t[0],quality:parseInt(t[1])}}function we(e){return e.split(",").map(ye)}function M(e){const t=we(e);let n=0;for(let o=1;o<t.length;o++)t[o].quality>t[n].quality&&(n=o);return t[n].src}function ve(e){return e.srcset.length===0?e.src:M(e.srcset)}function W(e){const t=e.tagName==="VIDEO"?"video":"image",n=t==="image"?ve(e):e.src;return{type:t,src:n}}function Se(e){const t=e.parentElement;if(!t)return null;const n=t.parentElement;return n||null}function Q(e){const t=Se(e);if(!t)return null;const n=e.children[1],o=parseFloat(getComputedStyle(n).getPropertyValue("width")),r=t.getBoundingClientRect().x;for(let i=1;i<e.children.length;i++){const a=e.children[i].getBoundingClientRect().x;if(Math.abs(r-a)<o/2)return i-1}return-1}function Ee(e){const t=e.querySelector("ul");if(t===null)return null;const n=Q(t);return n===null?null:{list:t,index:n}}function xe(e){const t=Ee(e);if(!t)return console.warn("could not find the current index of carousel"),null;const{index:n,list:o}=t,r=o.children[n+1],i=S(r);return i?W(i):(console.warn("could not find any media element in carousel at index "+n,r),null)}function be(e,t){let n=t;for(let o=0;o<1e3;o++){if(n.matches("li"))return!0;if(n===e)return!1;const r=n.parentElement;if(!r)return!1;n=r}return!1}function V(e){const t=S(e);return t?be(e,t)?"collection":t.tagName==="VIDEO"?"video":"image":(console.warn("no media-element found"),console.log(e.innerHTML),null)}function Pe(e){const t=e.querySelector("header a").href,n=/(?<=\.com\/).*(?=\/)/.exec(t);return n?n[0]:null}function Ae(e){const t=S(e);return t?W(t):(console.log("could not find any media element in post",e),null)}function De(e){const t=Pe(e);if(!t)return console.warn("could not username from post"),null;const n=V(e);if(!n)return console.warn("could not find type of post"),null;const o=n==="collection"?xe(e):Ae(e);return o?{username:t,...o}:(console.warn("could not find media-src of post"),null)}function z(e){const t=e.querySelectorAll('a[href*="/p/"');if(t.length===0)return null;const n=t[t.length-1].href,o=n.indexOf("/p/");if(o<0)return null;const r=o+3,i=n.indexOf("/",r);return i<0?null:n.substring(0,i+1)}function X(e){return parseInt(e.getAttribute("bandwidth"))}function Ie(e){return e.hasAttribute("bandwidth")}const Ce=P.contramap(X)(U.Ord),_e=oe.max(Ce);function Me(e){const t=e.querySelector("BaseURL");if(!t)return c.left({failure:"element does not have a child of type BaseURL from which the url could be extracted.",context:e});const n=t.textContent;return n===null?c.left({failure:"found a BaseURL-node but its textContent is null",context:{element:e,baseUrlNode:t}}):c.right(n)}function Be(e){const t=e.getAttribute("width");if(t===null)return c.left({failure:'element has no "width" attribute',context:e});const n=e.getAttribute("height");return n===null?c.left({failure:'element has no "height" attribute',context:e}):c.right({width:parseInt(t),height:parseInt(n)})}function N(e){const t=[];if(e.children.length===0)return c.left({failure:"AdaptationSet has zero child nodes",context:e});const n=Array.from(e.children),o=n.filter(Ie);if(o.length===0)return c.left({failure:"none of the childnodes has a bandwidth attribute",context:e});o.length!==n.length&&t.push({failure:"some children of this AdaptationSet have no bandwidth attribute",context:e});const r=C.pipe(o,_e),i=Me(r);if(c.isLeft(i))return i;const s=X(r);return c.right({success:{element:r,mediaData:{url:i.right,bandwidth:s}},warnings:t})}function Te(e){const t=[],n=e.children[0];if(n===null)return c.left({failure:"XMLDocument doc does not have a MPD-node",context:e});const o=Array.from(n.querySelectorAll("Period"));if(o.length===0)return c.left({failure:"could not find any nodes with the 'Period' tag in MPD",context:{doc:e,mpd:n}});o.length>1&&t.push({failure:"found more than 1 Period Element",context:{doc:e,MPD:n,periodNodes:o}});const r=o[0],i=Array.from(r.querySelectorAll("AdaptationSet"));if(i.length===0)return c.left({failure:"found no AdaptationSets in Period Element",context:r});i.length>2&&t.push({failure:"expected 2 AdaptationSets, 1 for video and 1 for audio, but got more than 2",context:{doc:e,period:r,adaptationSets:i}});const s=i.findIndex(E=>{const g=E.getAttribute("contentType");return g?g==="video":!1});if(s<0)return c.left({failure:"could not find any AdaptationSets that contain videos, or maybe checking that the attribute 'contentType' is equal to 'video' does not work anymore",context:{doc:e,period:r,adaptationSets:i}});const a=i[s],d=N(a);if(c.isLeft(d))return c.left({failure:"error while trying to extract video data",context:{videoSet:a,subFailure:d.left}});const f=d.right,l=Be(f.success.element);if(c.isLeft(l))return c.left({failure:"could not extract width or height from video",context:{doc:e,subContext:l.left}});const h=l.right,m=f.success.mediaData;let q=u.none;if(i.length>1){const E=i[s===0?1:0],g=N(E);if(c.isRight(g)){const ne=g.right;q=u.some(ne.success.mediaData)}}return c.right({data:{video:{...m,...h},audio:q},warnings:t})}function qe(e){const t=new DOMParser;return c.tryCatch(()=>t.parseFromString(e,"text/xml"),n=>n instanceof Error?n:new Error("unknown error"))}function ke(e){console.log(e);const t=qe(e);return c.isLeft(t)?t:Te(t.right)}const Ne=e=>e.width*e.height,Oe=P.contramap(Ne)(P.reverse(U.Ord));function D(e){return re.sort(Oe)(e)[0].url}function Le(e){return"video_versions"in e?e.video_versions:e.image_versions2.candidates}C.flow(Le,D);function Fe(e){if(!("video_dash_manifest"in e))return u.none;const t=ke(e.video_dash_manifest);if(c.isLeft(t))return console.error(t.left),u.none;const n=t.right;return n.warnings.length>0&&console.warn(n.warnings),u.some({type:"video",src:n.data.video.url,previewSrc:e.image_versions2.candidates[0].url})}function I(e){if("video_versions"in e){const n=Fe(e);return u.isSome(n)?n.value:{type:"video",src:D(e.video_versions),previewSrc:e.image_versions2.candidates[0].url}}const t=D(e.image_versions2.candidates);return{type:"image",src:t,previewSrc:t}}function Re(e){return e.carousel_media.map(I)}function Ue(e){if(!e.items)throw console.log(e),"items not found in dataObject (see above log)";const t=e.items;if(t.length===0)throw"items are empty";const n=t[0],o=n.user.username;let r=[],i="video";if("video_versions"in n&&(i="video",r.push(I(n))),"image_versions2"in n&&(i="image",r.push(I(n))),"carousel_media"in n&&(i="collection",r=Re(n)),r.length===0)throw"no media found";return{postType:i,mediaArray:r,username:o}}function $e(e){const t=e.querySelector("ul");if(!t)return null;const n=Q(t);return n===null?null:t.children[n+1]}function G(e){return e?e[0]:null}function He(e,t){const n=t.poster;if(n==="")return console.warn("cannot find the position for this collection-element!"),null;const o=G(/^https:\/\/.*\.jpg/.exec(n));if(!o)return null;const r=e.findIndex(i=>i.previewSrc.includes(o));return r<0?(console.warn("poster does not match any previews, therefore cannot find the index for this item"),console.log(n,o,e),null):e[r]}function je(e){let t="";const n=e.srcset;return n?t=M(n):t=e.src,{type:"image",src:t,previewSrc:""}}function We(e,t){const n=$e(t);if(!n)return console.warn("couldn't find carousel element"),null;const o=S(n);return o?o.matches("video")?He(e,o):o.matches("img")?je(o):(console.warn("mediaElement does not match video or img"),null):(console.warn("couldn't find image or video"),null)}const Qe=e=>t=>{let n=null,o=null;return async()=>{if(o||(o=V(t),console.log("currnet post type",o)),!n){const a=z(t);if(!a)return;n=await e(a)}console.log("fetched!",o);const r=n.username,i=n.mediaArray,s=o==="collection"?We(i,t):i[0];if(!s){console.error("could not find media of the current collection item!");return}return{username:r,...s}}};function Ve(){const e=document.querySelector("meta[content*='instagram://media?id=']");if(!e)return c.left("could not find media-id on this page. are you sure this is a page with a single post?");const n=e.getAttribute("content").replace("instagram://media?id=","");return c.right(n)}function ze(e){return`https://i.instagram.com/api/v1/media/${e}/info/`}async function Xe(){const e=Ve();if(c.isLeft(e))return e;const t=e.right,o=await(await fetch(ze(t),{credentials:"include",headers:{"X-IG-App-ID":"936619743392459","X-IG-WWW-Claim":"hmac.AR2QBIaghoDoJL618hB9QmcT_5fX13SscXD38AD - RuRv9kiJ"}})).json();return c.right(o)}function J(e){return e.map(t=>`\\${t}`).join("|")}function Ge(e){const t=J(e);return new RegExp(`[^/]*(${t})`)}function Je(e,t){return new RegExp(J(e)).exec(t)!==null}const Ke=(e,t)=>n=>{const o=e.exec(n);if(o!==null){const r=o[0];return c.right(r)}return Je(t,n)?c.left(`could not extract a filename from the url '${n}' although it appears to contain a valid file-extension.`):c.left(`the url '${n}' does not contain any of the expected file-extensions: ${t.join(", ")}`)},Ye=e=>Ke(Ge(e),e),Ze=Ye([".mp4",".jpg",".webp",".webm"]);function et(){const e=/(?<="username":")[^"]*/.exec(document.body.innerHTML);return e?e[0]:null}const tt=(e,t)=>new Promise((n,o)=>{const r=chrome.runtime.connect({name:"chrome-downloader"});let i=null;const s=()=>{r.postMessage({type:"request-state",id:i})};r.onMessage.addListener(a=>{if(a.type==="download-id"){i=a.id,s();return}if(a.type==="error"){o(a.error),r.disconnect();return}if(a.type==="success"){n(),r.disconnect();return}if(a.type==="progress"){t(a.progress.progress),s();return}}),r.postMessage({type:"request-download",filePath:e.filePath,url:e.url})}),nt=(e,t)=>{const n={requests:[{action:"write media by link",data:e}],time:window.performance.now()};let o=null,r=null;const i=new Promise((a,d)=>{o=a,r=d}),s=chrome.runtime.connect({name:"disk-downloader"});return s.onMessage.addListener((a,d)=>{if(a.origin==="native host disconnect"){r(a.data);return}else if(a.origin==="native host response"){const l=a.data[0],h=l.type;if(h==="success"){o();return}else if(h==="error"){r(l.data);return}else h==="progress"&&t(l.data.progress)}a.data[0].type==="success"&&s.disconnect()}),s.postMessage(n),i},ot=(e,t,n)=>{const o=n.directoryRules||[];o.reverse();const r=n.baseDownloadDirectory||"",i=[...o,{baseDirectory:r}];for(let s of i){const a=s.username||[],d=s.downloadAs||[],f=s.baseDirectory||"",l=s.folderPath||"";if(!((a.length===0||a.includes(e))&&(d.length===0||d.includes(t))))continue;let m=null;if(f!==""&&(m=`${f}/${e}`),l!==""&&(m=l),m!==null)return m}},rt=async e=>new Promise((t,n)=>{chrome.storage.sync.get({baseDownloadDirectory:"",directoryRules:[]},o=>{const r=ot(e.userName,e.ownUserName,o);r?t(r):n("no path found. have you set a path in the extension-options?")})});function v(e){return chrome.runtime.getURL(`assets/icons/${e}.png`)}const O={initial:"save",loading:"spinner-of-dots",success:"verify-sign-green",fail:"error"};class it{constructor(){this._downloadState="initial",this._loadingProgress=0,this._spinnerCtx=null,this._spinnerCanvas=null,this._buttonImg=null,this._rootElement=null,this._rootElement=document.createElement("a"),this._rootElement.classList.add("download-button"),Object.assign(this._rootElement.style,{width:"fit-content",height:"fit-content",cursor:"pointer"}),this._buttonImg=document.createElement("img"),Object.assign(this._buttonImg.style,{width:"inherit",height:"inherit"}),this._rootElement.appendChild(this._buttonImg),this._setInitialState()}get downloadState(){return this._downloadState}set downloadState(t){this._downloadState=t,this._onDownloadStateChanged()}get loadingProgress(){return this._loadingProgress}set loadingProgress(t){this._loadingProgress=t,this._downloadState==="loading"&&this._drawSpinner()}getElement(){return this._rootElement}_setInitialState(){let n=A()[0]=="post"?"dark":"white";const o=`${O.initial}-${n}`;this._buttonImg.src=v(o)}_onDownloadStateChanged(){const t=this._downloadState;if(t==="loading")this._spinnerCanvas||(this._spinnerCanvas=document.createElement("canvas"),this._spinnerCtx=this._spinnerCanvas.getContext("2d"),this._drawSpinner());else{this._spinnerCanvas=null,this._spinnerCtx=null;let n=O[t];t==="initial"&&(n+=`-${A()[0]=="post"?"dark":"white"}`),this._buttonImg.src=v(n)}}_drawSpinner(){const t=this._spinnerCtx,n=this._loadingProgress,o=32;Object.assign(this._spinnerCanvas,{width:o,height:o}),t.clearRect(0,0,o,o),t.lineWidth=4;const r=(o-t.lineWidth)/2;t.strokeStyle="cyan",t.lineCap="round",t.beginPath();const i=o/2,s=-Math.PI/2;t.arc(i,i,r,s,s+n*2*Math.PI),t.stroke(),this._buttonImg.src=this._spinnerCanvas.toDataURL()}}const st="chrome-background",at=()=>new Promise((e,t)=>{chrome.storage.sync.get({downloadMethod:st},n=>{if(chrome.runtime.lastError){t(chrome.runtime.lastError.message);return}e(n.downloadMethod)})}),ct=async(e,t)=>{const n=await at(),o=e.src,r=Ze(o);if(c.isLeft(r))throw r.left;const i=r.right;if(n==="native"){const s=et(),a=await rt({mediaSrc:o,userName:e.username,ownUserName:s});await nt({link:o,folderPath:a,fileName:i},t)}else n==="chrome-background"&&await tt({filePath:`Instagram/${e.username}/${i}`,url:o},t)},lt=async(e,t)=>{let n=null;try{n=await e(),await ct(n,t)}catch(o){console.error(o);const r=n?`${o}, 
 user: ${n.username}, 
 src: ${n.src}`:o;throw chrome.runtime.sendMessage({type:"show-notification",notification:{title:"download failed",message:r,iconUrl:v("insta-loader-icon-48")}}),o}},K=(e,t={})=>{t={onDownloadStart:()=>{},onDownloadEnd:()=>{},...t};const n=new it,o=n.getElement(),r=async()=>{n.downloadState="loading";const i=s=>n.loadingProgress=s;t.onDownloadStart();try{await lt(e,i),n.downloadState="success"}catch{n.downloadState="fail"}t.onDownloadEnd()};return o.addEventListener("download-request",r),o.addEventListener("mousedown",r),o};function ut(e){return _(`
		<div 
			style="
				display: flex; 
				flex-direction: row;
				padding: 8px;
				padding-right: 0px;
				margin-left: 10px;
			"
		>
			<a 
				href="${e}"
				style="width: fit-content; height: fit-content; cursor: pointer;"
			>
				<img 
					style="width: inherit; height: inherit;"
					src="${v("external-link-white")}"
				/>
			</a>
		</div>
	`)}function dt(e){const t=e.querySelector("section");if(!t)return console.warn("trying to find bar with like-button, save-button, etc. in order to inject the download-button, but cannot find it!"),null;const n=Array.from(t.querySelectorAll("svg"));return n.length===0?null:n[n.length-1]}const ft=e=>{const t=dt(e);if(!t)return null;const n=t.parentElement;if(!n)return null;const o=t.clientHeight+"px",r=getComputedStyle(n).getPropertyValue("padding");return{width:o,height:o,padding:r}},L=(e,t)=>{Object.assign(t.style,ft(e))},ht=e=>{const t=De(e);return t?Promise.resolve(t):Promise.reject("media-src not found")};async function mt(){const e=await Xe();if(c.isLeft(e))throw e.left;return Ue(e.right)}function gt(e){const t=p();return console.log("pagetype",t),t==="post"?Qe(mt)(e):()=>ht(e)}function pt(e){const t=e.querySelector("section");if(!t){console.warn("trying to inject download buttons into post, but cannot find any child with tag 'Section'");return}const n=_(`
		<div 
			style="
				display: flex; 
				flex-direction: row;
				padding: 8px;
				padding-right: 0px;
				margin-left: 10px;
			"
		></div>
	`),o=gt(e),r=K(o);if(L(e,r),n.appendChild(r),t.insertAdjacentElement("beforeend",n),p()==="mainFeed"){const i=ut(z(e));L(e,i.firstElementChild),t.appendChild(i)}}function yt(e){const t=e.querySelector("video");if(t===null)return;const n=Array.from(t.querySelectorAll("source")),o=["42","4D","64"],r=s=>o.findIndex(a=>s.type.includes(a)),i=(s,a)=>r(s)-r(a);return n.sort(i),n[n.length-1].src}function wt(e){const t=yt(e);if(t)return t;const n=e.querySelector("img[srcset]");return n!==null?M(n.srcset):null}function vt(){const e=document.querySelector('meta[property="og:url"]');if(!e)return null;const n=e.content.match(/(?<=\.com\/).*(?=\/)/);return n?n[0]:null}function St(){const e=window.location.href;return e.startsWith("https://www.instagram.com/stories/highlights/")?vt():Et(e)}function Et(e){return G(/(?<=stories\/).*?(?=\/)/.exec(e))}function xt(){return document.querySelector("article")?.parentElement}function B(){const e=xt();return e?Array.from(e.children):[]}function bt(e){const t=e.getBoundingClientRect(),n=(t.top+t.bottom)/2;return Math.abs(n-window.innerHeight/2)}function Y(){const e=B();return e.length===0?null:e.reduce((n,o)=>{const r=bt(o);return r<n[0]?[r,o]:n},[1/0,null])[1]}const Z="Enter";function ee(e){e.dispatchEvent(new CustomEvent("download-request"))}function Pt(e){return e.querySelector(".download-button")}function At(){const e=Y();if(!e){console.warn("download by shortcut: could not find the currently visible post to download");return}const t=Pt(e);if(t===null){console.warn("download by shortcut: found the currently visible post, but there seems to be no download button. are you sure it's there?");return}ee(t)}document.addEventListener("keydown",e=>{e.key===Z&&At()});const Dt=e=>{try{const t=wt(e),n=St();return Promise.resolve({src:t,username:n})}catch(t){return Promise.reject(t)}},It=()=>{let e=!1;const t=document.querySelector("video");return{keepPaused:()=>{e=!0;const r=()=>{t.paused||t.pause(),e&&window.requestAnimationFrame(r)};r()},continue:()=>{e=!1}}};function Ct(){return document.querySelector("header svg")}function _t(){const e=Ct();if(!e){console.warn("could not add download-button in story. the svg for the pause/play button could not be found");return}const t=ge("button",e);if(!t){console.warn("could not add download-button in story. the svg for the pause/play button has not button as an ancestor");return}return t}const Mt=e=>{const t=_(`
		<div style="margin-right: 20px;"></div>
	`),n=(()=>{let s=null;return{onDownloadStart:()=>{document.querySelector("video")&&(s=It(),s.keepPaused())},onDownloadEnd:()=>{!s||s.continue()}}})(),o=K(()=>Dt(e),n);t.appendChild(o),_t().parentElement.insertAdjacentElement("afterbegin",t),document.addEventListener("keypress",s=>{s.key===Z&&ee(o)})};y.addEventListener("onPostAdded",e=>{pt(e.detail.element)});y.addEventListener("onStoryAdded",e=>{Mt(e.detail.element)});y.start();const te=30;function T(e){const t=e.querySelector("section");if(t===null)return console.warn("trying to calculate distance to bottom, cannot find a 'section' element in post"),u.none;const n=t.getBoundingClientRect().bottom,o=window.innerHeight;return u.some(o-n)}function Bt(e){const t=T(e);return u.isNone(t)?!1:t.value<-te}function Tt(e){const t=T(e);return u.isNone(t)?!1:t.value>te}function qt(){return B().find(Bt)}function kt(){return B().reverse().find(Tt)}function F(e){const t=e();if(!t){console.warn("could not find post to scroll to");return}const n=-T(t),o=window.scrollY+n;window.scrollTo({left:window.scrollX,top:o,behavior:"smooth"})}function Nt(){const e={"scroll-up":"w","scroll-down":"s"};document.addEventListener("keydown",t=>{t.key===e["scroll-up"]?F(kt):t.key===e["scroll-down"]&&F(qt)})}Nt();const R={a:"left",d:"right"},Ot={left:"LeftChevron",right:"RightChevron"};function b(){console.warn("you've tried to navigate to the next or previous image/video but we couldn't find the button to click on")}function Lt(e){const n=p()==="stories"?document.body:Y();if(!n){b();return}const o=Ot[e],r=n.querySelector(`[class*="${o}"]`);if(!r){b();return}const i=r.parentElement;if(!i){b();return}i.click()}document.addEventListener("keydown",e=>{const{key:t}=e;t in R&&Lt(R[t])});console.log("### insta loader initialized ###");
